{% extends "shared/form_base.html" %}
{% import "macros/buttons.html" as buttons %}
{% import "macros/dialogs.html" as dialogs %}
{% import "macros/image_upload.html" as image_upload %}

{% block title %}{{ _('Edit') if project else _('New') }} {{ _('Project') }} - Stricknani{% endblock %}

{# Set variables for the unified navbar #}
{% set page_title %}{{ project.name if project else _('New Project') }}{% endset %}
{% set page_title_mobile_hidden = true %}
{% set back_url = '/projects/' + project.id|string if project else '/projects' %}
{% set back_label = _('Back to projects') %}
{% set page_actions %}
<div class="flex items-center gap-1">
    <button type="submit" form="projectForm" class="btn btn-primary gap-2 h-10 min-h-0 px-3 md:px-4">
        <span class="mdi mdi-content-save text-xl"></span>
        <span>{{ _('Save') }}</span>
    </button>
    {% if not project %}
    <div class="dropdown dropdown-end dropdown-bottom">
        <button type="button" class="btn btn-square btn-ghost btn-sm md:btn-md" aria-label="{{ _('More options') }}">
            <span class="mdi mdi-dots-vertical text-xl"></span>
        </button>
        <ul tabindex="0"
            class="dropdown-content ellipsis-dropdown-content z-[100] menu p-2 shadow-lg bg-base-100 rounded-box border border-base-200">
            <li>
                <button type="button" data-action="open-dialog" data-dialog-id="importDialog">
                    <span class="mdi mdi-download"></span>
                    {{ _('Import') }}
                </button>
            </li>
        </ul>
    </div>
    {% endif %}
</div>
{% endset %}

{% block form_styles %}
{% endblock %}

{% block form_before %}
<dialog id="previewDialog"
    class="p-0 rounded-lg shadow-xl backdrop:bg-black/50 dark:bg-slate-900 dark:text-slate-100 w-full max-w-2xl">
    <div class="flex items-center justify-between p-4 border-b border-slate-200 dark:border-slate-700">
        <h3 class="text-lg font-semibold">{{ _('Preview') }}</h3>
        <button data-action="close-dialog" data-dialog-id="previewDialog"
            class="text-slate-500 hover:text-slate-700 dark:text-slate-400 dark:hover:text-slate-200">
            <span class="mdi mdi-close text-xl"></span>
        </button>
    </div>
    <div id="previewContent" class="p-6 prose max-w-none dark:prose-invert overflow-y-auto max-h-[70vh]"></div>
</dialog>

{% include "projects/_import_dialog.html" %}
{% endblock %}

{% block form_nav %}
{{ buttons.back_circle('/projects/' + project.id|string if project else '/projects', label=_('Back to projects'),
attrs='data-unsaved-confirm="true"') }}
{% endblock %}

{% block form_header_class %}
md:sticky md:top-0 md:z-50 bg-base-100 py-4 px-4 -mx-4 shadow-none
{% endblock %}

{% block form_actions %}
{% if not project %}
{{ buttons.secondary(_('Import'), icon='mdi-download',
attrs='data-action="open-dialog" data-dialog-id="importDialog"', class='flex-1 sm:flex-none') }}
{% endif %}

{# Save button logic:
- Always hidden on mobile (moved to FAB)
- Visible on desktop #}
{% set save_classes = 'hidden md:inline-flex flex-1 sm:flex-none md:btn-wide' %}

{{ buttons.primary(_('Save'), icon='mdi-content-save', type='submit', attrs='form="projectForm"', class=save_classes) }}

<!-- Mobile FAB for Project Save -->
{{ buttons.fab('mdi-content-save', type='submit', attrs='form="projectForm"', class='md:hidden', label=_('Save')) }}
{% endblock %}

{% block form_title %}
{{ project.name if project else _('New Project') }}
{% endblock %}

{% block form_body %}
<form id="projectForm" action="{{ '/projects/' + project.id|string if project else '/projects/' }}" method="post"
    data-primary-form="true" class="space-y-6">
    <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
    <input type="hidden" id="import_image_urls" name="import_image_urls" value="">
    <input type="hidden" id="import_title_image_url" name="import_title_image_url" value="">
    <input type="hidden" id="import_attachment_tokens" name="import_attachment_tokens" value="">
    <input type="hidden" id="archive_on_save" name="archive_on_save" value="">
    <input type="hidden" id="is_ai_enhanced" name="is_ai_enhanced"
        value="{{ '1' if project and project.is_ai_enhanced else '' }}">
    <input type="hidden" id="yarn_brand" name="yarn_brand" value="">
    <input type="hidden" id="yarn_details" name="yarn_details" value="">
    <input type="hidden" id="stepsData" name="steps_data">


    <div id="importWarning"
        class="hidden mb-6 bg-yellow-50 dark:bg-yellow-900/20 border-l-4 border-yellow-400 dark:border-yellow-600 p-4 rounded">
        <div class="flex items-start gap-3">
            <span class="mdi mdi-alert text-yellow-600 dark:text-yellow-500 text-xl mt-0.5"></span>
            <div class="flex-1">
                <h3 class="font-semibold text-yellow-800 dark:text-yellow-400 mb-1">{{ _('Imported Data - Not Saved Yet') }}</h3>
                <p class="text-sm text-yellow-700 dark:text-yellow-300">
                    {{ _('This project was imported from an external source. Please review all fields carefully and click "Save" to keep it.') }}
                </p>
            </div>
        </div>
    </div>

    <div class="relative grid grid-cols-1 lg:grid-cols-3 gap-6 lg:gap-8">
        <!-- Main Content Column -->
        <div id="main-column" class="lg:col-span-2 space-y-6">
            <!-- Basic Info Card -->
            <div
                class="collapse collapse-arrow bg-base-100 rounded-none sm:rounded-2xl shadow-sm border-y sm:border border-base-200 overflow-visible">
                <input type="checkbox" checked />
                <div class="collapse-title p-3 sm:p-6 pb-0">
                    <h3
                        class="text-sm font-bold uppercase tracking-widest text-base-content/40 flex items-center gap-2">
                        <span class="mdi mdi-information-outline"></span>
                        {{ _('Basic Information') }}
                    </h3>
                </div>
                <div class="collapse-content p-3 sm:p-6 pt-0">
                    <div class="space-y-4 sm:space-y-6 pt-4">
                        <div>
                            <label for="name" class=" text-sm font-medium mb-1 inline-flex items-center gap-2">
                                <span class="mdi mdi-notebook-outline text-base-content/70"></span>
                                {{ _('Project Name') }} <span class="text-red-500 dark:text-red-400">*</span>
                            </label>
                            <input type="text" id="name" name="name" required
                                value="{{ project.name if project and project.name else '' }}"
                                class="input input-bordered w-full" placeholder="{{ _('e.g. My Amazing Project') }}">
                        </div>

                        <div>
                            <div class="flex items-center justify-between mb-1">
                                <label for="description" class=" text-sm font-medium inline-flex items-center gap-2">
                                    <span class="mdi mdi-text-box-outline text-base-content/70"></span>
                                    {{ _('Description') }} <span class="text-base-content/60 text-xs">{{ _('Optional')
                                        }}</span>
                                </label>
                            </div>
                            <textarea id="description" name="description" rows="4"
                                class="textarea textarea-bordered w-full"
                                placeholder="{{ _('Brief description of this project...') }}"
                                data-markdown-images="true">{{ project.description if project and project.description else '' }}</textarea>
                            <p class="text-xs text-base-content/70 mt-1">{{ _('Supports Markdown formatting') }}</p>
                        </div>

                        <div>
                            <div class="flex items-center justify-between mb-1">
                                <label for="notes" class=" text-sm font-medium inline-flex items-center gap-2">
                                    <span class="mdi mdi-notebook-outline text-base-content/70"></span>
                                    {{ _('Notes') }} <span class="text-base-content/60 text-xs">{{ _('Optional')
                                        }}</span>
                                </label>
                            </div>
                            <textarea id="notes" name="notes" rows="4" class="textarea textarea-bordered w-full"
                                placeholder="{{ _('Personal notes about this project...') }}"
                                data-markdown-images="true">{{ project.notes if project and project.notes else '' }}</textarea>
                            <p class="text-xs text-base-content/70 mt-1">{{ _('Supports Markdown formatting') }}</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Gallery Card -->
            <div
                class="collapse collapse-arrow bg-base-100 rounded-none sm:rounded-2xl shadow-sm border-y sm:border border-base-200 overflow-visible">
                <input type="checkbox" checked />
                <div class="collapse-title p-3 sm:p-6 pb-0">
                    <h3
                        class="text-sm font-bold uppercase tracking-widest text-base-content/40 flex items-center gap-2">
                        <span class="mdi mdi-image-multiple"></span>
                        {{ _('Gallery') }}
                    </h3>
                </div>
                <div class="collapse-content p-3 sm:p-6 pt-0">
                    <div class="pt-4">
                        <div id="titleImagesContainer" class="grid grid-cols-2 md:grid-cols-3 gap-4 mb-4 pswp-gallery"
                            data-pswp-gallery>
                            {% if project %}
                            {% for image in project.title_images %}
                            {{ image_upload.image_preview(image, project_id=project.id, show_promote=true,
                            show_crop=true) }}
                            {% endfor %}
                            {% endif %}
                        </div>

                        <div id="titleImageUploadContainer">
                            {{ image_upload.upload_dropzone(
                            input_id='titleImageInput',
                            container_id='titleImageDropZone'
                            ) }}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Attachments Card -->
            <div
                class="collapse collapse-arrow bg-base-100 rounded-none sm:rounded-2xl shadow-sm border-y sm:border border-base-200 overflow-visible">
                <input type="checkbox" checked />
                <div class="collapse-title p-3 sm:p-6 pb-0">
                    <h3
                        class="text-sm font-bold uppercase tracking-widest text-base-content/40 flex items-center gap-2">
                        <span class="mdi mdi-paperclip"></span>
                        {{ _('Attachments') }}
                    </h3>
                </div>
                <div class="collapse-content p-3 sm:p-6 pt-0">
                    <div class="pt-4">
                        <div id="attachmentsContainer" class="space-y-2 mb-4 pswp-gallery" data-pswp-gallery>
                            {% if project and project.attachments %}
                            {% set ns = namespace(image_index=0) %}
                            {% for attachment in project.attachments %}
                            {% set is_image_attachment = attachment.content_type.startswith('image/') %}
                            {% if is_image_attachment %}
                            {% set open_index = ns.image_index %}
                            {% set ns.image_index = ns.image_index + 1 %}
                            {% endif %}
                            <div class="flex items-center justify-between p-3 rounded-xl border border-base-200 bg-base-200/30 group cursor-pointer"
                                role="button" tabindex="0" data-action="open-attachment"
                                data-attachment-kind="{% if attachment.content_type == 'application/pdf' %}pdf{% elif attachment.content_type.startswith('image/') %}image{% else %}other{% endif %}"
                                data-attachment-url="{{ attachment.url }}"
                                data-attachment-name="{{ attachment.original_filename }}"
                                data-attachment-id="{{ attachment.id }}"
                                data-attachment-size="{{ attachment.size_bytes }}" {% if is_image_attachment
                                %}data-pswp-open-index="{{ open_index }}" {% endif %}>
                                <div class="flex items-center gap-3 min-w-0">
                                    <div
                                        class="w-10 h-10 rounded-lg bg-primary/10 flex items-center justify-center text-primary shrink-0 overflow-hidden">
                                        {% if attachment.thumbnail_url %}
                                        <img src="{{ attachment.thumbnail_url }}" alt=""
                                            class="w-full h-full object-cover" loading="lazy">
                                        {% else %}
                                        {% if attachment.content_type == 'application/pdf' %}
                                        <span class="mdi mdi-file-pdf-outline text-2xl"></span>
                                        {% elif attachment.content_type.startswith('image/') %}
                                        <span class="mdi mdi-file-image-outline text-2xl"></span>
                                        {% else %}
                                        <span class="mdi mdi-file-outline text-2xl"></span>
                                        {% endif %}
                                        {% endif %}
                                    </div>
                                    <div class="min-w-0">
                                        <p class="font-medium text-sm truncate"
                                            title="{{ attachment.original_filename }}">
                                            {{ attachment.original_filename }}
                                        </p>
                                        <p class="text-[10px] text-base-content/50 uppercase font-bold tracking-wider">
                                            {{ (attachment.size_bytes / 1024 / 1024)|round(2) }} MB
                                        </p>
                                    </div>
                                </div>
                                <div class="flex items-center gap-1">
                                    <a href="{{ attachment.url }}" target="_blank"
                                        class="btn btn-ghost btn-sm btn-circle text-primary"
                                        title="{{ _('Download') }}">
                                        <span class="mdi mdi-download text-xl"></span>
                                    </a>
                                    <button type="button" data-call="deleteAttachment"
                                        data-call-args='[{{ attachment.id }}]'
                                        class="btn btn-ghost btn-sm btn-circle text-error" title="{{ _('Delete') }}">
                                        <span class="mdi mdi-delete-outline text-xl"></span>
                                    </button>
                                </div>
                                {% if is_image_attachment %}
                                <a href="{{ attachment.url }}" class="hidden" aria-hidden="true" tabindex="-1"
                                    data-pswp-width="{{ attachment.width or 1200 }}"
                                    data-pswp-height="{{ attachment.height or 1200 }}"
                                    data-pswp-caption="{{ attachment.original_filename }}"></a>
                                {% endif %}
                            </div>
                            {% endfor %}
                            {% endif %}
                        </div>

                        {{ image_upload.upload_dropzone(
                        input_id='attachmentInput',
                        container_id='attachmentDropZone',
                        label_text=_('Click or drag files here to attach (PDF, etc.)'),
                        icon='mdi-paperclip',
                        accept='*/*'
                        ) }}
                    </div>
                </div>
            </div>

            <!-- Mobile Details Card -->
            <div class="lg:hidden p-4 bg-base-200/30 rounded-xl border border-base-200 space-y-4">
                <h3 class="font-bold text-xs uppercase tracking-widest text-base-content/40 flex items-center gap-2">
                    <span class="mdi mdi-information-outline"></span>
                    {{ _('Project Details') }}
                </h3>

                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <div class="flex items-center justify-between">
                            <label for="category-mobile" class=" text-xs font-bold uppercase text-base-content/50">
                                {{ _('Category') }}
                            </label>
                            <a href="/projects/categories" class="text-[10px] text-primary hover:underline"
                                target="_blank" rel="noreferrer">
                                {{ _('Manage') }}
                            </a>
                        </div>
                        <select name="category" class="select  select-sm w-full mt-1">
                            <option value="">{{ _('Select a category') }}</option>
                            {% for category in categories %}
                            <option value="{{ category }}" {% if project and project.category==category %}selected{%
                                endif %}>
                                {{ category }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="sm:col-span-2">
                        <label for="tags_input_mobile" class=" text-xs font-bold uppercase text-base-content/50">
                            {{ _('Tags') }}
                        </label>
                        <input type="hidden" id="tags" name="tags"
                            value="{{ project.tags | join(', ') if project and project.tags else '' }}">
                        <div id="tags_chips_mobile" class="flex flex-wrap gap-2 mt-2"></div>
                        <div class="relative mt-2">
                            <input type="text" id="tags_input_mobile" class="input  input-sm w-full" autocomplete="off"
                                placeholder="{{ _('Add a tag...') }}">
                            <div id="tags_suggestions_mobile"
                                class="hidden absolute z-30 w-full mt-1 max-h-48 overflow-y-auto bg-base-100 border border-base-300 rounded-lg shadow-xl">
                                {% for tag in tag_suggestions %}
                                <button type="button"
                                    class="tag-suggestion w-full text-left px-3 py-2 hover:bg-base-200 text-sm"
                                    data-tag="{{ tag }}">
                                    #{{ tag }}
                                </button>
                                {% endfor %}
                            </div>
                        </div>
                        <p class="text-[10px] text-base-content/60 mt-1">{{ _('Press Enter or choose a suggestion.') }}
                        </p>
                    </div>

                    <div class="sm:col-span-2">
                        <div class="flex items-center justify-between mb-1">
                            <label class=" text-xs font-bold uppercase text-base-content/50">{{
                                _('Pattern Source') }}</label>
                            <button type="button" id="reimport-btn-mobile"
                                class="btn btn-ghost btn-xs gap-1 normal-case {{ 'hidden' if not project.link else '' }}"
                                data-call="importFromUrl" data-call-args='["$value:#link"]'>
                                <span class="mdi mdi-download"></span>
                                {{ _('Re-import') }}
                            </button>
                            <a href="{{ project.link }}" target="_blank"
                                class="btn btn-ghost btn-xs gap-1 normal-case {{ 'hidden' if not project.link else '' }}"
                                id="visit-link-btn-mobile" title="{{ _('Visit Website') }}">
                                <span class="mdi mdi-open-in-new"></span>
                                {{ _('Visit') }}
                            </a>
                            <button type="button" class="btn btn-ghost btn-xs gap-1 normal-case"
                                data-call="copyToClipboard" data-call-args='["$value:#link","$this"]'
                                title="{{ _('Copy URL') }}">
                                <span class="mdi mdi-content-copy"></span>
                            </button>
                        </div>
                        <input type="url" name="link" value="{{ project.link or '' }}" class="input  input-sm w-full"
                            placeholder="https://..." data-call-input="syncLinkInputs">
                        <label id="wayback_mobile_container"
                            class="label cursor-pointer justify-start gap-3 px-3 py-2 bg-base-200/50 rounded-xl border border-base-300 mt-2 {% if not feature_wayback_enabled %}hidden{% endif %}">
                            <input type="checkbox" id="archive_on_save_mobile" name="archive_on_save" value="1"
                                class="checkbox checkbox-primary checkbox-sm" checked>
                            <span class="label-text text-xs font-bold uppercase text-base-content/50">{{ _('Archive on Wayback Machine') }}</span>
                        </label>
                    </div>

                    <div class="sm:col-span-2 pt-2 border-t border-base-200">
                        <label id="ai_enhanced_mobile_container"
                            class="label cursor-pointer justify-start gap-3 px-3 py-2 bg-base-200/50 rounded-xl border border-base-300">
                            <input type="checkbox" id="is_ai_enhanced_mobile_checkbox"
                                class="checkbox checkbox-primary checkbox-sm" {% if project and project.is_ai_enhanced
                                %}checked{% endif %} data-call-change="syncAiEnhanced">
                            <span
                                class="label-text text-xs font-bold uppercase text-base-content/50 flex items-center gap-2">
                                <span class="badge badge-primary font-black text-[10px] h-4 min-h-0">AI</span>
                                {{ _('AI Enhanced') }}
                            </span>
                        </label>
                    </div>
                </div>
            </div>

            <!-- Technical Specifications Group -->
            <div
                class="collapse collapse-arrow bg-base-100 rounded-none sm:rounded-2xl shadow-sm border-y sm:border border-base-200 overflow-visible">
                <input type="checkbox" checked />
                <div class="collapse-title p-3 sm:p-6 pb-0">
                    <h3
                        class="font-bold text-base text-base-content/40 uppercase tracking-widest flex items-center gap-2 text-xs">
                        <span class="mdi mdi-cog-outline"></span>
                        {{ _('Technical Specifications') }}
                    </h3>
                </div>
                <div class="collapse-content p-3 sm:p-6 pt-0">
                    <div class="space-y-6 pt-4">
                        <!-- Yarns Card -->
                        <div class="bg-base-200/30 rounded-xl border border-base-200 p-4">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-lg font-semibold text-base-content flex items-center gap-2">
                                    <span class="mdi mdi-sheep text-primary"></span>
                                    {{ _('Yarns Used') }}
                                </h3>
                                <a href="/yarn/new" class="btn btn-link btn-xs p-0 h-auto min-h-0" target="_blank"
                                    rel="noreferrer">
                                    {{ _('Add new') }}
                                </a>
                            </div>

                            <div class="space-y-4">
                                <input type="hidden" id="yarn_ids" name="yarn_ids" value="">
                                <input type="hidden" id="yarn_text_hidden" name="yarn_text" value="">

                                <div class="relative">
                                    <input type="text" id="yarn_search" placeholder="{{ _('Search yarns...') }}"
                                        class="input input-bordered w-full pl-10" autocomplete="off">
                                    <span
                                        class="mdi mdi-magnify absolute left-3 top-1/2 -translate-y-1/2 text-base-content/60 text-xl"></span>
                                </div>

                                <div id="yarn_dropdown"
                                    class="hidden absolute z-50 w-full max-w-md max-h-60 overflow-y-auto bg-base-100 border border-base-300 rounded-lg shadow-xl">
                                    {% for yarn in yarns %}
                                    <button type="button"
                                        class="yarn-option w-full text-left px-3 py-2 hover:bg-base-200 border-b border-base-200 last:border-b-0 text-sm"
                                        data-yarn-id="{{ yarn.id }}" data-yarn-name="{{ yarn.name }}"
                                        data-yarn-brand="{{ yarn.brand or '' }}"
                                        data-yarn-colorway="{{ yarn.colorway or '' }}"
                                        data-yarn-dye-lot="{{ yarn.dye_lot or '' }}"
                                        data-yarn-link="{{ yarn.link or '' }}"
                                        data-yarn-image="{{ yarn.photos[0].filename if yarn.photos and yarn.photos[0] else '' }}">
                                        <div class="flex items-center gap-2">
                                            <div
                                                class="w-8 h-8 rounded bg-base-300 flex items-center justify-center shrink-0">
                                                {% if yarn.photos and yarn.photos[0] %}
                                                <img src="{{ yarn.photos[0].filename }}" alt=""
                                                    class="w-full h-full rounded object-cover">
                                                {% else %}
                                                <span class="mdi mdi-sheep text-sm opacity-50"></span>
                                                {% endif %}
                                            </div>
                                            <div class="min-w-0 flex-1">
                                                <div class="font-medium truncate">{{ yarn.name }}</div>
                                                <div class="text-[10px] opacity-60 truncate">{{ yarn.brand or '' }}
                                                </div>
                                            </div>
                                        </div>
                                    </button>
                                    {% endfor %}
                                </div>

                                <div id="selected_yarns" class="grid grid-cols-1 sm:grid-cols-2 gap-2">
                                    <!-- Chips populated by JS -->
                                </div>
                            </div>
                        </div>

                        <!-- Other Materials Card -->
                        <div class="bg-base-200/30 rounded-xl border border-base-200 p-4">
                            <h3 class="text-lg font-semibold text-base-content mb-4 flex items-center gap-2">
                                <span class="mdi mdi-package-variant-closed text-primary"></span>
                                {{ _('Other Materials') }}
                            </h3>
                            <div>
                                <textarea id="other_materials" name="other_materials" rows="3"
                                    class="textarea textarea-bordered w-full"
                                    placeholder="{{ _('e.g. Buttons, zippers, ribbon, etc.') }}">{{ project.other_materials if project and project.other_materials else '' }}</textarea>
                                <p class="text-xs text-base-content/70 mt-1">{{ _('Supports Markdown formatting') }}</p>
                            </div>
                        </div>

                        <!-- Recommended Needles Card -->
                        <div class="bg-base-200/30 rounded-xl border border-base-200 p-4">
                            <h3 class="text-lg font-semibold text-base-content mb-4 flex items-center gap-2">
                                <span class="mdi mdi-needle text-primary"></span>
                                {{ _('Recommended Needles') }}
                            </h3>
                            <div>
                                <textarea id="needles" name="needles" rows="2" class="textarea textarea-bordered w-full"
                                    placeholder="{{ _('e.g. 4.0mm circular') }}">{{ project.needles if project and project.needles else '' }}</textarea>
                            </div>
                        </div>

                        <!-- Stitch Sample Card -->
                        <div class="bg-base-200/30 rounded-xl border border-base-200 p-4">
                            <h3 class="text-lg font-semibold text-base-content mb-4 flex items-center gap-2">
                                <span class="mdi mdi-grid text-primary"></span>
                                {{ _('Stitch Sample') }}
                            </h3>
                            <div class="space-y-4">
                                <div>
                                    <textarea id="stitch_sample" name="stitch_sample" rows="4"
                                        class="textarea textarea-bordered w-full"
                                        placeholder="{{ _('Describe your stitch sample / gauge swatch...') }}"
                                        data-markdown-images="true">{{ project.stitch_sample if project and project.stitch_sample else '' }}</textarea>
                                    <p class="text-xs text-base-content/70 mt-1 mb-2">{{ _('Supports Markdown formatting and image drops') }}</p>

                                    <h4 id="stitchSamplePhotosLabel"
                                        class="text-xs font-bold text-base-content/50 uppercase tracking-wider mb-2 flex items-center gap-1 mt-4 pt-4 border-t border-base-100{% if not project or not project.stitch_sample_images %} hidden{% endif %}">
                                        <span class="mdi mdi-image-outline"></span> {{ _('Stitch Sample Photos') }}
                                    </h4>
                                    <div id="stitchSampleImagesContainer"
                                        class="grid grid-cols-2 md:grid-cols-3 gap-4 mb-4 pswp-gallery"
                                        data-pswp-gallery>
                                        {% if project and project.stitch_sample_images %}
                                        {% for image in project.stitch_sample_images %}
                                        {{ image_upload.image_preview(image, show_crop=true) }}
                                        {% endfor %}
                                        {% endif %}
                                    </div>
                                    {{ image_upload.upload_dropzone('stitchSampleImageInput',
                                    container_id='stitchSampleDropzone')
                                    }}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Steps Card -->
            <div
                class="collapse collapse-arrow bg-base-100 rounded-none sm:rounded-2xl shadow-sm border-y sm:border border-base-200 overflow-visible">
                <input type="checkbox" checked />
                <div class="collapse-title p-3 sm:p-6 pb-0">
                    <h3 class="text-xl font-semibold text-base-content flex items-center gap-2">
                        <span class="mdi mdi-format-list-text text-primary"></span>
                        {{ _('Steps') }}
                    </h3>
                </div>
                <div class="collapse-content p-3 sm:p-6 pt-0">
                    <div id="stepsContainer" class="space-y-4 pt-4">
                        {% for step in (project.steps if project else []) %}
                        <div class="step-item border rounded-lg p-2 md:p-4 bg-base-200/50 border-base-300"
                            data-step-id="{{ step.id }}" data-step-number="{{ step.step_number }}">
                            <!-- Step Item Content -->
                            <div class="flex items-center justify-between mb-3">
                                <h4 class="text-lg font-medium text-base-content">{{ _('Step') }} <span
                                        class="step-number">{{
                                        step.step_number }}</span></h4>
                                <div class="flex flex-wrap gap-2">
                                    <button type="button" data-call="moveStepUp" class="btn btn-xs btn-ghost gap-1"
                                        title="{{ _('Move Up') }}">
                                        <span class="mdi mdi-arrow-up"></span>
                                        <span class="hidden sm:inline">{{ _('Move Up') }}</span>
                                    </button>
                                    <button type="button" data-call="moveStepDown" class="btn btn-xs btn-ghost gap-1"
                                        title="{{ _('Move Down') }}">
                                        <span class="mdi mdi-arrow-down"></span>
                                        <span class="hidden sm:inline">{{ _('Move Down') }}</span>
                                    </button>
                                    <button type="button" data-call="saveStep" class="btn btn-xs btn-primary gap-1"
                                        title="{{ _('Save') }}">
                                        <span class="mdi mdi-content-save"></span>
                                        <span class="hidden sm:inline">{{ _('Save') }}</span>
                                    </button>
                                    <button type="button" data-call="removeStep"
                                        class="btn btn-xs btn-error text-white gap-1" title="{{ _('Remove Step') }}">
                                        <span class="mdi mdi-delete"></span>
                                        <span class="hidden sm:inline">{{ _('Remove') }}</span>
                                    </button>
                                </div>
                            </div>
                            <div class="mb-2">
                                <input type="text" class="step-title input input-bordered w-full"
                                    placeholder="{{ _('Step Title') }}" value="{{ step.title }}">
                            </div>
                            <textarea class="step-description textarea textarea-bordered w-full mb-2" rows="3"
                                placeholder="{{ _('Step Description') }}"
                                data-markdown-images="true">{{ step.description or '' }}</textarea>
                            <p class="text-xs text-base-content/70 mb-2">{{ _('Supports Markdown formatting') }}</p>
                            <h4
                                class="step-photos-label text-xs font-bold text-base-content/50 uppercase tracking-wider mb-2 flex items-center gap-1 mt-4 pt-4 border-t border-base-100{% if not step.images %} hidden{% endif %}">
                                <span class="mdi mdi-image-outline"></span> {{ _('Step Photos') }}
                            </h4>
                            <div class="step-images grid grid-cols-3 gap-2 mb-2 pswp-gallery" data-pswp-gallery>
                                {% for image in step.images %}
                                {{ image_upload.image_preview(image, class='aspect-video overflow-hidden',
                                show_crop=true) }}
                                {% endfor %}
                            </div>
                            {{ image_upload.step_upload_dropzone(
                            input_id='stepImageInput' + step.id|string,
                            step_id=step.id
                            ) }}
                        </div>
                        {% endfor %}
                    </div>
                    <button type="button" data-call="addStep" class="btn btn-success text-white mt-4 gap-2">
                        <span class="mdi mdi-playlist-plus text-xl"></span>
                        {{ _('Add Step') }}
                    </button>
                </div>
            </div>
        </div>

        <div class="hidden lg:block lg:absolute lg:right-0 lg:top-0 z-30">
            <button type="button" id="project-details-restore-button"
                class="flex h-16 w-8 -mr-4 items-center justify-center rounded-l-full bg-base-100/90 backdrop-blur border border-base-200 shadow-lg text-base-content/50 transition-all duration-200 opacity-0 pointer-events-none translate-x-2 scale-95 hover:text-primary hover:border-primary/40"
                data-call="restoreEditSidebarDetails" title="{{ _('Project Details') }}"
                aria-label="{{ _('Project Details') }}">
                <span class="mdi mdi-chevron-left text-lg"></span>
                <span class="sr-only">{{ _('Project Details') }}</span>
            </button>
        </div>

        <!-- Sidebar Column -->
        <div id="sidebar-column" class="space-y-6 lg:col-start-3 lg:row-start-1 lg:sticky lg:top-24 lg:self-start">
            <!-- Project Details Card -->
            <div
                class="collapse collapse-right collapse-arrow bg-base-100 rounded-2xl shadow-sm border border-base-200 hidden lg:block">
                <input type="checkbox" id="project-details-toggle-sidebar" checked
                    data-call-change="toggleEditSidebarExpansion" />
                <label for="project-details-toggle-sidebar"
                    class="collapse-title font-bold text-base text-base-content/40 uppercase tracking-widest text-xs">
                    <span class="flex items-center gap-2">
                        <span class="mdi mdi-information-outline"></span>
                        {{ _('Project Details') }}
                    </span>
                </label>

                <div class="collapse-content space-y-4">
                    <div class="pt-2">
                        <div>
                            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2 mb-1">
                                <label for="category" class=" text-xs font-bold uppercase text-base-content/50">
                                    {{ _('Category') }}
                                </label>
                                <a href="/projects/categories" class="btn btn-link btn-xs p-0 h-auto min-h-0"
                                    target="_blank" rel="noreferrer">
                                    {{ _('Manage') }}
                                </a>
                            </div>
                            <select id="category" name="category" class="select  select-sm w-full">
                                <option value="">{{ _('Select a category') }}</option>
                                {% for category in categories %}
                                <option value="{{ category }}" {% if project and project.category==category %}selected{%
                                    endif %}>
                                    {{ category }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>

                        <div>
                            <label for="tags_input" class=" text-xs font-bold uppercase text-base-content/50">
                                {{ _('Tags') }}
                            </label>
                            <div id="tags_chips" class="flex flex-wrap gap-2 mt-2"></div>
                            <div class="relative mt-2">
                                <input type="text" id="tags_input" class="input  input-sm w-full" autocomplete="off"
                                    placeholder="{{ _('Add a tag...') }}">
                                <div id="tags_suggestions"
                                    class="hidden absolute z-30 w-full mt-1 max-h-48 overflow-y-auto bg-base-100 border border-base-300 rounded-lg shadow-xl">
                                    {% for tag in tag_suggestions %}
                                    <button type="button"
                                        class="tag-suggestion w-full text-left px-3 py-2 hover:bg-base-200 text-sm"
                                        data-tag="{{ tag }}">
                                        #{{ tag }}
                                    </button>
                                    {% endfor %}
                                </div>
                            </div>
                            <p class="text-[10px] text-base-content/60 mt-1">{{ _('Press Enter or choose a suggestion.')
                                }}
                            </p>
                        </div>

                        <div class="divider my-2"></div>

                        <div>
                            <div class="flex items-center justify-between mb-1">
                                <label for="link" class=" text-xs font-bold uppercase text-base-content/50">
                                    {{ _('Pattern Source') }}
                                </label>
                                <button type="button" id="reimport-btn"
                                    class="btn btn-ghost btn-xs gap-1 normal-case {{ 'hidden' if not project.link else '' }}"
                                    data-call="importFromUrl" data-call-args='["$value:#link"]'>
                                    <span class="mdi mdi-download"></span>
                                    {{ _('Re-import') }}
                                </button>
                                <a href="{{ project.link }}" target="_blank"
                                    class="btn btn-ghost btn-xs gap-1 normal-case {{ 'hidden' if not project.link else '' }}"
                                    id="visit-link-btn" title="{{ _('Visit Website') }}">
                                    <span class="mdi mdi-open-in-new"></span>
                                    {{ _('Visit') }}
                                </a>
                                <button type="button" class="btn btn-ghost btn-xs gap-1 normal-case"
                                    data-call="copyToClipboard" data-call-args='["$value:#link","$this"]'
                                    title="{{ _('Copy URL') }}">
                                    <span class="mdi mdi-content-copy"></span>
                                </button>
                            </div>
                            <input type="url" id="link" name="link" value="{{ project.link or '' }}"
                                class="input  input-sm w-full" placeholder="https://..."
                                data-call-input="syncLinkInputs">
                            <label id="wayback_sidebar_container"
                                class="label cursor-pointer justify-start gap-3 px-3 py-2 bg-base-200/50 rounded-xl border border-base-300 mt-2 {% if not feature_wayback_enabled %}hidden{% endif %}">
                                <input type="checkbox" id="archive_on_save_sidebar" name="archive_on_save" value="1"
                                    class="checkbox checkbox-primary checkbox-sm" checked>
                                <span class="label-text text-xs font-bold uppercase text-base-content/50">{{ _('Archive on Wayback Machine') }}</span>
                            </label>
                        </div>

                        <div class="pt-2 border-t border-base-200">
                            <label id="ai_enhanced_sidebar_container"
                                class="label cursor-pointer justify-start gap-3 px-3 py-2 bg-base-200/50 rounded-xl border border-base-300">
                                <input type="checkbox" id="is_ai_enhanced_checkbox"
                                    class="checkbox checkbox-primary checkbox-sm" {% if project and
                                    project.is_ai_enhanced %}checked{% endif %} data-call-change="syncAiEnhanced">
                                <span
                                    class="label-text text-xs font-bold uppercase text-base-content/50 flex items-center gap-2">
                                    <span class="badge badge-primary font-black text-[10px] h-4 min-h-0">AI</span>
                                    {{ _('AI Enhanced') }}
                                </span>
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Danger Zone -->
            {% if project %}
            <div
                class="bg-red-50 dark:bg-red-900/10 rounded-none sm:rounded-2xl shadow-sm border-y sm:border border-red-100 dark:border-red-900/30 p-3 sm:p-5">
                <h3
                    class="font-bold text-base text-red-800 dark:text-red-400 uppercase tracking-widest mb-4 flex items-center gap-2 text-xs">
                    <span class="mdi mdi-alert-outline"></span>
                    {{ _('Danger Zone') }}
                </h3>
                {{ buttons.danger(_('Delete Project'), icon='mdi-delete-outline',
                attrs='data-action="open-dialog" data-dialog-id="deleteProjectDialog"', class="w-full") }}
            </div>
            {% endif %}
        </div>
    </div>
</form>
{% endblock %}

{% block page_scripts %}
<script>
{% include "projects/form.js" %}
</script>


<dialog id="deleteProjectDialog" class="modal modal-bottom sm:modal-middle">
    <div class="modal-box">
        <h3 class="font-bold text-lg">{{ _('Delete Project') }}</h3>
        <div class="py-4 space-y-4">
            <p class="text-base-content/80">
                {{ _('Are you sure you want to delete this project?') }}
                <br>
                <strong class="text-base-content">{{ project.name }}</strong>
            </p>

            {% if project.exclusive_yarns %}
            <div class="bg-warning/10 border-l-4 border-warning p-4 rounded-r-lg">
                <div class="flex items-start gap-3">
                    <span class="mdi mdi-alert text-warning text-xl"></span>
                    <div class="space-y-2">
                        <p class="text-sm font-medium">{{ _('Some yarns are only used in this project:') }}</p>
                        <p class="text-xs opacity-80">{{ _('Select the yarns you want to delete:') }}</p>
                        <div class="space-y-2">
                            {% for yarn in project.exclusive_yarns %}
                            <label
                                class="flex items-center gap-3 rounded-lg border border-warning/20 bg-base-100 px-2.5 py-2 text-sm transition hover:border-warning/40">
                                <input type="checkbox"
                                    class="checkbox checkbox-warning checkbox-sm exclusive-yarn-checkbox"
                                    value="{{ yarn.id }}">
                                <div
                                    class="flex h-8 w-8 shrink-0 items-center justify-center overflow-hidden rounded-md bg-base-200">
                                    {% if yarn.preview_url %}
                                    <img src="{{ yarn.preview_url }}" alt="{{ yarn.preview_alt or yarn.name }}"
                                        class="h-full w-full object-cover">
                                    {% else %}
                                    <span class="mdi mdi-sheep text-base-content/40"></span>
                                    {% endif %}
                                </div>
                                <div class="min-w-0 flex-1">
                                    <div class="truncate font-medium">{{ yarn.name }}</div>
                                    <div class="text-xs text-base-content/60 truncate">
                                        {{ yarn.brand or _('Unknown Brand') }}
                                        {% if yarn.colorway %}  {{ yarn.colorway }}{% endif %}
                                    </div>
                                </div>
                            </label>
                            {% endfor %}
                        </div>
                        <label class="label cursor-pointer justify-start gap-3 p-0 mt-3">
                            <input type="checkbox" id="select_all_exclusive_yarns"
                                class="checkbox checkbox-warning checkbox-sm">
                            <span class="label-text font-bold">{{ _('Select all yarns') }}</span>
                        </label>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
        <div class="modal-action">
            {{ dialogs.dialog_cancel(_('Cancel'),
            attrs='data-action="close-dialog" data-dialog-id="deleteProjectDialog"') }}
            {{ dialogs.dialog_danger(_('Delete'), attrs='data-call="deleteProject" data-call-args="[]"') }}
        </div>
    </div>
    {{ dialogs.modal_backdrop() }}
</dialog>

<dialog id="csrfErrorDialog" class="modal modal-bottom sm:modal-middle">
    <div class="modal-box">
        <h3 class="font-bold text-lg">{{ _('Session expired') }}</h3>
        <div class="py-4 space-y-4">
            <p class="text-base-content/80">{{ _('Your session has expired. Reload the page to continue.') }}</p>
            <p class="text-base-content/70 text-sm">{{ _('This can happen after restarting the server.') }}</p>
        </div>
        <div class="modal-action">
            {{ dialogs.dialog_cancel(_('Cancel'),
            attrs='data-action="close-dialog" data-dialog-id="csrfErrorDialog"') }}
            <button type="button" class="btn btn-primary" data-action="reload">
                <span class="mdi mdi-refresh"></span>
                {{ _('Reload page') }}
            </button>
        </div>
    </div>
    {{ dialogs.modal_backdrop() }}
</dialog>


{% endblock %}
