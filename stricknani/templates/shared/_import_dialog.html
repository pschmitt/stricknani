{% import "macros/dialogs.html" as dialogs %}
{% call dialogs.modal('importDialog', title=_('Import'), box_class='max-w-xl', attrs='data-import-dialog') %}
<!-- Tab Navigation -->
<div class="tabs tabs-boxed bg-base-200/50 p-1 rounded-xl mb-6">
    <button type="button"
        class="tab flex-1 rounded-lg transition-all tab-active bg-base-100 shadow-sm"
        data-import-tab="url">
        <span class="mdi mdi-link-variant mr-2"></span>
        {{ _('From URL') }}
    </button>
    <button type="button"
        class="tab flex-1 rounded-lg transition-all"
        data-import-tab="file">
        <span class="mdi mdi-file-upload mr-2"></span>
        {{ _('From File') }}
    </button>
</div>

<!-- URL Import Form -->
<form id="{{ import_form_id }}" action="{{ import_action }}" method="POST" enctype="multipart/form-data"
    data-import-panel="url">
    <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
    <input type="hidden" name="type" value="url">
    {% if import_project_id is not none %}
    <input type="hidden" name="project_id" value="{{ import_project_id }}">
    {% endif %}
    {% if import_use_ai %}
    <input type="hidden" name="use_ai" value="true">
    {% endif %}

    <div class="space-y-6 py-2">
        <!-- Magic Header -->
        <div class="flex items-center gap-4 p-4 bg-primary/5 rounded-2xl border border-primary/10">
            <div class="flex-shrink-0 w-12 h-12 flex items-center justify-center bg-primary/10 text-primary rounded-xl">
                <span class="mdi mdi-auto-fix text-2xl"></span>
            </div>
            <div>
                <h4 class="font-bold text-base">{{ _('Magic Import') }}</h4>
                <p class="text-xs opacity-70 leading-relaxed">{{ import_description }}</p>
            </div>
        </div>

        <!-- URL Input -->
        <div class="form-control w-full">
            <label class="label pt-0">
                <span class="label-text font-semibold">{{ import_url_label }}</span>
            </label>
            <div class="relative group">
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-base-content/40 group-focus-within:text-primary transition-colors">
                    <span class="mdi mdi-link-variant text-xl"></span>
                </div>
                <input type="url" id="importUrl" name="url"
                    placeholder="{{ import_url_placeholder }}"
                    value="{{ import_url_value }}"
                    class="input input-bordered w-full pl-10 bg-base-200/50 focus:bg-base-100 transition-all border-base-content/10 focus:border-primary" />
            </div>
        </div>

        {% if import_ai_notice %}
        <div class="flex items-center gap-2 px-3 py-2 bg-primary/5 rounded-xl border border-primary/10">
            <span class="mdi mdi-information-outline text-primary text-sm"></span>
            <span class="text-[10px] uppercase font-bold tracking-wider text-primary/70">{{ import_ai_notice }}</span>
        </div>
        {% endif %}
    </div>

    <div class="modal-action mt-8">
        {{ dialogs.dialog_cancel(_('Cancel'),
        attrs='data-action="close-dialog" data-dialog-id="importDialog"') }}
        {{ dialogs.dialog_primary(_('Import'), icon='mdi-auto-fix', type='submit', class='sm:btn-wide') }}
    </div>
</form>

<!-- File Import Form -->
<form id="{{ import_form_id }}File" action="{{ import_action }}" method="POST" enctype="multipart/form-data"
    data-import-panel="file" hidden>
    <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
    <input type="hidden" name="type" value="file">
    {% if import_project_id is not none %}
    <input type="hidden" name="project_id" value="{{ import_project_id }}">
    {% endif %}
    {% if import_use_ai %}
    <input type="hidden" name="use_ai" value="true">
    {% endif %}

    <div class="space-y-6 py-2">
        <!-- AI Vision Header -->
        <div class="flex items-center gap-4 p-4 bg-primary/5 rounded-2xl border border-primary/10">
            <div class="flex-shrink-0 w-12 h-12 flex items-center justify-center bg-primary/10 text-primary rounded-xl">
                <span class="mdi mdi-image-search text-2xl"></span>
            </div>
            <div>
                <h4 class="font-bold text-base">{{ _('AI Vision Import') }}</h4>
                <p class="text-xs opacity-70 leading-relaxed">
                    {{ _('Upload photos, PDFs, or text files. Our AI will analyze them and extract pattern details for you.') }}
                </p>
            </div>
        </div>

        <!-- File Upload Zone -->
        <div class="form-control w-full">
            <label class="label pt-0">
                <span class="label-text font-semibold">{{ _('Upload Files') }}</span>
                <span class="label-text-alt text-xs opacity-60">{{ _('Images, PDFs, or text files') }}</span>
            </label>

            <!-- Drag & Drop Zone -->
            <div id="fileDropZone"
                class="relative border-2 border-dashed border-base-content/20 rounded-2xl p-8 text-center transition-all hover:border-primary/50 hover:bg-primary/5 cursor-pointer"
                data-import-file-dropzone>

                <input type="file" id="importFile" name="file" class="hidden"
                    data-import-file-input
                    accept=".jpg,.jpeg,.png,.gif,.webp,.pdf,.txt,.md,.html,.htm"
                    />

                <div class="space-y-3" data-import-file-empty>
                    <div class="w-16 h-16 mx-auto flex items-center justify-center bg-base-200 rounded-full">
                        <span class="mdi mdi-cloud-upload text-3xl text-primary"></span>
                    </div>
                    <div>
                        <p class="font-medium">{{ _('Drop files here or click to browse') }}</p>
                        <p class="text-sm opacity-60 mt-1">
                            {{ _('Supports: JPG, PNG, GIF, WebP, PDF, TXT, MD') }}
                        </p>
                    </div>
                </div>

                <div class="space-y-3" data-import-file-selected hidden>
                    <div class="w-16 h-16 mx-auto flex items-center justify-center bg-success/10 rounded-full">
                        <span class="mdi mdi-check text-3xl text-success"></span>
                    </div>
                    <div>
                        <p class="font-medium" data-import-file-name></p>
                        <p class="text-sm opacity-60 mt-1">
                            <span data-import-file-size></span>
                            <button type="button" data-import-file-clear class="ml-2 text-error hover:underline">
                                {{ _('Remove') }}
                            </button>
                        </p>
                    </div>
                </div>
            </div>

            <!-- Multiple Files Note -->
            <p class="text-xs opacity-60 mt-2 text-center">
                {{ _('Tip: For best results, upload clear photos of pattern covers, yarn labels, or instruction pages.') }}
            </p>
        </div>

        {% if import_ai_notice %}
        <div class="flex items-center gap-2 px-3 py-2 bg-primary/5 rounded-xl border border-primary/10">
            <span class="mdi mdi-brain text-primary text-sm"></span>
            <span class="text-[10px] uppercase font-bold tracking-wider text-primary/70">
                {{ _('AI-Powered Analysis Enabled') }}
            </span>
        </div>
        {% endif %}
    </div>

    <div class="modal-action mt-8">
        {{ dialogs.dialog_cancel(_('Cancel'),
        attrs='data-action="close-dialog" data-dialog-id="importDialog"') }}
        <button type="submit" class="btn btn-primary sm:btn-wide btn-disabled opacity-50"
            data-import-file-submit disabled>
            <span class="mdi mdi-auto-fix mr-2"></span>
            {{ _('Analyze & Import') }}
        </button>
    </div>
</form>

<!-- Loading State -->
<div id="importLoading" class="text-center py-12 space-y-4" hidden>
    <div class="relative inline-block">
        <div class="w-16 h-16 border-4 border-primary/20 border-t-primary rounded-full animate-spin"></div>
        <div class="absolute inset-0 flex items-center justify-center">
            <span class="mdi mdi-auto-fix text-primary text-xl animate-pulse"></span>
        </div>
    </div>
    <div class="space-y-1">
        <p class="text-lg font-bold">{{ _('Working some magic...') }}</p>
        <p class="text-sm opacity-60 max-w-xs mx-auto">{{ import_analyzing_description }}</p>
    </div>
</div>

<script>
    (function () {
        const formId = {{ import_form_id | tojson }};
        const storageKey = {{ import_storage_key | tojson }};
        const redirectUrl = {{ import_redirect_url | tojson }};
        const populateFnName = {{ import_populate_fn | tojson }};

        const dialog = document.getElementById('importDialog');
        if (!dialog) {
            return;
        }

        let selectedFile = null;
        let currentTab = 'url';

        const urlForm = document.getElementById(formId);
        const fileForm = document.getElementById(formId + 'File');
        const loading = document.getElementById('importLoading');

        const tabs = Array.from(dialog.querySelectorAll('[data-import-tab]'));
        const panels = {
            url: urlForm,
            file: fileForm
        };

        const dropZone = dialog.querySelector('[data-import-file-dropzone]');
        const fileInput = dialog.querySelector('[data-import-file-input]');
        const emptyState = dialog.querySelector('[data-import-file-empty]');
        const selectedState = dialog.querySelector('[data-import-file-selected]');
        const fileNameEl = dialog.querySelector('[data-import-file-name]');
        const fileSizeEl = dialog.querySelector('[data-import-file-size]');
        const clearBtn = dialog.querySelector('[data-import-file-clear]');
        const fileSubmitBtn = dialog.querySelector('[data-import-file-submit]');

        function formatFileSize(bytes) {
            if (!bytes) {
                return '0 Bytes';
            }
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function setSelectedFile(file) {
            selectedFile = file || null;

            if (!emptyState || !selectedState || !fileSubmitBtn) {
                return;
            }

            if (!selectedFile) {
                emptyState.hidden = false;
                selectedState.hidden = true;
                fileSubmitBtn.disabled = true;
                fileSubmitBtn.classList.add('btn-disabled', 'opacity-50');
                if (fileNameEl) {
                    fileNameEl.textContent = '';
                }
                if (fileSizeEl) {
                    fileSizeEl.textContent = '';
                }
                return;
            }

            emptyState.hidden = true;
            selectedState.hidden = false;
            fileSubmitBtn.disabled = false;
            fileSubmitBtn.classList.remove('btn-disabled', 'opacity-50');
            if (fileNameEl) {
                fileNameEl.textContent = selectedFile.name || '';
            }
            if (fileSizeEl) {
                fileSizeEl.textContent = formatFileSize(selectedFile.size || 0);
            }
        }

        function setTab(tab) {
            const nextTab = tab === 'file' ? 'file' : 'url';
            currentTab = nextTab;

            if (loading) {
                loading.hidden = true;
            }

            tabs.forEach((btn) => {
                const isActive = btn.getAttribute('data-import-tab') === nextTab;
                btn.classList.toggle('tab-active', isActive);
                btn.classList.toggle('bg-base-100', isActive);
                btn.classList.toggle('shadow-sm', isActive);
                btn.classList.toggle('hover:bg-base-100/50', !isActive);
            });

            Object.entries(panels).forEach(([key, panel]) => {
                if (!panel) {
                    return;
                }
                panel.hidden = key !== nextTab;
            });
        }

        tabs.forEach((btn) => {
            if (btn.dataset.importTabInitialized) {
                return;
            }
            btn.dataset.importTabInitialized = '1';
            btn.addEventListener('click', () => {
                setTab(btn.getAttribute('data-import-tab') || 'url');
            });
        });

        function handleDrop(files) {
            if (!files || files.length === 0) {
                return;
            }

            const file = files[0];
            setSelectedFile(file);
            setTab('file');

            if (fileInput) {
                try {
                    const dt = new DataTransfer();
                    dt.items.add(file);
                    fileInput.files = dt.files;
                } catch {
                    // Some browsers may not allow programmatic assignment; we still keep the file in memory.
                }
            }
        }

        if (dialog) {
            dialog.addEventListener('dragenter', (e) => {
                e.preventDefault();
                if (dropZone) dropZone.classList.add('border-primary', 'bg-primary/5');
            });
            dialog.addEventListener('dragover', (e) => {
                e.preventDefault();
                if (dropZone) dropZone.classList.add('border-primary', 'bg-primary/5');
            });
            dialog.addEventListener('dragleave', (e) => {
                e.preventDefault();
                // Check if we're actually leaving the dialog
                if (e.relatedTarget === null || !dialog.contains(e.relatedTarget)) {
                    if (dropZone) dropZone.classList.remove('border-primary', 'bg-primary/5');
                }
            });
            dialog.addEventListener('drop', (e) => {
                e.preventDefault();
                if (dropZone) dropZone.classList.remove('border-primary', 'bg-primary/5');
                handleDrop(e.dataTransfer?.files);
            });
        }

        if (dropZone) {
            if (!dropZone.dataset.importDropInitialized) {
                dropZone.dataset.importDropInitialized = '1';

                const dragOnClasses = ['border-primary', 'bg-primary/5'];

                function setDragging(isDragging) {
                    dragOnClasses.forEach((c) => dropZone.classList.toggle(c, isDragging));
                }

                dropZone.addEventListener('click', () => {
                    fileInput?.click();
                });

                dropZone.addEventListener('dragenter', (e) => {
                    e.preventDefault();
                    setDragging(true);
                });

                dropZone.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    setDragging(true);
                });

                dropZone.addEventListener('dragleave', (e) => {
                    e.preventDefault();
                    setDragging(false);
                });

                dropZone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    setDragging(false);
                    handleDrop(e.dataTransfer?.files);
                });
            }
        }

        if (fileInput) {
            if (!fileInput.dataset.importInputInitialized) {
                fileInput.dataset.importInputInitialized = '1';
                fileInput.addEventListener('change', (e) => {
                    const input = e.target;
                    const files = input?.files;
                    setSelectedFile(files && files.length > 0 ? files[0] : null);
                });
            }
        }

        if (clearBtn) {
            if (!clearBtn.dataset.importClearInitialized) {
                clearBtn.dataset.importClearInitialized = '1';
                clearBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    if (fileInput) {
                        fileInput.value = '';
                    }
                    setSelectedFile(null);
                });
            }
        }

        // Default state
        setTab('url');
        setSelectedFile(null);

        if (urlForm) {
            if (!urlForm.dataset.importSubmitInitialized) {
                urlForm.dataset.importSubmitInitialized = '1';
                urlForm.addEventListener('submit', handleFormSubmit);
            }
        }

        if (fileForm) {
            if (!fileForm.dataset.importSubmitInitialized) {
                fileForm.dataset.importSubmitInitialized = '1';
                fileForm.addEventListener('submit', handleFormSubmit);
            }
        }

        async function handleFormSubmit(e) {
            e.preventDefault();

            const form = e.target;
            const formData = new FormData(form);

            currentTab = form === fileForm ? 'file' : 'url';
            if (currentTab === 'file' && selectedFile && !formData.get('file')) {
                formData.set('file', selectedFile);
            }

            if (urlForm) {
                urlForm.hidden = true;
            }
            if (fileForm) {
                fileForm.hidden = true;
            }
            if (loading) {
                loading.hidden = false;
            }

            try {
                const response = await fetch(form.action, {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    const error = await response.json().catch(() => ({}));
                    throw new Error(error.detail || 'Unknown error');
                }

                const data = await response.json();
                const populate = populateFnName ? window[populateFnName] : null;

                // If we are on the form page, populate it directly
                if (typeof populate === 'function') {
                    populate(data);
                    dialog?.close();
                    return;
                }

                // Store data for the new form and redirect
                sessionStorage.setItem(storageKey, JSON.stringify(data));
                window.location.href = redirectUrl;
            } catch (err) {
                console.error(err);
                alert('Import failed: ' + (err?.message || 'Unknown error'));
            } finally {
                if (loading) {
                    loading.hidden = true;
                }
                setTab(currentTab);
            }
        }
    })();
</script>
{% endcall %}
