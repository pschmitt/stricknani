{% extends "base.html" %}
{% import "macros/dialogs.html" as dialogs %}

{% block content %}
{% block form_styles %}{% endblock %}
{% block form_before %}{% endblock %}
<div
    class="{% block form_container_class %}max-w-7xl{% endblock %} mx-auto px-0 sm:px-6 lg:px-8 py-2 md:py-8 space-y-4 md:space-y-6">
    <!-- Header -->
    <div
        class="flex flex-col md:flex-row md:items-start md:justify-between gap-4 {% block form_header_class %}{% endblock %}">
        <div class="flex-1 min-w-0">
            <div class="flex items-center gap-3">
                {% block form_nav %}{% endblock %}
                <h1 class="text-3xl md:text-4xl font-extrabold text-base-content tracking-tight truncate">
                    {% block form_title %}{% endblock %}
                </h1>
            </div>
        </div>
        <div class="flex flex-wrap items-center gap-3 shrink-0">
            {% block form_actions %}{% endblock %}
        </div>
    </div>

    <!-- Form Content -->
    {% block form_body %}{% endblock %}
</div>
<dialog id="unsavedChangesDialog" class="modal modal-bottom sm:modal-middle">
    <div class="modal-box">
        <h3 class="font-bold text-lg">{{ _('Unsaved changes') }}</h3>
        <p class="py-4">{{ _('You have unsaved changes. Save before leaving?') }}</p>
        <div class="modal-action">
            {{ dialogs.dialog_cancel(_('Cancel'), attrs='data-unsaved-cancel') }}
            {{ dialogs.dialog_danger(_('Discard changes'), icon='mdi-trash-can-outline', attrs='data-unsaved-leave') }}
            {{ dialogs.dialog_primary(_('Save'), icon='mdi-content-save', attrs='data-unsaved-save') }}
        </div>
    </div>
    {{ dialogs.modal_backdrop() }}
</dialog>
{% block page_scripts %}{% endblock %}

<script>
    // Initialize as soon as possible to avoid race conditions with other scripts
    // Ensure we don't clobber if child template already set something (like hooks)
    window.unsavedChanges = {
        _isDirty: false,
        setDirty: function (value = true) { this._isDirty = value; },
        isDirty: function () { return this._isDirty; },
        onBeforeDiscard: null, // Async hook
        ...window.unsavedChanges
    };

    document.addEventListener('DOMContentLoaded', () => {
        const dialog = document.getElementById('unsavedChangesDialog');
        const cancelButton = dialog?.querySelector('[data-unsaved-cancel]');
        const leaveButton = dialog?.querySelector('[data-unsaved-leave]');
        const saveButton = dialog?.querySelector('[data-unsaved-save]');
        let pendingNavigation = null;

        // Track changes on any form element within main
        document.addEventListener('input', (e) => {
            if (e.target.closest('main form')) {
                window.unsavedChanges.setDirty(true);
            }
        });

        document.addEventListener('change', (e) => {
            if (e.target.closest('main form')) {
                window.unsavedChanges.setDirty(true);
            }
        });

        // Allow submission without warning
        document.addEventListener('submit', (e) => {
            if (e.target.closest('main form')) {
                window.unsavedChanges.setDirty(false);
            }
        });

        const showUnsavedDialog = (href) => {
            if (!dialog) return;
            pendingNavigation = href || null;
            dialog.showModal();
        };

        const handleConfirmNav = (event) => {
            if (!window.unsavedChanges.isDirty()) return;
            event.preventDefault();
            const target = event.currentTarget.getAttribute('href') || event.currentTarget.dataset.href;
            showUnsavedDialog(target);
        };

        // Delegate click listener for all elements with data-unsaved-confirm
        document.addEventListener('click', (e) => {
            const confirmElem = e.target.closest('[data-unsaved-confirm]');
            if (confirmElem && (confirmElem.tagName.toLowerCase() === 'a' || confirmElem.dataset.href)) {
                handleConfirmNav({
                    preventDefault: () => e.preventDefault(),
                    currentTarget: confirmElem
                });
            }
        });

        cancelButton?.addEventListener('click', () => {
            dialog?.close();
        });

        leaveButton?.addEventListener('click', async () => {
            if (window.unsavedChanges.onBeforeDiscard) {
                try {
                    await window.unsavedChanges.onBeforeDiscard();
                } catch (err) {
                    console.error('Error in onBeforeDiscard hook:', err);
                }
            }
            window.unsavedChanges.setDirty(false);
            dialog?.close();
            const target = pendingNavigation;
            pendingNavigation = null;
            if (target) {
                window.location.href = target;
            } else {
                window.history.back();
            }
        });

        saveButton?.addEventListener('click', () => {
            const form = document.querySelector('main form');
            if (!form) return;
            if (form.requestSubmit) {
                form.requestSubmit();
            } else {
                form.submit();
            }
        });

        dialog?.addEventListener('close', () => {
            pendingNavigation = null;
        });

        // Warn before leaving
        window.addEventListener('beforeunload', (e) => {
            if (window.unsavedChanges.isDirty()) {
                e.preventDefault();
                e.returnValue = ''; // Required for Chrome/modern browsers
            }
        });
    });
</script>
{% endblock %}
