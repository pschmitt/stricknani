{% extends "base.html" %}

{% block content %}
{% block form_styles %}{% endblock %}
{% block form_before %}{% endblock %}
<div class="{% block form_container_class %}max-w-7xl{% endblock %} mx-auto px-0 sm:px-6 lg:px-8 py-2 md:py-8 space-y-4 md:space-y-6">
    <!-- Header -->
    <div class="flex flex-col md:flex-row md:items-start md:justify-between gap-4">
        <div class="flex-1 min-w-0">
            <div class="flex items-center gap-3">
                {% block form_nav %}{% endblock %}
                <h1 class="text-3xl md:text-4xl font-extrabold text-base-content tracking-tight truncate">
                    {% block form_title %}{% endblock %}
                </h1>
            </div>
        </div>
        <div class="flex flex-wrap items-center gap-3 shrink-0">
            {% block form_actions %}{% endblock %}
        </div>
    </div>

    <!-- Form Content -->
    {% block form_body %}{% endblock %}
</div>
<dialog id="unsavedChangesDialog" class="modal modal-bottom sm:modal-middle">
    <div class="modal-box">
        <h3 class="font-bold text-lg">{{ _('Unsaved changes') }}</h3>
        <p class="py-4">{{ _('You have unsaved changes. Save before leaving?') }}</p>
        <div class="modal-action">
            <button type="button" class="btn btn-ghost gap-2" data-unsaved-cancel>
                <span class="mdi mdi-close"></span>
                {{ _('Cancel') }}
            </button>
            <button type="button" class="btn btn-error text-white gap-2" data-unsaved-leave>
                <span class="mdi mdi-trash-can-outline"></span>
                {{ _('Discard changes') }}
            </button>
            <button type="button" class="btn btn-primary gap-2" data-unsaved-save>
                <span class="mdi mdi-content-save"></span>
                {{ _('Save') }}
            </button>
        </div>
    </div>
    <form method="dialog" class="modal-backdrop">
        <button>{{ _('close') }}</button>
    </form>
</dialog>
{% block page_scripts %}{% endblock %}

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const form = document.querySelector('main form');
        if (!form) return;

        let isDirty = false;
        const dialog = document.getElementById('unsavedChangesDialog');
        const cancelButton = dialog?.querySelector('[data-unsaved-cancel]');
        const leaveButton = dialog?.querySelector('[data-unsaved-leave]');
        const saveButton = dialog?.querySelector('[data-unsaved-save]');
        let pendingNavigation = null;

        // Track changes
        form.addEventListener('input', () => isDirty = true);
        form.addEventListener('change', () => isDirty = true);

        // Allow submission without warning
        form.addEventListener('submit', () => isDirty = false);

        const showUnsavedDialog = (href) => {
            if (!dialog) return;
            pendingNavigation = href || null;
            dialog.showModal();
        };

        const handleConfirmNav = (event) => {
            if (!isDirty) return;
            event.preventDefault();
            showUnsavedDialog(event.currentTarget.getAttribute('href'));
        };

        document.querySelectorAll('[data-unsaved-confirm]').forEach((link) => {
            if (link.tagName.toLowerCase() !== 'a') return;
            link.addEventListener('click', handleConfirmNav);
        });

        cancelButton?.addEventListener('click', () => {
            dialog?.close();
        });

        leaveButton?.addEventListener('click', () => {
            isDirty = false;
            dialog?.close();
            const target = pendingNavigation;
            pendingNavigation = null;
            if (target) {
                window.location.href = target;
            } else {
                window.history.back();
            }
        });

        saveButton?.addEventListener('click', () => {
            if (form.requestSubmit) {
                form.requestSubmit();
            } else {
                form.submit();
            }
        });

        dialog?.addEventListener('close', () => {
            pendingNavigation = null;
        });

        // Warn before leaving
        window.addEventListener('beforeunload', (e) => {
            if (isDirty) {
                e.preventDefault();
                e.returnValue = ''; // Required for Chrome/modern browsers
            }
        });
    });
</script>
{% endblock %}
