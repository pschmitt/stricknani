{% set current_path = request.url.path %}
{% set current_icon = page_icon if page_icon is defined else 
    'mdi-folder-outline' if current_path.startswith('/projects') else
    'mdi-sheep' if current_path.startswith('/yarn') else
    'mdi-ruler' if current_path.startswith('/gauge') else
    'mdi-shield-account' if current_path.startswith('/admin') else
    'mdi-account-circle' if current_path.startswith('/user') else
    'mdi-login' if current_path.startswith('/login') else
    'mdi-yarn'
%}
{# Check if page_actions contains a back button (looking for mdi-arrow-left) or if back_url is provided #}
{% set has_back_button = back_url or (page_actions and 'mdi-arrow-left' in page_actions) %}
{% set hide_page_title_on_mobile = page_title_mobile_hidden if page_title_mobile_hidden is defined else false %}
{% set display_title = page_title if page_title else _('Stricknani') %}

<nav class="navbar bg-base-100 shadow-sm border-b border-base-300 sticky top-0 z-[80] min-h-12">
    <div class="max-w-none mx-auto px-4 md:px-8 lg:px-10 w-full">
        <div class="flex items-center justify-between h-12 w-full gap-4">
            {# Left side: Back button OR Favicon + Title with dropdown #}
            <div class="flex items-center gap-3 md:gap-8 min-w-0 flex-1">
                {% if has_back_button %}
                {% if back_url %}
                <div class="w-8 h-8 flex items-center justify-center shrink-0">
                    <a href="{{ back_url }}" class="btn btn-circle btn-ghost btn-sm text-base-content/60"
                        aria-label="{{ back_label or _('Back') }}" data-unsaved-confirm="true">
                        <span class="mdi mdi-arrow-left text-xl"></span>
                    </a>
                </div>
                {% else %}
                {# Extract and show just the back button from page_actions using split #}
                {% set parts = page_actions.split('</a>', 1) %}
                {% if parts|length > 1 %}
                <div class="w-8 h-8 flex items-center justify-center shrink-0">
                    {{ parts[0]|safe }}</a>
                </div>
                {% endif %}
                {% endif %}

                {# Page Title - hidden on mobile when back button exists #}
                <div class="dropdown dropdown-start md:dropdown-start navbar-nav-dropdown">
                    <button tabindex="0" role="button"
                        class="flex items-center gap-2 text-xl md:text-2xl font-extrabold text-base-content hover:text-primary transition-colors cursor-pointer group">
                        {% if '<' in current_icon %}
                            <div class="flex items-center {% if hide_page_title_on_mobile %}hidden md:flex{% endif %}">{{ current_icon|safe }}</div>
                        {% else %}
                            <span class="mdi {{ current_icon }} text-primary {% if hide_page_title_on_mobile %}hidden md:inline-block{% endif %}"></span>
                        {% endif %}
                        <span class="truncate {% if hide_page_title_on_mobile %}hidden md:inline{% endif %}">
                            {{ display_title|truncate(40, True, '...') }}
                        </span>
                        <span
                            class="mdi mdi-chevron-down text-base opacity-60 group-hover:opacity-100 transition-opacity {% if hide_page_title_on_mobile %}hidden md:inline{% endif %}"></span>
                    </button>
                    <ul tabindex="0"
                        class="dropdown-content navbar-dropdown-content navbar-dropdown-nav z-[90] menu p-2 shadow-lg bg-base-100 rounded-box w-56 border border-base-200 gap-1 mt-2">
                        {% if current_user %}
                        <li>
                            <a href="/projects"
                                class="{% if current_path.startswith('/projects') %}bg-primary/10 text-primary font-medium{% endif %}">
                                <span class="mdi mdi-folder-outline text-lg"></span>
                                {{ _('Projects') }}
                            </a>
                        </li>
                        <li>
                            <a href="/yarn"
                                class="{% if current_path.startswith('/yarn') %}bg-primary/10 text-primary font-medium{% endif %}">
                                <span class="mdi mdi-sheep text-lg"></span>
                                {{ _('Yarns') }}
                            </a>
                        </li>
                        {% else %}
                        <li>
                            <a href="/login"
                                class="{% if current_path.startswith('/login') %}bg-primary/10 text-primary font-medium{% endif %}">
                                <span class="mdi mdi-login text-lg"></span>
                                {{ _('Login') }}
                            </a>
                        </li>
                        {% endif %}
                        <li>
                            <a href="/gauge"
                                class="{% if current_path.startswith('/gauge') %}bg-primary/10 text-primary font-medium{% endif %}">
                                <span class="mdi mdi-ruler text-lg"></span>
                                {{ _('Gauge Calculator') }}
                            </a>
                        </li>
                        {% if current_user and current_user.is_admin %}
                        <li>
                            <a href="/admin/users"
                                class="{% if current_path.startswith('/admin') %}bg-primary/10 text-primary font-medium{% endif %}">
                                <span class="mdi mdi-shield-account text-lg"></span>
                                {{ _('Admin') }}
                            </a>
                        </li>
                        {% endif %}
                    </ul>
                </div>
                {% else %}
                {# Favicon - links to home #}
                <div class="w-8 h-8 flex items-center justify-center shrink-0">
                    <a href="/" class="block hover:opacity-80 transition-opacity" aria-label="{{ _('Home') }}">
                        <img src="{% if is_dev_instance %}/static/favicon-dev.svg{% else %}/static/favicon.svg{% endif %}"
                            alt="" class="h-8 w-8" />
                    </a>
                </div>

                {# Page Title with Navigation Dropdown #}
                <div class="dropdown dropdown-start md:dropdown-start navbar-nav-dropdown">
                    <button tabindex="0" role="button"
                        class="flex items-center gap-2 text-xl md:text-2xl font-extrabold text-base-content hover:text-primary transition-colors cursor-pointer group">
                        {% if '<' in current_icon %}
                            <div class="flex items-center {% if hide_page_title_on_mobile %}hidden md:flex{% endif %}">{{ current_icon|safe }}</div>
                        {% else %}
                            <span class="mdi {{ current_icon }} text-primary {% if hide_page_title_on_mobile %}hidden md:inline-block{% endif %}"></span>
                        {% endif %}
                        <span class="truncate {% if hide_page_title_on_mobile %}hidden md:inline{% endif %}">
                            {{ display_title|truncate(40, True, '...') }}
                        </span>
                        <span
                            class="mdi mdi-chevron-down text-base opacity-60 group-hover:opacity-100 transition-opacity {% if hide_page_title_on_mobile %}hidden md:inline{% endif %}"></span>
                    </button>
                    <ul tabindex="0"
                        class="dropdown-content navbar-dropdown-content navbar-dropdown-nav z-[90] menu p-2 shadow-lg bg-base-100 rounded-box w-56 border border-base-200 gap-1 mt-2">
                        {% if current_user %}
                        <li>
                            <a href="/projects"
                                class="{% if current_path.startswith('/projects') %}bg-primary/10 text-primary font-medium{% endif %}">
                                <span class="mdi mdi-folder-outline text-lg"></span>
                                {{ _('Projects') }}
                            </a>
                        </li>
                        <li>
                            <a href="/yarn"
                                class="{% if current_path.startswith('/yarn') %}bg-primary/10 text-primary font-medium{% endif %}">
                                <span class="mdi mdi-sheep text-lg"></span>
                                {{ _('Yarns') }}
                            </a>
                        </li>
                        {% else %}
                        <li>
                            <a href="/login"
                                class="{% if current_path.startswith('/login') %}bg-primary/10 text-primary font-medium{% endif %}">
                                <span class="mdi mdi-login text-lg"></span>
                                {{ _('Login') }}
                            </a>
                        </li>
                        {% endif %}
                        <li>
                            <a href="/gauge"
                                class="{% if current_path.startswith('/gauge') %}bg-primary/10 text-primary font-medium{% endif %}">
                                <span class="mdi mdi-ruler text-lg"></span>
                                {{ _('Gauge Calculator') }}
                            </a>
                        </li>
                        {% if current_user and current_user.is_admin %}
                        <li>
                            <a href="/admin/users"
                                class="{% if current_path.startswith('/admin') %}bg-primary/10 text-primary font-medium{% endif %}">
                                <span class="mdi mdi-shield-account text-lg"></span>
                                {{ _('Admin') }}
                            </a>
                        </li>
                        {% endif %}
                    </ul>
                </div>
                {% endif %}
            </div>

            <div class="flex items-center gap-2 shrink-0">
                {% if page_actions %}
                {% if back_url %}
                {# If back_url is handled explicitly, just show all page_actions #}
                {{ page_actions|safe }}
                {% elif has_back_button %}
                {# Back button was extracted from page_actions #}
                {% set parts = page_actions.split('</a>', 1) %}
                {% if parts|length > 1 %}
                {{ parts[1]|safe }}
                {% else %}
                {{ page_actions|safe }}
                {% endif %}
                {% else %}
                {{ page_actions|safe }}
                {% endif %}
                {% endif %}
            </div>

            {# Right side: User menu or Login #}
            <div class="flex items-center shrink-0">
                {% if current_user %}
                <div class="dropdown dropdown-end">
                    <button tabindex="0" role="button" class="btn btn-ghost btn-circle avatar">
                        {% if current_user_avatar_thumbnail %}
                        <div class="w-10 rounded-full">
                            <img src="{{ current_user_avatar_thumbnail }}"
                                alt="{{ _('Profile picture for %(email)s') % {'email': current_user.email} }}" />
                        </div>
                        {% else %}
                        <span class="mdi mdi-account-circle text-3xl"></span>
                        {% endif %}
                    </button>
                    <div tabindex="0" class="dropdown-content navbar-dropdown-content menu bg-base-100 rounded-box z-[90] w-72 p-0 shadow-xl border border-base-300 mt-2">
                        <div class="flex items-center gap-3 border-b border-base-300 px-4 py-3">
                            <div class="avatar">
                                <button type="button"
                                    class="w-12 rounded-full cursor-pointer hover:ring-2 hover:ring-primary transition-all group relative overflow-hidden"
                                    onclick="document.getElementById('profile-image-input').click()"
                                    aria-label="{{ _('Change profile picture') }}">
                                    {% if current_user_avatar_thumbnail %}
                                    <img src="{{ current_user_avatar_thumbnail }}"
                                        alt="{{ _('Profile picture for %(email)s') % {'email': current_user.email} }}" />
                                    {% else %}
                                    <div class="flex h-full w-full items-center justify-center bg-base-300">
                                        <span class="mdi mdi-account text-2xl"></span>
                                    </div>
                                    {% endif %}
                                    <div
                                        class="absolute inset-0 flex items-center justify-center bg-black/40 opacity-0 group-hover:opacity-100 transition-opacity">
                                        <span class="mdi mdi-camera text-white text-lg"></span>
                                    </div>
                                </button>
                            </div>
                            <div>
                                <p class="text-sm font-semibold truncate max-w-[12rem]">{{ current_user.email }}</p>
                                <p class="text-xs opacity-60">{{ _('Signed in') }}</p>
                            </div>
                        </div>
                        <div class="space-y-4 border-b border-base-300 px-4 py-4">
                            <div class="space-y-2">
                                <label class="block mb-1 px-1">
                                    <span
                                        class="text-[10px] font-bold uppercase tracking-[0.1em] opacity-50 flex items-center gap-2">
                                        <span class="mdi mdi-translate text-xs"></span>
                                        {{ _('Language') }}
                                    </span>
                                </label>
                                {% include "shared/_language_selector.html" %}
                            </div>
                            <div class="space-y-2">
                                <label class="block mb-1 px-1">
                                    <span
                                        class="text-[10px] font-bold uppercase tracking-[0.1em] opacity-50 flex items-center gap-2">
                                        <span class="mdi mdi-palette-swatch text-xs"></span>
                                        {{ _('Appearance') }}
                                    </span>
                                </label>
                                <div class="join w-full bg-base-200 p-1 rounded-xl">
                                    <button type="button" id="theme-btn-light" onclick="setTheme('light')"
                                        class="btn btn-sm flex-1 border-none join-item rounded-lg transition-all h-8 min-h-8 text-xs font-bold gap-2">
                                        <span class="mdi mdi-weather-sunny"></span>
                                        {{ _('Light') }}
                                    </button>
                                    <button type="button" id="theme-btn-dark" onclick="setTheme('dark')"
                                        class="btn btn-sm flex-1 border-none join-item rounded-lg transition-all h-8 min-h-8 text-xs font-bold gap-2">
                                        <span class="mdi mdi-weather-night"></span>
                                        {{ _('Dark') }}
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="space-y-2 px-4 py-4">
                            <form action="/auth/logout" method="post">
                                <button type="submit" class="btn btn-ghost w-full justify-start text-error">
                                    <span class="mdi mdi-logout text-lg"></span>
                                    {{ _('Logout') }}
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
                {% else %}
                <div class="flex items-center gap-1 sm:gap-2">
                    <button type="button" onclick="toggleTheme()" class="btn btn-ghost btn-circle hover:bg-base-300 transition-all duration-300"
                        title="{{ _('Toggle theme') }}">
                        <span id="theme-icon-public" class="mdi mdi-weather-night text-xl"></span>
                    </button>
                    
                    <div class="hidden sm:block min-w-32">
                        {% set container_class = "bg-base-300/50 border border-base-300 rounded-full" %}
                        {% include "shared/_language_selector.html" %}
                    </div>

                    <div class="dropdown dropdown-end sm:hidden">
                        <button tabindex="0" role="button" class="btn btn-ghost btn-circle btn-sm">
                            <span class="mdi mdi-translate text-lg"></span>
                        </button>
                        <div tabindex="0"
                            class="dropdown-content p-2 shadow-xl bg-base-100 rounded-box w-48 border border-base-300 mt-2 z-[90]">
                            {% include "shared/_language_selector.html" %}
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</nav>
