<!DOCTYPE html>
<html lang="{{ current_language }}" class="h-full antialiased transition-colors duration-200">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}{{ _('Stricknani') }}{% endblock %}</title>
    {% block head %}{% endblock %}
    <link rel="icon" type="image/svg+xml"
        href="{% if is_dev_instance %}/static/favicon-dev.svg{% else %}/static/favicon.svg{% endif %}">
    <!-- renovate: datasource=npm depName=@mdi/font -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@mdi/font@7.4.47/css/materialdesignicons.min.css">
    <!-- renovate: datasource=npm depName=cropperjs -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cropperjs@1.6.1/dist/cropper.min.css">
    <!-- renovate: datasource=npm depName=photoswipe -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/photoswipe@5.4.4/dist/photoswipe.css">
    <!-- renovate: datasource=npm depName=cropperjs -->
    <script src="https://cdn.jsdelivr.net/npm/cropperjs@1.6.1/dist/cropper.min.js"></script>
    <script>
        // Theme initialization - MUST run before page renders
        (function () {
            let theme = localStorage.getItem('theme');
            if (!theme) {
                if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                    theme = 'dark';
                } else {
                    theme = 'light';
                }
            }
            document.documentElement.setAttribute('data-theme', theme);
            // Also set dark class for Tailwind dark mode
            if (theme === 'dark') {
                document.documentElement.classList.add('dark');
            }
        })();
    </script>


    <!-- renovate: datasource=npm depName=daisyui -->
    <link href="https://cdn.jsdelivr.net/npm/daisyui@5.5.16/daisyui.css" rel="stylesheet" type="text/css" />
    <link href="https://cdn.jsdelivr.net/npm/daisyui@5.5.16/themes.css" rel="stylesheet" type="text/css" />
    <!-- renovate: datasource=npm depName=tailwindcss -->
    <script src="https://unpkg.com/@tailwindcss/browser@4.1.18"></script>
    <!-- renovate: datasource=npm depName=htmx.org -->
    <script src="https://unpkg.com/htmx.org@2.0.7"></script>
    <style>
        .cropper-view-box,
        .cropper-face {
            border-radius: 50%;
        }

        .cropper-view-box {
            outline: 0;
            box-shadow: 0 0 0 1px #39f;
        }

        .markdown-inline-image {
            max-width: 250px;
            width: 100%;
            cursor: zoom-in;
            border-radius: 0.5rem;
            margin-top: 0.5rem;
            margin-bottom: 0.5rem;
        }

        input::placeholder,
        textarea::placeholder {
            color: color-mix(in srgb, currentColor 55%, transparent);
            font-style: italic;
        }

        .prose {
            line-height: 1.6;
        }

        .prose>*+* {
            margin-top: 0.75rem;
        }

        .prose h1,
        .prose h2,
        .prose h3,
        .prose h4,
        .prose h5,
        .prose h6 {
            font-weight: 700;
            line-height: 1.25;
            margin-top: 1.25rem;
            margin-bottom: 0.5rem;
        }

        .prose h1 {
            font-size: 1.35rem;
        }

        .prose h2 {
            font-size: 1.2rem;
        }

        .prose h3 {
            font-size: 1.05rem;
        }

        .prose h4 {
            font-size: 0.95rem;
        }

        .prose h5 {
            font-size: 0.9rem;
        }

        .prose h6 {
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.04em;
        }

        .prose ul,
        .prose ol {
            padding-left: 1.25rem;
            margin-top: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .prose ul {
            list-style: disc;
        }

        .prose ol {
            list-style: decimal;
        }

        .prose li+li {
            margin-top: 0.25rem;
        }

        .prose blockquote {
            border-left: 3px solid color-mix(in srgb, currentColor 20%, transparent);
            padding-left: 0.75rem;
            font-style: italic;
            color: color-mix(in srgb, currentColor 80%, transparent);
        }

        .prose code {
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
            font-size: 0.9em;
            background: color-mix(in srgb, currentColor 8%, transparent);
            padding: 0.1rem 0.3rem;
            border-radius: 0.35rem;
        }

        .prose pre {
            background: color-mix(in srgb, currentColor 8%, transparent);
            padding: 0.75rem 1rem;
            border-radius: 0.75rem;
            overflow-x: auto;
        }

        .prose pre code {
            background: transparent;
            padding: 0;
        }

        .prose a {
            color: color-mix(in srgb, currentColor 85%, #1d4ed8);
            text-decoration: underline;
        }

        .prose-compact {
            font-size: 0.95rem;
        }

        .prose-compact>*+* {
            margin-top: 0.6rem;
        }

        .prose-compact h1,
        .prose-compact h2,
        .prose-compact h3,
        .prose-compact h4,
        .prose-compact h5,
        .prose-compact h6 {
            margin-top: 1rem;
        }

        .prose-compact ul,
        .prose-compact ol {
            margin-top: 0.4rem;
            margin-bottom: 0.4rem;
        }

        .prose-compact pre {
            padding: 0.6rem 0.8rem;
        }

        .pswp__thumbs {
            position: absolute;
            left: 0;
            right: 0;
            bottom: calc(0.75rem + env(safe-area-inset-bottom, 0px));
            display: flex;
            gap: 0.5rem;
            justify-content: center;
            padding: 0.5rem 1rem;
            overflow-x: auto;
            pointer-events: auto;
            z-index: 15;
            background: linear-gradient(180deg, rgba(0, 0, 0, 0) 0%, rgba(0, 0, 0, 0.35) 100%);
        }

        .pswp__thumbs::-webkit-scrollbar {
            height: 6px;
        }

        .pswp__thumbs::-webkit-scrollbar-track {
            background: transparent;
        }

        .pswp__thumbs::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.35);
            border-radius: 999px;
        }

        .navbar-dropdown-content {
            max-height: calc(100vh - 4.5rem);
            max-width: min(90vw, 22rem);
            overflow-y: auto;
            overscroll-behavior: contain;
        }

        .navbar-dropdown-nav {
            margin-top: 0.25rem;
        }

        .navbar-dropdown-nav::before {
            height: 0.75rem;
            top: -0.75rem;
        }

        .ellipsis-dropdown-content {
            width: auto;
            min-width: 12rem;
            max-width: min(92vw, 20rem);
        }

        .ellipsis-dropdown-content :is(a, button) {
            padding: 0.7rem 1rem;
        }

        .badge {
            padding: 0.35rem 0.8rem;
        }

        @supports not (position-area: bottom) {
            .dropdown {
                position: relative;
            }

            .dropdown-content {
                position: absolute;
                top: 100%;
                left: 0;
            }

            .dropdown-end .dropdown-content {
                left: auto;
                right: 0;
            }

            .dropdown-start .dropdown-content {
                left: 0;
                right: auto;
            }

            .dropdown-top .dropdown-content {
                top: auto;
                bottom: 100%;
            }

            .dropdown-bottom .dropdown-content {
                top: 100%;
                bottom: auto;
            }
        }

        @media (max-width: 768px) {
            .dropdown {
                position: relative;
                position-area: auto !important;
            }

            .dropdown-content {
                position: absolute !important;
                inset: auto !important;
                top: 100% !important;
                left: 0 !important;
                right: auto !important;
                transform: none !important;
                margin-left: 0 !important;
                margin-right: 0 !important;
            }

            .dropdown-end .dropdown-content {
                left: auto !important;
                right: 0 !important;
            }

            .dropdown-start .dropdown-content {
                left: 0 !important;
                right: auto !important;
            }

            .dropdown-top .dropdown-content {
                top: auto !important;
                bottom: 100% !important;
            }

            .dropdown-bottom .dropdown-content {
                top: 100% !important;
                bottom: auto !important;
            }

            .ellipsis-dropdown-content {
                width: auto;
                min-width: 12rem;
                max-width: min(92vw, 20rem);
            }

            .navbar-dropdown-content {
                max-width: min(92vw, 22rem);
            }
        }


        .navbar-dropdown-content::before {
            content: "";
            position: absolute;
            left: 0;
            right: 0;
            top: -0.5rem;
            height: 0.5rem;
            background: transparent;
        }

        .pswp__thumb {
            width: 3.25rem;
            height: 3.25rem;
            border-radius: 0.6rem;
            border: 2px solid transparent;
            overflow: hidden;
            background: rgba(0, 0, 0, 0.25);
            padding: 0;
            flex: 0 0 auto;
            transition: transform 120ms ease, border-color 120ms ease, box-shadow 120ms ease;
        }

        .pswp__thumb img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

        .pswp__thumb:focus-visible {
            outline: 2px solid #fff;
            outline-offset: 2px;
        }

        .pswp__thumb.is-active {
            border-color: #fff;
            box-shadow: 0 0 0 2px rgba(0, 0, 0, 0.4);
            transform: scale(1.05);
        }

        /* PhotoSwipe Custom Button Styling */
        .pswp__button--promote-button,
        .pswp__button--delete-button,
        .pswp__button--download-button {
            overflow: visible !important;
        }

        .pswp__button--promote-button.is-primary .pswp__icn {
            color: #fbbf24 !important;
            /* amber-400 */
        }

        .pswp__button--delete-button .pswp__icn {
            color: #ef4444 !important;
            /* red-500 */
        }

        .pswp__button .pswp__icn.mdi {
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0.85;
        }

        .pswp__button:hover .pswp__icn.mdi {
            opacity: 1;
        }
    </style>
</head>

<body class="min-h-screen bg-base-300 flex flex-col">
    {% import "macros/dialogs.html" as dialogs %}

    {% block navbar %}
    {# Default navbar - pages can override this block #}
    {% endblock %}

    <main class="flex-grow w-full">
        {% block content %}{% endblock %}
    </main>

    <footer class="mt-8 py-4 text-center text-sm text-base-content/70 bg-base-100 border-t border-base-300">
        <span class="mdi mdi-yarn mr-1 align-middle"></span>{{ _('Stricknani') }} v0.1.0 | {{ _('GPL-3.0-only')
        }}
        <a href="https://github.com/pschmitt/stricknani" target="_blank" rel="noopener noreferrer"
            class="ml-2 text-base-content/70 hover:text-base-content" aria-label="GitHub">
            <span class="mdi mdi-github text-lg align-middle"></span>
        </a>
    </footer>

    {% if current_user %}
    <!-- Profile Image Upload Tools -->
    <input type="file" id="profile-image-input" class="hidden" accept="image/*">
    <dialog id="crop-modal" class="modal modal-bottom sm:modal-middle">
        <div class="modal-box max-w-lg">
            <h3 class="font-bold text-lg mb-4">{{ _('Crop Profile Picture') }}</h3>
            <div class="relative h-96 w-full rounded-lg bg-base-300 overflow-hidden">
                <img id="crop-image" src="" alt="Image to crop" class="max-h-full max-w-full">
            </div>
            <div class="modal-action">
                {{ dialogs.dialog_cancel(_('Cancel'), id='crop-cancel') }}
                {{ dialogs.dialog_primary(_('Save & Upload'), icon='mdi-cloud-upload', id='crop-save') }}
            </div>
        </div>
        {{ dialogs.modal_backdrop() }}
    </dialog>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            let cropper;
            const input = document.getElementById('profile-image-input');
            const modal = document.getElementById('crop-modal');
            const image = document.getElementById('crop-image');
            const saveBtn = document.getElementById('crop-save');
            const cancelBtn = document.getElementById('crop-cancel');
            let targetUserId = {{ current_user.id }};

            if (!input || !modal || !image || !saveBtn || !cancelBtn) {
                return;
            }

            window.triggerProfileImageUpload = function (userId) {
                targetUserId = userId || {{ current_user.id }};
                input.click();
            };

            input.addEventListener('change', function (e) {
                const files = e.target.files;
                if (files && files.length > 0) {
                    const file = files[0];
                    const reader = new FileReader();
                    reader.onload = function (readerEvent) {
                        image.src = readerEvent.target.result;
                        modal.showModal();

                        if (cropper) {
                            cropper.destroy();
                        }
                        cropper = new Cropper(image, {
                            aspectRatio: 1,
                            viewMode: 1,
                            dragMode: 'move',
                            autoCropArea: 1,
                            restore: false,
                            guides: false,
                            center: false,
                            highlight: false,
                            cropBoxMovable: false,
                            cropBoxResizable: false,
                            toggleDragModeOnDblclick: false,
                            zoomable: true,
                            zoomOnTouch: true,
                            zoomOnWheel: true,
                        });
                    };
                    reader.readAsDataURL(file);
                }
            });

            cancelBtn.addEventListener('click', function () {
                modal.close();
                input.value = '';
                if (cropper) {
                    cropper.destroy();
                    cropper = null;
                }
            });

            saveBtn.addEventListener('click', function () {
                if (!cropper) {
                    return;
                }

                const canvas = cropper.getCroppedCanvas({
                    width: 400,
                    height: 400,
                });

                canvas.toBlob(function (blob) {
                    if (!blob) {
                        showToast('{{ _("Failed to upload image") }}', 'error');
                        return;
                    }

                    const formData = new FormData();
                    formData.append('file', blob, 'avatar.png');

                    const originalText = saveBtn.textContent;
                    saveBtn.textContent = '{{ _("Uploading...") }}';
                    saveBtn.disabled = true;

                    const url = targetUserId === {{ current_user.id }}
                        ? '/user/profile-image'
                        : `/admin/users/${targetUserId}/profile-image`;

                    fetch(url, {
                        method: 'POST',
                        body: formData,
                        headers: {
                            'HX-Request': 'true'
                        }
                    })
                        .then(response => {
                            if (!response.ok) {
                                throw new Error('Upload failed');
                            }
                            return response.text();
                        })
                        .then(html => {
                            if (targetUserId === {{ current_user.id }}) {
                                window.location.reload();
                                return;
                            }

                            const card = document.getElementById(`user-card-${targetUserId}`);
                            if (card) {
                                const parser = new DOMParser();
                                const doc = parser.parseFromString(html, 'text/html');

                                const newCard = doc.getElementById(`user-card-${targetUserId}`);
                                if (newCard) {
                                    card.replaceWith(newCard);
                                    if (window.htmx) {
                                        window.htmx.process(newCard);
                                    }
                                }

                                const newCount = doc.getElementById('user-count');
                                const currentCount = document.getElementById('user-count');
                                if (newCount && currentCount) {
                                    currentCount.replaceWith(newCount);
                                }
                            }

                            modal.close();

                            const editUserDialog = document.getElementById('editUserDialog');
                            if (editUserDialog && editUserDialog.open) {
                                editUserDialog.close();
                            }

                            showToast('{{ _("Profile picture updated successfully") }}', 'success');
                        })
                        .catch(err => {
                            console.error(err);
                            showToast('{{ _("Failed to upload image") }}', 'error');
                        })
                        .finally(() => {
                            saveBtn.textContent = originalText;
                            saveBtn.disabled = false;
                        });
                }, 'image/png');
            });
        });
    </script>
    {% endif %}

    {% if current_user %}
    <dialog id="globalSearchModal" class="modal modal-top sm:modal-middle backdrop:bg-base-300/80 backdrop:backdrop-blur-sm">
        <div class="modal-box max-w-2xl p-0 overflow-hidden shadow-2xl border border-base-300 bg-base-100 rounded-2xl sm:mt-0 mt-4 mx-2 sm:mx-auto">
            <div class="relative flex items-center border-b border-base-300 px-4 py-2 bg-base-200/50">
                <span class="mdi mdi-magnify text-2xl opacity-40 mr-3"></span>
                <input type="text" id="globalSearchInput" 
                    name="q"
                    placeholder="{{ _('Search projects, yarns...') }}" 
                    class="input border-none bg-transparent w-full focus:outline-none focus:ring-0 px-0 h-12 text-lg font-medium"
                    hx-get="/search/global"
                    hx-trigger="keyup changed delay:300ms"
                    hx-target="#globalSearchResults"
                    hx-indicator="#globalSearchIndicator"
                    autocomplete="off">
                <div id="globalSearchIndicator" class="htmx-indicator ml-2">
                    <span class="loading loading-spinner loading-sm opacity-40"></span>
                </div>
                <div class="flex items-center gap-1 ml-auto shrink-0 pl-4">
                    <kbd class="kbd kbd-sm bg-base-300 border-base-content/10 font-bold opacity-60">ESC</kbd>
                </div>
            </div>
            <div id="globalSearchResults" class="max-h-[60vh] overflow-y-auto">
                <div class="py-12 text-center text-base-content/30 italic">
                    <span class="mdi mdi-keyboard-outline text-4xl block mb-2"></span>
                    <p>{{ _('Start typing to search...') }}</p>
                </div>
            </div>
            <div class="bg-base-200/50 px-4 py-2 text-[10px] font-bold uppercase tracking-widest opacity-40 flex justify-between border-t border-base-300">
                <span>{{ _('↑↓ to navigate') }}</span>
                <span>{{ _('Enter to select') }}</span>
            </div>
        </div>
        <form method="dialog" class="modal-backdrop">
            <button>close</button>
        </form>
    </dialog>

    <script>
        document.addEventListener('keydown', function(e) {
            // Ctrl+K or Cmd+K
            if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                e.preventDefault();
                const modal = document.getElementById('globalSearchModal');
                const input = document.getElementById('globalSearchInput');
                if (modal && !modal.open) {
                    modal.showModal();
                    setTimeout(() => input.focus(), 50);
                } else if (modal && modal.open) {
                    modal.close();
                }
            }
        });

        // 2-finger swipe down to open search on mobile
        (function() {
            let touchStartY = 0;
            let isTwoFinger = false;

            document.addEventListener('touchstart', function(e) {
                if (e.touches.length === 2) {
                    isTwoFinger = true;
                    touchStartY = (e.touches[0].pageY + e.touches[1].pageY) / 2;
                } else {
                    isTwoFinger = false;
                }
            }, { passive: true });

            document.addEventListener('touchend', function(e) {
                if (isTwoFinger) {
                    const touchEndY = (e.changedTouches[0].pageY + (e.changedTouches[1] ? e.changedTouches[1].pageY : e.changedTouches[0].pageY)) / 2;
                    const swipeDistance = touchEndY - touchStartY;
                    
                    // If swiped down more than 100px
                    if (swipeDistance > 100) {
                        const modal = document.getElementById('globalSearchModal');
                        const input = document.getElementById('globalSearchInput');
                        if (modal && !modal.open) {
                            modal.showModal();
                            setTimeout(() => input.focus(), 50);
                        }
                    }
                }
                isTwoFinger = false;
            }, { passive: true });
        })();

        // Focus search input when modal is opened via other means (if any)
        document.getElementById('globalSearchModal')?.addEventListener('show', () => {
            setTimeout(() => document.getElementById('globalSearchInput')?.focus(), 50);
        });

        // Navigation within search results using arrow keys
        document.getElementById('globalSearchInput')?.addEventListener('keydown', function(e) {
            if (['ArrowDown', 'ArrowUp', 'Enter'].includes(e.key)) {
                const results = document.querySelectorAll('#globalSearchResults a');
                if (results.length === 0) return;

                let activeIndex = Array.from(results).findIndex(el => el.classList.contains('bg-primary/10'));

                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    results.forEach(el => el.classList.remove('bg-primary/10'));
                    activeIndex = (activeIndex + 1) % results.length;
                    results[activeIndex].classList.add('bg-primary/10');
                    results[activeIndex].scrollIntoView({ block: 'nearest' });
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    results.forEach(el => el.classList.remove('bg-primary/10'));
                    activeIndex = (activeIndex - 1 + results.length) % results.length;
                    results[activeIndex].classList.add('bg-primary/10');
                    results[activeIndex].scrollIntoView({ block: 'nearest' });
                } else if (e.key === 'Enter') {
                    if (activeIndex >= 0) {
                        e.preventDefault();
                        results[activeIndex].click();
                    }
                }
            }
        });
    </script>
    {% endif %}

    <div id="toastContainer"
        class="fixed inset-x-4 top-4 z-[10000] mx-auto flex max-w-sm flex-col gap-3 sm:inset-auto sm:right-4 sm:top-4 sm:w-80"
        aria-live="polite" aria-atomic="true"></div>

    <dialog id="confirmationDialog" class="modal modal-bottom sm:modal-middle">
        <div class="modal-box">
            <h3 class="font-bold text-lg" id="confirmationTitle">{{ _('Confirm Action') }}</h3>
            <p class="py-4" id="confirmationMessage">{{ _('Are you sure you want to proceed?') }}</p>
            <div class="modal-action">
                <form method="dialog">
                    {{ dialogs.dialog_cancel(_('Cancel'), type='submit', id='confirmationCancel') }}
                    {{ dialogs.dialog_danger(_('Confirm'), icon='mdi-trash-can-outline', type='button',
                    id='confirmationConfirm') }}
                </form>
            </div>
        </div>
        {{ dialogs.modal_backdrop() }}
    </dialog>

    <script>
        window.confirmAction = (title, message, onConfirm) => {
            const dialog = document.getElementById('confirmationDialog');
            const titleEl = document.getElementById('confirmationTitle');
            const messageEl = document.getElementById('confirmationMessage');
            const confirmBtn = document.getElementById('confirmationConfirm');

            if (!dialog || !titleEl || !messageEl || !confirmBtn) return;

            titleEl.textContent = title;
            messageEl.textContent = message;

            // Remove old listeners to avoid stacking
            const newConfirmBtn = confirmBtn.cloneNode(true);
            confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);

            newConfirmBtn.addEventListener('click', () => {
                onConfirm();
                dialog.close();
            });

            dialog.showModal();
        };

        const toastVariants = {
            success: "bg-emerald-500/90 text-white",
            error: "bg-red-600/90 text-white",
            info: "bg-slate-900/90 text-white",
        };

        const toastContainer = document.getElementById("toastContainer");

        window.showToast = (message, variant = "info") => {
            if (!toastContainer || !message) {
                return;
            }

            toastContainer.replaceChildren();
            const toast = document.createElement("div");
            toast.className = `rounded-lg px-4 py-3 shadow-lg ring-1 ring-black/10 backdrop-blur transition duration-200 ease-out opacity-0 translate-y-2 hover:translate-y-1 ${toastVariants[variant] || toastVariants.info
                }`;
            toast.setAttribute("role", "status");
            toast.innerHTML = `
                <div class="flex items-start gap-3">
                    <span class="mdi ${variant === "success"
                    ? "mdi-check-circle"
                    : variant === "error"
                        ? "mdi-alert-circle"
                        : "mdi-information"
                } text-lg"></span>
                    <p class="text-sm leading-snug">${message}</p>
                    <button type="button" class="ml-auto text-white/80 transition hover:text-white" aria-label="{{ _('Dismiss message') }}">
                        <span class="mdi mdi-close"></span>
                    </button>
                </div>
            `;

            const closeButton = toast.querySelector("button");
            closeButton?.addEventListener("click", () => {
                toast.classList.add("opacity-0", "translate-y-2");
                setTimeout(() => toast.remove(), 200);
            });

            toastContainer.appendChild(toast);
            requestAnimationFrame(() => {
                requestAnimationFrame(() => {
                    toast.classList.remove("opacity-0", "translate-y-2");
                });
            });

            setTimeout(() => {
                if (!toast.isConnected) {
                    return;
                }
                toast.classList.add("opacity-0", "translate-y-2");
                setTimeout(() => toast.remove(), 200);
            }, 5000);
        };

        window.openPhotoSwipeIndex = (trigger) => {
            if (!trigger) {
                return;
            }
            const gallery = trigger.closest('[data-pswp-gallery]');
            if (!gallery) {
                return;
            }
            const raw = trigger.getAttribute('data-pswp-open-index') || '0';
            const index = Number.parseInt(raw, 10);
            const targetIndex = Number.isNaN(index) ? 0 : index;
            const anchors = Array.from(
                gallery.querySelectorAll('a[data-pswp-width]'),
            );
            const target = anchors[targetIndex];
            if (target) {
                target.click();
            }
        };

        const extractErrorMessage = async (response, fallback) => {
            const defaultMessage = fallback || "{{ _('Something went wrong. Please try again') }}";
            if (!response) {
                return defaultMessage;
            }

            const isFetchResponse = typeof response.clone === "function";
            const contentType = isFetchResponse
                ? response.headers?.get("content-type") || ""
                : typeof response.getResponseHeader === "function"
                    ? response.getResponseHeader("content-type") || ""
                    : "";

            try {
                if (contentType.includes("application/json")) {
                    if (isFetchResponse) {
                        const data = await response.clone().json();
                        if (typeof data?.detail === "string" && data.detail.trim()) {
                            return data.detail;
                        }
                        if (typeof data?.message === "string" && data.message.trim()) {
                            return data.message;
                        }
                    } else if (response.responseText) {
                        const data = JSON.parse(response.responseText);
                        if (typeof data?.detail === "string" && data.detail.trim()) {
                            return data.detail;
                        }
                        if (typeof data?.message === "string" && data.message.trim()) {
                            return data.message;
                        }
                    }
                } else if (isFetchResponse) {
                    const text = await response.clone().text();
                    if (text.trim()) {
                        return text.trim();
                    }
                } else if (response.responseText) {
                    const text = response.responseText;
                    if (text && text.trim()) {
                        return text.trim();
                    }
                }
            } catch (error) {
                console.error("Failed to parse error response", error);
            }

            return defaultMessage;
        };

        document.addEventListener("DOMContentLoaded", () => {
            const urlParams = new URLSearchParams(window.location.search);
            const toastKey = urlParams.get('toast');
            if (toastKey) {
                const toastMessages = {
                    'project_created': '{{ _("Project created successfully") }}',
                    'project_updated': '{{ _("Project updated successfully") }}',
                    'project_deleted': '{{ _("Project deleted") }}',
                    'yarn_created': '{{ _("Yarn created successfully") }}',
                    'yarn_updated': '{{ _("Yarn updated successfully") }}',
                    'yarn_deleted': '{{ _("Yarn deleted") }}',
                    'profile_updated': '{{ _("Profile updated successfully") }}',
                    'category_created': '{{ _("Category created") }}',
                    'category_updated': '{{ _("Category updated") }}',
                    'category_deleted': '{{ _("Category deleted") }}',
                };

                                const message = toastMessages[toastKey];

                                if (message) {

                                    window.showToast?.(message, 'success');

                                    const url = new URL(window.location.href);

                                    url.searchParams.delete('toast');

                                    window.history.replaceState({}, '', url.toString());

                                }

                            }

                

                            const closeDropdowns = () => {
                                document.querySelectorAll('.dropdown').forEach(d => {
                                    d.blur();
                                });

                                if (document.activeElement instanceof HTMLElement) {
                                    const activeDropdown = document.activeElement.closest('.dropdown');
                                    if (activeDropdown) {
                                        document.activeElement.blur();
                                    }
                                }
                            };

                            // Close all daisyUI dropdowns on escape
                            document.addEventListener('keydown', (e) => {
                                if (e.key === 'Escape') {
                                    closeDropdowns();
                                }
                            });

                            // Close dropdowns when clicking outside
                            document.addEventListener('click', (e) => {
                                if (!e.target.closest('.dropdown')) {
                                    closeDropdowns();
                                }
                            });

                

                            // Mobile menu logic handled by DaisyUI drawer (CSS only)

                
        });

        // Theme management functionality
        function setTheme(newTheme) {
            const html = document.documentElement;
            html.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);

            if (newTheme === 'dark') {
                html.classList.add('dark');
            } else {
                html.classList.remove('dark');
            }

            updateThemeUI(newTheme);
        }

        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            setTheme(newTheme);
        }

        function updateThemeUI(theme) {
            const isDark = theme === 'dark';
            const label = document.getElementById('theme-label');
            const icon = document.getElementById('theme-icon');
            const iconPublic = document.getElementById('theme-icon-public');
            
            // Update segmented control buttons if they exist
            const lightBtn = document.getElementById('theme-btn-light');
            const darkBtn = document.getElementById('theme-btn-dark');

            if (label) {
                label.textContent = isDark ? '{{ _('Dark Mode') }}' : '{{ _('Light Mode') }}';
            }

            const iconClass = isDark ? 'mdi-weather-night' : 'mdi-weather-sunny';
            const iconColor = isDark ? 'text-blue-400' : 'text-amber-500';

            if (icon) {
                icon.className = `mdi ${iconClass} text-xl transition-all duration-300 ${iconColor}`;
            }

            if (iconPublic) {
                iconPublic.className = `mdi ${iconClass} text-xl transition-all duration-300 ${iconColor}`;
            }

            if (lightBtn && darkBtn) {
                if (isDark) {
                    darkBtn.classList.add('bg-base-100', 'shadow-sm', 'text-primary');
                    darkBtn.classList.remove('btn-ghost', 'opacity-60');
                    lightBtn.classList.remove('bg-base-100', 'shadow-sm', 'text-primary');
                    lightBtn.classList.add('btn-ghost', 'opacity-60');
                } else {
                    lightBtn.classList.add('bg-base-100', 'shadow-sm', 'text-primary');
                    lightBtn.classList.remove('btn-ghost', 'opacity-60');
                    darkBtn.classList.remove('bg-base-100', 'shadow-sm', 'text-primary');
                    darkBtn.classList.add('btn-ghost', 'opacity-60');
                }
            }
        }

        // Initialize theme UI on page load
        document.addEventListener('DOMContentLoaded', () => {
            const currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
            updateThemeUI(currentTheme);
        });

        document.body.addEventListener("htmx:responseError", async (event) => {
            const fallback = "{{ _('Something went wrong. Please try again') }}";
            const message = await extractErrorMessage(event.detail.xhr, fallback);
            showToast(message, "error");
        });

        document.body.addEventListener("htmx:afterRequest", (event) => {
            const element = event.detail?.requestConfig?.elt || event.detail?.elt;
            if (!element) {
                return;
            }
            const status = event.detail?.xhr?.status ?? 200;
            if (status >= 400) {
                return;
            }
            const toastElement =
                element.getAttribute("data-toast-message") !== null
                    ? element
                    : element.querySelector?.("[data-toast-message]");
            if (!toastElement) {
                return;
            }
            const message = toastElement.getAttribute("data-toast-message");
            if (!message) {
                return;
            }
            const variant = toastElement.getAttribute("data-toast-variant") || "info";
            if (window.showToast) {
                window.showToast(message, variant);
            }
            const dialogId = element.getAttribute("data-dialog-close");
            if (dialogId) {
                closeDialog(dialogId);
            }
        });

        function resolveDialog(dialogOrId) {
            if (typeof dialogOrId === "string") {
                return document.getElementById(dialogOrId);
            }
            return dialogOrId;
        }

        function openDialog(dialogOrId) {
            console.log('openDialog called with:', dialogOrId);
            const dialog = resolveDialog(dialogOrId);
            if (!dialog) {
                console.error('Dialog not found:', dialogOrId);
                return false;
            }
            if (typeof dialog.showModal === "function") {
                if (!dialog.open) {
                    console.log('Calling showModal on dialog');
                    dialog.showModal();
                } else {
                    console.log('Dialog is already open');
                }
                return true;
            }
            console.log('Fallback to legacy open attribute');
            dialog.setAttribute("open", "");
            dialog.style.display = "block";
            dialog.setAttribute("aria-modal", "true");
            return true;
        }

        function closeDialog(dialogOrId) {
            const dialog = resolveDialog(dialogOrId);
            if (!dialog) {
                return false;
            }
            if (typeof dialog.close === "function") {
                dialog.close();
                return true;
            }
            dialog.removeAttribute("open");
            dialog.style.display = "none";
            return true;
        }

        window.openDialog = openDialog;
        window.closeDialog = closeDialog;

        async function copyToClipboard(text, btn) {
            try {
                await navigator.clipboard.writeText(text);
                const originalContent = btn.innerHTML;
                btn.innerHTML = '<span class="mdi mdi-check text-success"></span>';
                btn.classList.add('btn-success', 'bg-success/10');
                
                window.showToast?.('{{ _("Copied to clipboard") }}', 'success');
                
                setTimeout(() => {
                    btn.innerHTML = originalContent;
                    btn.classList.remove('btn-success', 'bg-success/10');
                }, 2000);
            } catch (err) {
                console.error('Failed to copy: ', err);
                window.showToast?.('{{ _("Failed to copy") }}', 'error');
            }
        }
        window.copyToClipboard = copyToClipboard;
    </script>
    <script type="module">
        import PhotoSwipeLightbox from 'https://cdn.jsdelivr.net/npm/photoswipe@5.4.4/dist/photoswipe-lightbox.esm.min.js';

        const lightboxes = window.pswpLightboxes || new Map();
        window.pswpLightboxes = lightboxes;
        const pswpThumbsLabel = "{{ _('Gallery thumbnails') }}";
        const pswpThumbActionLabel = "{{ _('Open image') }}";

        const initGallery = (gallery) => {
            if (!gallery) {
                return null;
            }
            const existing = lightboxes.get(gallery);
            if (existing) {
                return existing;
            }
            const lightbox = new PhotoSwipeLightbox({
                gallery,
                children: 'a[data-pswp-width]',
                pswpModule: () => import('https://cdn.jsdelivr.net/npm/photoswipe@5.4.4/dist/photoswipe.esm.min.js'),
            });
            lightbox.on('uiRegister', () => {
                if (!lightbox.pswp?.ui) {
                    return;
                }
                const pswp = lightbox.pswp;

                // Register Thumbs
                pswp.ui.registerElement({
                    name: 'thumbs',
                    order: 9,
                    isButton: false,
                    appendTo: 'root',
                    onInit: (el, pswp) => {
                        el.classList.add('pswp__thumbs');
                        el.setAttribute('aria-label', pswpThumbsLabel);
                        el.setAttribute('role', 'toolbar');

                        const buildItems = () => {
                            const count = typeof pswp.getNumItems === 'function'
                                ? pswp.getNumItems()
                                : (pswp.options?.dataSource?.length || pswp.options?.dataSource?.items?.length || 0);
                            el.innerHTML = '';
                            if (!count || count <= 1) {
                                return;
                            }
                            const fragment = document.createDocumentFragment();
                            for (let index = 0; index < count; index += 1) {
                                const item = typeof pswp.getItemData === 'function'
                                    ? pswp.getItemData(index)
                                    : pswp.options?.dataSource?.[index]
                                    || pswp.options?.dataSource?.items?.[index]
                                    || {};
                                const thumbSrc = item?.msrc || item?.src;
                                if (!thumbSrc) {
                                    continue;
                                }
                                const button = document.createElement('button');
                                button.type = 'button';
                                button.className = 'pswp__thumb';
                                button.setAttribute('aria-label', `${pswpThumbActionLabel} ${index + 1}`);
                                button.setAttribute('data-pswp-thumb-index', `${index}`);
                                const img = document.createElement('img');
                                img.src = thumbSrc;
                                img.alt = item?.alt || item?.title || '';
                                button.appendChild(img);
                                button.addEventListener('click', () => {
                                    pswp.goTo(index);
                                });
                                fragment.appendChild(button);
                            }
                            el.appendChild(fragment);
                        };

                        const updateActive = () => {
                            const activeIndex = pswp.currIndex || 0;
                            el.querySelectorAll('[data-pswp-thumb-index]').forEach((button) => {
                                const buttonIndex = Number.parseInt(button.getAttribute('data-pswp-thumb-index') || '0', 10);
                                button.classList.toggle('is-active', buttonIndex === activeIndex);
                            });
                        };

                        buildItems();
                        updateActive();
                        pswp.on('change', updateActive);
                    },
                });

                // Register "Set as primary" button
                pswp.ui.registerElement({
                    name: 'promote-button',
                    ariaLabel: '{{ _("Set as primary") }}',
                    order: 9,
                    isButton: true,
                    html: '<span class="pswp__icn mdi mdi-star"></span>',
                    appendTo: 'bar',
                    onClick: (event, el) => {
                        const item = pswp.currItem;
                        const element = item?.element || item?.data?.element || pswp.currSlide?.data?.element;
                        if (element) {
                            const customEvent = new CustomEvent('pswp:promote', {
                                detail: { element },
                                bubbles: true
                            });
                            element.dispatchEvent(customEvent);
                        }
                    },
                    onInit: (el, pswp) => {
                        const update = () => {
                            const item = pswp.currItem;
                            const element = item?.element || item?.data?.element || pswp.currSlide?.data?.element;
                            const isPromotable = element?.hasAttribute('data-pswp-promote');
                            const isAlreadyPrimary = element?.getAttribute('data-pswp-is-primary') === 'true';

                            el.style.display = isPromotable ? 'inline-flex' : 'none';
                            el.classList.toggle('is-primary', isAlreadyPrimary);
                        };
                        pswp.on('change', update);
                        pswp.on('afterInit', update);
                    }
                });

                // Register Delete button
                pswp.ui.registerElement({
                    name: 'delete-button',
                    ariaLabel: '{{ _("Delete image") }}',
                    order: 8,
                    isButton: true,
                    html: '<span class="pswp__icn mdi mdi-delete"></span>',
                    appendTo: 'bar',
                    onClick: (event, el) => {
                        const item = pswp.currItem;
                        const element = item?.element || item?.data?.element || pswp.currSlide?.data?.element;
                        if (element) {
                            const customEvent = new CustomEvent('pswp:delete', {
                                detail: { element },
                                bubbles: true
                            });
                            element.dispatchEvent(customEvent);
                        }
                    },
                    onInit: (el, pswp) => {
                        const update = () => {
                            const item = pswp.currItem;
                            const element = item?.element || item?.data?.element || pswp.currSlide?.data?.element;
                            const isDeletable = element?.hasAttribute('data-pswp-delete');
                            el.style.display = isDeletable ? 'inline-flex' : 'none';
                        };
                        pswp.on('change', update);
                        pswp.on('afterInit', update);
                    }
                });

                // Register Download button
                pswp.ui.registerElement({
                    name: 'download-button',
                    ariaLabel: '{{ _("Download image") }}',
                    order: 7,
                    isButton: true,
                    tagName: 'a',
                    html: '<span class="pswp__icn mdi mdi-download"></span>',
                    appendTo: 'bar',
                    onInit: (el, pswp) => {
                        el.setAttribute('download', '');
                        el.setAttribute('target', '_blank');
                        el.setAttribute('rel', 'noopener');

                        pswp.on('change', () => {
                            el.href = pswp.currSlide.data.src;
                        });
                    }
                });
            });
            lightbox.init();
            lightboxes.set(gallery, lightbox);
            return lightbox;
        };

        window.initPhotoSwipeGallery = initGallery;
        window.refreshPhotoSwipeGallery = (gallery) => {
            const instance = initGallery(gallery);
            if (instance) {
                if (typeof instance.refresh === 'function') {
                    instance.refresh();
                } else if (typeof instance.destroy === 'function') {
                    instance.destroy();
                    lightboxes.delete(gallery);
                    return initGallery(gallery);
                }
            }
            return instance;
        };

        const initAll = () => {
            document.querySelectorAll('[data-pswp-gallery]').forEach((gallery) => {
                initGallery(gallery);
            });
        };

        const markdownLightboxes = new Map();
        const openMarkdownLightbox = (image) => {
            if (!image) {
                return;
            }
            const group = image.getAttribute('data-lightbox-group') || 'markdown';
            const images = Array.from(
                document.querySelectorAll(`img.markdown-inline-image[data-lightbox-group="${group}"]`),
            );
            if (!images.length) {
                return;
            }

            const items = images.map((img) => {
                const src = img.getAttribute('data-lightbox-src') || img.src;
                const alt = img.getAttribute('data-lightbox-alt') || img.alt || '';
                const width = img.naturalWidth || 1200;
                const height = img.naturalHeight || 1200;
                return {
                    src,
                    msrc: img.src,
                    width,
                    height,
                    alt,
                    title: alt,
                    element: img,
                };
            });

            const index = Math.max(0, images.indexOf(image));
            const existing = markdownLightboxes.get(group);
            if (existing) {
                existing.destroy();
                markdownLightboxes.delete(group);
            }

            const lightbox = new PhotoSwipeLightbox({
                dataSource: items,
                pswpModule: () => import('https://cdn.jsdelivr.net/npm/photoswipe@5.4.4/dist/photoswipe.esm.min.js'),
            });
            lightbox.on('close', () => {
                lightbox.destroy();
                markdownLightboxes.delete(group);
            });
            lightbox.init();
            markdownLightboxes.set(group, lightbox);
            lightbox.loadAndOpen(index);
        };

        const openAtIndex = (trigger) => {
            const gallery = trigger.closest('[data-pswp-gallery]');
            if (!gallery) {
                return;
            }
            const raw = trigger.getAttribute('data-pswp-open-index') || '0';
            const index = Number.parseInt(raw, 10);
            const targetIndex = Number.isNaN(index) ? 0 : index;
            const anchors = Array.from(
                gallery.querySelectorAll('a[data-pswp-width]'),
            );
            const target = anchors[targetIndex];
            if (target) {
                target.click();
                return;
            }
            const lightbox = window.refreshPhotoSwipeGallery(gallery);
            if (lightbox) {
                lightbox.loadAndOpen(0, gallery);
            }
        };

        window.openPhotoSwipeIndex = (trigger) => {
            if (!trigger) {
                return;
            }
            openAtIndex(trigger);
        };

        document.addEventListener('click', (event) => {
            const markdownImage = event.target.closest('img.markdown-inline-image');
            if (markdownImage) {
                event.preventDefault();
                event.stopPropagation();
                openMarkdownLightbox(markdownImage);
                return;
            }
            const trigger = event.target.closest('[data-pswp-open-index]');
            if (!trigger) {
                return;
            }
            event.preventDefault();
            event.stopPropagation();
            openAtIndex(trigger);
        });

        document.addEventListener('DOMContentLoaded', () => {
            initAll();
        });
    </script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const navDropdowns = document.querySelectorAll('.navbar-nav-dropdown');
            if (!navDropdowns.length) {
                return;
            }

            navDropdowns.forEach((dropdown) => {
                let closeTimer;
                const openDropdown = () => {
                    if (closeTimer) {
                        clearTimeout(closeTimer);
                        closeTimer = null;
                    }
                    dropdown.classList.add('dropdown-open');
                };
                const scheduleClose = () => {
                    if (closeTimer) {
                        clearTimeout(closeTimer);
                    }
                    closeTimer = setTimeout(() => {
                        if (dropdown.matches(':hover')) {
                            return;
                        }
                        if (dropdown.contains(document.activeElement)) {
                            return;
                        }
                        dropdown.classList.remove('dropdown-open');
                    }, 250);
                };

                dropdown.addEventListener('mouseenter', openDropdown);
                dropdown.addEventListener('mouseleave', scheduleClose);
                dropdown.addEventListener('focusin', openDropdown);
                dropdown.addEventListener('focusout', scheduleClose);
            });
        });
    </script>
</body>

</html>
