<!DOCTYPE html>
<html lang="{{ current_language }}" class="h-full antialiased transition-colors duration-200">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}{{ _('Stricknani') }}{% endblock %}</title>
    {% block head %}{% endblock %}
    <link rel="icon" type="image/svg+xml" href="{% if is_dev_instance %}/static/favicon-dev.svg{% else %}/static/favicon.svg{% endif %}">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@mdi/font@7.4.47/css/materialdesignicons.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cropperjs@1.6.1/dist/cropper.min.css">
    <script src="https://cdn.jsdelivr.net/npm/cropperjs@1.6.1/dist/cropper.min.js"></script>
    <script>
        // Theme initialization - MUST run before page renders
        (function() {
            let theme = localStorage.getItem('theme');
            if (!theme) {
                if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                    theme = 'dark';
                } else {
                    theme = 'light';
                }
            }
            document.documentElement.setAttribute('data-theme', theme);
            // Also set dark class for Tailwind dark mode
            if (theme === 'dark') {
                document.documentElement.classList.add('dark');
            }
        })();
    </script>

    <script>
        // Configure Tailwind and DaisyUI BEFORE loading them
        window.tailwind = window.tailwind || {};
        window.tailwind.config = {
            darkMode: 'class',
            daisyui: {
                themes: ["light", "dark"],
                darkTheme: "dark",
                base: true,
                styled: true,
                utils: true,
            }
        }
    </script>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.12.14/dist/full.min.css" rel="stylesheet" type="text/css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <style>
        .cropper-view-box,
        .cropper-face {
            border-radius: 50%;
        }
        .cropper-view-box {
            outline: 0;
            box-shadow: 0 0 0 1px #39f;
        }
        .markdown-inline-image {
            max-width: 250px;
            width: 100%;
            cursor: zoom-in;
            border-radius: 0.5rem;
            margin-top: 0.5rem;
            margin-bottom: 0.5rem;
        }
        input::placeholder,
        textarea::placeholder {
            color: color-mix(in srgb, currentColor 55%, transparent);
            font-style: italic;
        }
    </style>
</head>
<body class="min-h-screen bg-base-100">
    <div class="drawer">
        <input id="main-drawer" type="checkbox" class="drawer-toggle" />
        <div class="drawer-content flex flex-col min-h-screen">
            <nav class="navbar bg-base-200 shadow-sm border-b border-base-300">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 w-full">
            <div class="flex justify-between h-16 w-full">
                <div class="flex items-center space-x-2 md:space-x-8">
                    <label for="main-drawer" class="btn btn-ghost drawer-button md:hidden" aria-label="{{ _('Open main menu') }}">
                        <span class="mdi mdi-menu text-2xl"></span>
                    </label>
                    <a href="/" class="text-xl font-bold hover:text-primary inline-flex items-center gap-2">
                        <img src="{% if is_dev_instance %}/static/favicon-dev.svg{% else %}/static/favicon.svg{% endif %}" alt="" class="h-6 w-6" />
                        <span class="mdi mdi-yarn text-primary"></span>
                        {{ _('Stricknani') }}
                    </a>
                    <div class="hidden md:flex space-x-4">
                        {% set current_path = request.url.path %}
                        {% if current_user %}
                        <a href="/projects" class="btn btn-ghost {% if current_path.startswith('/projects') %}btn-active{% endif %}">
                            <span class="mdi mdi-folder-outline"></span>
                            {{ _('Projects') }}
                        </a>
                        <a href="/yarn" class="btn btn-ghost {% if current_path.startswith('/yarn') %}btn-active{% endif %}">
                            <span class="mdi mdi-sheep"></span>
                            {{ _('Yarns') }}
                        </a>
                        {% endif %}
                        <a href="/gauge" class="btn btn-ghost {% if current_path.startswith('/gauge') %}btn-active{% endif %}">
                            <span class="mdi mdi-ruler"></span>
                            {{ _('Gauge Calculator') }}
                        </a>
                        {% if current_user and current_user.is_admin %}
                        <a href="/admin/users" class="btn btn-ghost {% if current_path.startswith('/admin') %}btn-active{% endif %}">
                            <span class="mdi mdi-shield-account"></span>
                            {{ _('Admin') }}
                        </a>
                        {% endif %}
                    </div>
                </div>
                <div class="flex items-center">
                    {% if current_user %}
                    <div class="dropdown dropdown-end" data-user-menu>
                        <button
                            type="button"
                            class="btn btn-ghost btn-circle avatar"
                            data-user-menu-trigger
                            tabindex="0"
                        >
                            {% if current_user_avatar_thumbnail %}
                            <div class="w-10 rounded-full">
                                <img src="{{ current_user_avatar_thumbnail }}" alt="{{ _('Profile picture for %(email)s') % {'email': current_user.email} }}" />
                            </div>
                            {% else %}
                            <span class="mdi mdi-account-circle text-3xl"></span>
                            {% endif %}
                        </button>
                        <div
                            class="dropdown-content menu bg-base-100 rounded-box z-50 w-72 p-0 shadow-xl border border-base-300"
                            data-user-menu-panel
                            tabindex="0"
                        >
                            <div class="flex items-center gap-3 border-b border-base-300 px-4 py-3">
                                <div class="avatar">
                                    <div class="w-12 rounded-full cursor-pointer hover:ring-2 hover:ring-primary transition-all group relative" onclick="document.getElementById('profile-image-input').click()">
                                        {% if current_user_avatar_thumbnail %}
                                        <img src="{{ current_user_avatar_thumbnail }}" alt="{{ _('Profile picture for %(email)s') % {'email': current_user.email} }}" />
                                        {% else %}
                                        <div class="flex h-full w-full items-center justify-center bg-base-300">
                                            <span class="mdi mdi-account text-2xl"></span>
                                        </div>
                                        {% endif %}
                                        <div class="absolute inset-0 flex items-center justify-center bg-black/40 opacity-0 group-hover:opacity-100 transition-opacity rounded-full">
                                            <span class="mdi mdi-camera text-white text-lg"></span>
                                        </div>
                                    </div>
                                </div>
                                <div>
                                    <p class="text-sm font-semibold">{{ current_user.email }}</p>
                                    <p class="text-xs opacity-60">{{ _('Signed in') }}</p>
                                </div>
                            </div>
                            <div class="space-y-4 border-b border-base-300 px-4 py-4">
                                <div class="space-y-2">
                                    <label class="label">
                                        <span class="label-text text-xs font-semibold uppercase tracking-wide opacity-60 flex items-center gap-2">
                                            <span class="mdi mdi-translate"></span>
                                            {{ _('Language') }}
                                        </span>
                                    </label>
                                    <div class="grid grid-cols-2 gap-2">
                                        <form action="/auth/set-language" method="post" class="block">
                                            <input type="hidden" name="next" value="{{ request.url.path }}{% if request.url.query %}?{{ request.url.query }}{% endif %}">
                                            <input type="hidden" name="language" value="en">
                                            <button type="submit" class="btn btn-sm w-full {% if current_language == 'en' %}btn-primary{% else %}btn-outline{% endif %}">
                                                ðŸ‡¬ðŸ‡§ EN
                                            </button>
                                        </form>
                                        <form action="/auth/set-language" method="post" class="block">
                                            <input type="hidden" name="next" value="{{ request.url.path }}{% if request.url.query %}?{{ request.url.query }}{% endif %}">
                                            <input type="hidden" name="language" value="de">
                                            <button type="submit" class="btn btn-sm w-full {% if current_language == 'de' %}btn-primary{% else %}btn-outline{% endif %}">
                                                ðŸ‡©ðŸ‡ª DE
                                            </button>
                                        </form>
                                    </div>
                                </div>
                                <div class="space-y-2">
                                    <label class="label">
                                        <span class="label-text text-xs font-semibold uppercase tracking-wide opacity-60 flex items-center gap-2">
                                            <span class="mdi mdi-theme-light-dark"></span>
                                            {{ _('Theme') }}
                                        </span>
                                    </label>
                                    <button type="button" onclick="toggleTheme()" class="btn btn-outline w-full justify-between">
                                        <span id="theme-label">{{ _('Dark') }}</span>
                                        <span id="theme-icon" class="mdi mdi-weather-night text-lg"></span>
                                    </button>
                                </div>
                            </div>
                            <div class="space-y-2 px-4 py-4">
                                <form action="/auth/logout" method="post">
                                    <button type="submit" class="btn btn-ghost w-full justify-start text-error">
                                        <span class="mdi mdi-logout text-lg"></span>
                                        {{ _('Logout') }}
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                    {% else %}
                    <div class="hidden md:flex items-center space-x-2">
                        <button type="button" onclick="toggleTheme()" class="btn btn-ghost btn-circle" title="{{ _('Toggle theme') }}">
                            <span id="theme-icon-public" class="mdi mdi-weather-night text-xl"></span>
                        </button>
                        <div class="dropdown dropdown-end">
                            <div tabindex="0" role="button" class="btn btn-ghost btn-sm gap-1 px-2">
                                <span class="mdi mdi-translate text-lg"></span>
                                <span class="uppercase font-semibold text-xs">{{ current_language }}</span>
                                <span class="mdi mdi-chevron-down text-xs opacity-50"></span>
                            </div>
                            <ul tabindex="0" class="dropdown-content z-[1] menu p-2 shadow-lg bg-base-100 rounded-lg w-48 border border-base-200 gap-1 mt-2">
                                <li>
                                    <form action="/auth/set-language" method="post" class="block p-0">
                                        <input type="hidden" name="next" value="{{ request.url.path }}{% if request.url.query %}?{{ request.url.query }}{% endif %}">
                                        <input type="hidden" name="language" value="en">
                                        <button type="submit" class="flex w-full items-center gap-3 py-3 px-4 {% if current_language == 'en' %}bg-primary/10 text-primary font-medium{% endif %} hover:bg-base-200">
                                            <span class="text-xl leading-none">ðŸ‡¬ðŸ‡§</span>
                                            <span class="text-base">{{ _('English') }}</span>
                                            {% if current_language == 'en' %}
                                            <span class="mdi mdi-check ml-auto text-primary"></span>
                                            {% endif %}
                                        </button>
                                    </form>
                                </li>
                                <li>
                                    <form action="/auth/set-language" method="post" class="block p-0">
                                        <input type="hidden" name="next" value="{{ request.url.path }}{% if request.url.query %}?{{ request.url.query }}{% endif %}">
                                        <input type="hidden" name="language" value="de">
                                        <button type="submit" class="flex w-full items-center gap-3 py-3 px-4 {% if current_language == 'de' %}bg-primary/10 text-primary font-medium{% endif %} hover:bg-base-200">
                                            <span class="text-xl leading-none">ðŸ‡©ðŸ‡ª</span>
                                            <span class="text-base">{{ _('German') }}</span>
                                            {% if current_language == 'de' %}
                                            <span class="mdi mdi-check ml-auto text-primary"></span>
                                            {% endif %}
                                        </button>
                                    </form>
                                </li>
                            </ul>
                        </div>
                        <a href="/login" class="btn btn-ghost">
                            <span class="mdi mdi-login"></span>
                            {{ _('Login') }}
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </nav>

    <main class="flex-grow max-w-7xl mx-auto w-full px-4 sm:px-6 lg:px-8 py-4 md:py-8">
        {% block content %}{% endblock %}
    </main>

    <footer class="mt-8 py-4 text-center text-sm text-slate-500 dark:text-slate-400 bg-slate-100/80 dark:bg-slate-900/80 border-t border-slate-200 dark:border-slate-700">
        <span class="mdi mdi-yarn mr-1 align-middle"></span>{{ _('Stricknani') }} v0.1.0 | {{ _('GPL-3.0-only') }}
        <a href="https://github.com/pschmitt/stricknani" target="_blank" rel="noopener noreferrer" class="ml-2 text-slate-500 dark:text-slate-400 hover:text-slate-700 dark:hover:text-slate-200" aria-label="GitHub">
            <span class="mdi mdi-github text-lg align-middle"></span>
        </a>
    </footer>
    </div>
    <div class="drawer-side z-[9999]">
        <label for="main-drawer" aria-label="close sidebar" class="drawer-overlay"></label>
        <ul class="menu p-4 w-80 min-h-full bg-base-200 text-base-content">
            <!-- Sidebar content here -->
            {% set current_path = request.url.path %}
            <li class="mb-4">
                <a href="/" class="text-xl font-bold gap-2 hover:bg-transparent">
                    <img src="{% if is_dev_instance %}/static/favicon-dev.svg{% else %}/static/favicon.svg{% endif %}" alt="" class="h-8 w-8" />
                    <span class="mdi mdi-yarn text-primary"></span>
                    {{ _('Stricknani') }}
                </a>
            </li>

            {% if current_user %}
            <li>
                <a href="/projects" class="{% if current_path.startswith('/projects') %}active{% endif %}">
                    <span class="mdi mdi-folder-outline text-lg"></span>{{ _('Projects') }}
                </a>
            </li>
            <li>
                <a href="/yarn" class="{% if current_path.startswith('/yarn') %}active{% endif %}">
                    <span class="mdi mdi-sheep text-lg"></span>{{ _('Yarns') }}
                </a>
            </li>
            {% endif %}

            <li>
                <a href="/gauge" class="{% if current_path.startswith('/gauge') %}active{% endif %}">
                    <span class="mdi mdi-ruler text-lg"></span>{{ _('Gauge Calculator') }}
                </a>
            </li>

            {% if current_user and current_user.is_admin %}
            <li>
                <a href="/admin/users" class="{% if current_path.startswith('/admin') %}active{% endif %}">
                    <span class="mdi mdi-shield-account text-lg"></span>{{ _('Admin') }}
                </a>
            </li>
            {% endif %}

            {% if not current_user %}
            <li>
                <a href="/login" class="">
                    <span class="mdi mdi-login text-lg"></span>{{ _('Login') }}
                </a>
            </li>
            {% endif %}

            <div class="divider"></div>
            <li class="menu-title">{{ _('Settings') }}</li>
            <li>
                <button type="button" onclick="toggleTheme()" class="justify-between">
                    <span class="flex items-center gap-2">
                        <span class="mdi mdi-theme-light-dark"></span> {{ _('Theme') }}
                    </span>
                    <span class="mdi mdi-weather-night text-lg"></span>
                </button>
            </li>
            <li>
                <div class="flex items-center justify-between py-2 active:bg-transparent hover:bg-transparent cursor-default">
                    <span class="flex items-center gap-2">
                        <span class="mdi mdi-translate"></span> {{ _('Language') }}
                    </span>
                    <div class="join">
                        <form action="/auth/set-language" method="post" class="inline">
                            <input type="hidden" name="next" value="{{ request.url.path }}{% if request.url.query %}?{{ request.url.query }}{% endif %}">
                            <input type="hidden" name="language" value="en">
                            <button type="submit" class="join-item btn btn-sm {% if current_language == 'en' %}btn-primary{% else %}btn-ghost{% endif %}">ðŸ‡¬ðŸ‡§</button>
                        </form>
                        <form action="/auth/set-language" method="post" class="inline">
                            <input type="hidden" name="next" value="{{ request.url.path }}{% if request.url.query %}?{{ request.url.query }}{% endif %}">
                            <input type="hidden" name="language" value="de">
                            <button type="submit" class="join-item btn btn-sm {% if current_language == 'de' %}btn-primary{% else %}btn-ghost{% endif %}">ðŸ‡©ðŸ‡ª</button>
                        </form>
                    </div>
                </div>
            </li>
        </ul>
    </div>
    </div>

    {% if current_user %}
    <!-- Profile Image Upload Tools -->
    <input type="file" id="profile-image-input" class="hidden" accept="image/*">
    <dialog id="crop-modal" class="modal">
        <div class="modal-box max-w-lg">
            <h3 class="font-bold text-lg mb-4">{{ _('Crop Profile Picture') }}</h3>
            <div class="relative h-96 w-full rounded-lg bg-base-300 overflow-hidden">
                <img id="crop-image" src="" alt="Image to crop" class="max-h-full max-w-full">
            </div>
            <div class="modal-action">
                <button type="button" id="crop-cancel" class="btn btn-ghost">{{ _('Cancel') }}</button>
                <button type="button" id="crop-save" class="btn btn-primary">{{ _('Save & Upload') }}</button>
            </div>
        </div>
    </dialog>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            let cropper;
            const input = document.getElementById('profile-image-input');
            const modal = document.getElementById('crop-modal');
            const image = document.getElementById('crop-image');
            const saveBtn = document.getElementById('crop-save');
            const cancelBtn = document.getElementById('crop-cancel');
            let targetUserId = {{ current_user.id }};

            window.triggerProfileImageUpload = function(userId) {
                targetUserId = userId || {{ current_user.id }};
                input.click();
            };

            input.addEventListener('change', function(e) {
                const files = e.target.files;
                if (files && files.length > 0) {
                    const file = files[0];
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        image.src = e.target.result;
                        modal.showModal();

                        if (cropper) {
                            cropper.destroy();
                        }
                        cropper = new Cropper(image, {
                            aspectRatio: 1,
                            viewMode: 1,
                            dragMode: 'move',
                            autoCropArea: 1,
                            restore: false,
                            guides: false,
                            center: false,
                            highlight: false,
                            cropBoxMovable: false,
                            cropBoxResizable: false,
                            toggleDragModeOnDblclick: false,
                            zoomable: true,
                            zoomOnTouch: true,
                            zoomOnWheel: true,
                        });
                    };
                    reader.readAsDataURL(file);
                }
            });

            cancelBtn.addEventListener('click', function() {
                modal.close();
                input.value = '';
                if (cropper) {
                    cropper.destroy();
                    cropper = null;
                }
            });

            saveBtn.addEventListener('click', function() {
                if (!cropper) return;

                const canvas = cropper.getCroppedCanvas({
                    width: 400,
                    height: 400,
                });

                canvas.toBlob(function(blob) {
                    const formData = new FormData();
                    formData.append('file', blob, 'avatar.png');

                    // Show loading state
                    const originalText = saveBtn.textContent;
                    saveBtn.textContent = '{{ _("Uploading...") }}';
                    saveBtn.disabled = true;

                    const url = targetUserId === {{ current_user.id }} ? '/user/profile-image' : `/admin/users/${targetUserId}/profile-image`;

                    fetch(url, {
                        method: 'POST',
                        body: formData,
                        headers: {
                            'HX-Request': 'true'
                        }
                    })
                    .then(response => {
                        if (!response.ok) throw new Error('Upload failed');
                        return response.text();
                    })
                    .then(html => {
                        if (targetUserId === {{ current_user.id }}) {
                            // Refresh page or update avatars
                            window.location.reload();
                        } else {
                            // Admin case: update user card
                            const card = document.getElementById(`user-card-${targetUserId}`);
                            if (card) {
                                // Parse the response to handle OOB swaps manually
                                const parser = new DOMParser();
                                const doc = parser.parseFromString(html, 'text/html');

                                // Update user card
                                const newCard = doc.getElementById(`user-card-${targetUserId}`);
                                if (newCard) {
                                    card.replaceWith(newCard);
                                    // Re-initialize HTMX on the new content
                                    if (window.htmx) {
                                        window.htmx.process(newCard);
                                    }
                                }

                                // Update user count (OOB swap)
                                const newCount = doc.getElementById('user-count');
                                const currentCount = document.getElementById('user-count');
                                if (newCount && currentCount) {
                                    currentCount.replaceWith(newCount);
                                }
                            }
                            modal.close();

                            // Close the edit user dialog if it's open
                            const editUserDialog = document.getElementById('editUserDialog');
                            if (editUserDialog && editUserDialog.open) {
                                editUserDialog.close();
                            }

                            showToast('{{ _("Profile picture updated successfully") }}', 'success');
                        }
                    })
                    .catch(err => {
                        console.error(err);
                        showToast('{{ _("Failed to upload image") }}', 'error');
                    })
                    .finally(() => {
                        saveBtn.textContent = originalText;
                        saveBtn.disabled = false;
                    });
                }, 'image/png');
            });
        });
    </script>
    {% endif %}

    <div
        id="toastContainer"
        class="fixed inset-x-4 top-4 z-[10000] mx-auto flex max-w-sm flex-col gap-3 sm:inset-auto sm:right-4 sm:top-4 sm:w-80"
        aria-live="polite"
        aria-atomic="true"
    ></div>

    <dialog
        id="imageLightbox"
        class="fixed inset-0 z-[9999] h-screen w-screen max-w-none max-h-none m-0 p-0 border-0 bg-slate-950 text-white backdrop:bg-transparent"
        aria-label="{{ _('Image viewer') }}"
    >
        <div class="flex h-full w-full">
            <div class="relative flex flex-1 flex-col items-center justify-center p-4">
                <button
                    type="button"
                    class="absolute right-16 top-4 rounded-full bg-white/10 p-3 text-white transition-all duration-300 hover:bg-white/20 z-10"
                    data-lightbox-zoom
                    aria-label="{{ _('Toggle zoom') }}"
                >
                    <span class="mdi mdi-magnify-plus text-xl"></span>
                </button>
                <button
                    type="button"
                    class="absolute right-4 top-4 rounded-full bg-white/10 p-3 text-white transition-all duration-300 hover:bg-white/20 z-10"
                    data-lightbox-close
                    aria-label="{{ _('Close image viewer') }}"
                >
                    <span class="mdi mdi-close text-xl"></span>
                </button>
                <button
                    type="button"
                    class="absolute left-4 top-1/2 -translate-y-1/2 rounded-full bg-white/10 p-4 text-white transition-all duration-300 hover:bg-white/20 z-10 hidden sm:flex"
                    data-lightbox-prev
                    aria-label="{{ _('Previous image') }}"
                >
                    <span class="mdi mdi-chevron-left text-3xl"></span>
                </button>
                <div class="flex max-h-full w-full max-w-4xl flex-col items-center justify-center overflow-hidden" data-zoom-container>
                    <img src="" alt="" class="max-h-[75vh] max-w-full rounded-lg object-contain shadow-lg transition-transform duration-200 origin-center cursor-zoom-in" data-lightbox-image>
                    <p class="mt-4 text-center text-sm text-white/80 transition-opacity duration-300" data-lightbox-caption></p>
                </div>
                <button
                    type="button"
                    class="absolute right-4 top-1/2 -translate-y-1/2 rounded-full bg-white/10 p-4 text-white transition-all duration-300 hover:bg-white/20 z-10 hidden sm:flex"
                    data-lightbox-next
                    aria-label="{{ _('Next image') }}"
                >
                    <span class="mdi mdi-chevron-right text-3xl"></span>
                </button>
            </div>
            <div class="hidden w-80 flex-col border-l border-slate-800 bg-slate-900/50 p-4 lg:flex overflow-y-auto">
                <h3 class="mb-4 text-sm font-medium text-slate-400">{{ _('Gallery') }}</h3>
                <div class="grid grid-cols-2 gap-2" data-lightbox-thumbnails></div>
            </div>
        </div>
    </dialog>

    <dialog id="confirmationDialog" class="modal modal-bottom sm:modal-middle">
        <div class="modal-box">
            <h3 class="font-bold text-lg" id="confirmationTitle">{{ _('Confirm Action') }}</h3>
            <p class="py-4" id="confirmationMessage">{{ _('Are you sure you want to proceed?') }}</p>
            <div class="modal-action">
                <form method="dialog">
                    <button class="btn btn-ghost" id="confirmationCancel">{{ _('Cancel') }}</button>
                    <button class="btn btn-error text-white" id="confirmationConfirm">{{ _('Confirm') }}</button>
                </form>
            </div>
        </div>
        <form method="dialog" class="modal-backdrop">
            <button>{{ _('close') }}</button>
        </form>
    </dialog>

    <script>
        window.confirmAction = (title, message, onConfirm) => {
            const dialog = document.getElementById('confirmationDialog');
            const titleEl = document.getElementById('confirmationTitle');
            const messageEl = document.getElementById('confirmationMessage');
            const confirmBtn = document.getElementById('confirmationConfirm');

            if (!dialog || !titleEl || !messageEl || !confirmBtn) return;

            titleEl.textContent = title;
            messageEl.textContent = message;

            // Remove old listeners to avoid stacking
            const newConfirmBtn = confirmBtn.cloneNode(true);
            confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);

            newConfirmBtn.addEventListener('click', () => {
                onConfirm();
                dialog.close();
            });

            dialog.showModal();
        };

        const toastVariants = {
            success: "bg-emerald-500/90 text-white",
            error: "bg-red-600/90 text-white",
            info: "bg-slate-900/90 text-white",
        };

        const toastContainer = document.getElementById("toastContainer");

        window.showToast = (message, variant = "info") => {
            if (!toastContainer || !message) {
                return;
            }

            toastContainer.replaceChildren();
            const toast = document.createElement("div");
            toast.className = `rounded-lg px-4 py-3 shadow-lg ring-1 ring-black/10 backdrop-blur transition duration-200 ease-out opacity-0 translate-y-2 hover:translate-y-1 ${
                toastVariants[variant] || toastVariants.info
            }`;
            toast.setAttribute("role", "status");
            toast.innerHTML = `
                <div class="flex items-start gap-3">
                    <span class="mdi ${
                        variant === "success"
                            ? "mdi-check-circle"
                            : variant === "error"
                              ? "mdi-alert-circle"
                              : "mdi-information"
                    } text-lg"></span>
                    <p class="text-sm leading-snug">${message}</p>
                    <button type="button" class="ml-auto text-white/80 transition hover:text-white" aria-label="{{ _('Dismiss message') }}">
                        <span class="mdi mdi-close"></span>
                    </button>
                </div>
            `;

            const closeButton = toast.querySelector("button");
            closeButton?.addEventListener("click", () => {
                toast.classList.add("opacity-0", "translate-y-2");
                setTimeout(() => toast.remove(), 200);
            });

            toastContainer.appendChild(toast);
            requestAnimationFrame(() => {
                requestAnimationFrame(() => {
                    toast.classList.remove("opacity-0", "translate-y-2");
                });
            });

            setTimeout(() => {
                if (!toast.isConnected) {
                    return;
                }
                toast.classList.add("opacity-0", "translate-y-2");
                setTimeout(() => toast.remove(), 200);
            }, 5000);
        };

        const extractErrorMessage = async (response, fallback) => {
            const defaultMessage = fallback || "{{ _('Something went wrong. Please try again.') }}";
            if (!response) {
                return defaultMessage;
            }

            const isFetchResponse = typeof response.clone === "function";
            const contentType = isFetchResponse
                ? response.headers?.get("content-type") || ""
                : typeof response.getResponseHeader === "function"
                  ? response.getResponseHeader("content-type") || ""
                  : "";

            try {
                if (contentType.includes("application/json")) {
                    if (isFetchResponse) {
                        const data = await response.clone().json();
                        if (typeof data?.detail === "string" && data.detail.trim()) {
                            return data.detail;
                        }
                        if (typeof data?.message === "string" && data.message.trim()) {
                            return data.message;
                        }
                    } else if (response.responseText) {
                        const data = JSON.parse(response.responseText);
                        if (typeof data?.detail === "string" && data.detail.trim()) {
                            return data.detail;
                        }
                        if (typeof data?.message === "string" && data.message.trim()) {
                            return data.message;
                        }
                    }
                } else if (isFetchResponse) {
                    const text = await response.clone().text();
                    if (text.trim()) {
                        return text.trim();
                    }
                } else if (response.responseText) {
                    const text = response.responseText;
                    if (text && text.trim()) {
                        return text.trim();
                    }
                }
            } catch (error) {
                console.error("Failed to parse error response", error);
            }

            return defaultMessage;
        };

        const initLightbox = () => {
            const lightbox = document.getElementById("imageLightbox");
            if (!lightbox) {
                return;
            }

            const image = lightbox.querySelector("[data-lightbox-image]");
            const caption = lightbox.querySelector("[data-lightbox-caption]");
            const closeButton = lightbox.querySelector("[data-lightbox-close]");
            const zoomButton = lightbox.querySelector("[data-lightbox-zoom]");
            const prevButton = lightbox.querySelector("[data-lightbox-prev]");
            const nextButton = lightbox.querySelector("[data-lightbox-next]");
            const thumbnailsContainer = lightbox.querySelector("[data-lightbox-thumbnails]");
            const zoomContainer = lightbox.querySelector("[data-zoom-container]");

            let currentIndex = 0;
            let currentItems = [];
            let touchStartX = null;
            let isZoomed = false;

            const updateNavigationState = () => {
                const hasMultiple = currentItems.length > 1;
                if (hasMultiple) {
                    prevButton.classList.remove("opacity-50", "pointer-events-none");
                    nextButton.classList.remove("opacity-50", "pointer-events-none");
                } else {
                    prevButton.classList.add("opacity-50", "pointer-events-none");
                    nextButton.classList.add("opacity-50", "pointer-events-none");
                }
            };

            const toggleZoom = () => {
                isZoomed = !isZoomed;
                if (isZoomed) {
                    image.style.transform = "scale(2.5)";
                    image.classList.remove("cursor-zoom-in");
                    image.classList.add("cursor-zoom-out");
                    if (zoomButton) {
                        zoomButton.querySelector("span").classList.replace("mdi-magnify-plus", "mdi-magnify-minus");
                        zoomButton.classList.add("bg-white/30");
                    }
                    if (zoomContainer) zoomContainer.style.overflow = "auto";
                } else {
                    image.style.transform = "";
                    image.classList.remove("cursor-zoom-out");
                    image.classList.add("cursor-zoom-in");
                    if (zoomButton) {
                        zoomButton.querySelector("span").classList.replace("mdi-magnify-minus", "mdi-magnify-plus");
                        zoomButton.classList.remove("bg-white/30");
                    }
                    if (zoomContainer) {
                        zoomContainer.style.overflow = "hidden";
                        zoomContainer.scrollTop = 0;
                        zoomContainer.scrollLeft = 0;
                    }
                }
            };

            const renderThumbnails = () => {
                if (!thumbnailsContainer) {
                    return;
                }
                thumbnailsContainer.innerHTML = "";
                currentItems.forEach((item, index) => {
                    const button = document.createElement("button");
                    button.type = "button";
                    button.className = `relative aspect-square w-full overflow-hidden rounded-lg border-2 transition ${
                        index === currentIndex
                            ? "border-blue-500 ring-2 ring-blue-500/20"
                            : "border-transparent hover:border-slate-600"
                    }`;
                    button.onclick = () => {
                        currentIndex = index;
                        render();
                    };

                    const img = document.createElement("img");
                    img.src = item.src;
                    img.alt = item.alt;
                    img.className = "h-full w-full object-cover";

                    button.appendChild(img);
                    thumbnailsContainer.appendChild(button);
                });
            };

            const render = () => {
                const active = currentItems[currentIndex];
                if (!active) {
                    return;
                }
                // Reset zoom on slide change
                if (isZoomed) toggleZoom();

                image.src = active.src;
                image.alt = active.alt;
                caption.textContent = active.alt || "";
                updateNavigationState();
                renderThumbnails();
            };

            const close = () => {
                lightbox.close();
                document.body.classList.remove("overflow-hidden");
                document.removeEventListener("keydown", handleKeydown);
            };

            const show = (group, trigger) => {
                const allElements = Array.from(
                    document.querySelectorAll(`[data-lightbox-group="${group}"]`),
                );

                const uniqueItems = [];
                const seenSrcs = new Set();

                allElements.forEach((el) => {
                    const src = el.getAttribute("data-lightbox-src") || el.currentSrc || el.src;
                    if (!seenSrcs.has(src)) {
                        seenSrcs.add(src);
                        uniqueItems.push({
                            src: src,
                            alt: el.getAttribute("data-lightbox-alt") || el.alt || "",
                            element: el,
                            group,
                        });
                    }
                });

                currentItems = uniqueItems;

                if (!currentItems.length) {
                    return;
                }

                const triggerSrc = trigger.getAttribute("data-lightbox-src") || trigger.currentSrc || trigger.src;
                let index = currentItems.findIndex((item) => item.src === triggerSrc);
                if (index === -1) {
                    index = 0;
                }
                currentIndex = index;

                lightbox.showModal();
                // Ensure flex display for content layout
                lightbox.style.display = "flex";
                document.body.classList.add("overflow-hidden");
                render();
                document.addEventListener("keydown", handleKeydown);
            };

            const showNext = () => {
                if (!currentItems.length) {
                    return;
                }
                currentIndex = (currentIndex + 1) % currentItems.length;
                render();
            };

            const showPrev = () => {
                if (!currentItems.length) {
                    return;
                }
                currentIndex = (currentIndex - 1 + currentItems.length) % currentItems.length;
                render();
            };

            const handleKeydown = (event) => {
                if (!lightbox.open) {
                    return;
                }
                if (event.key === "Escape") {
                    event.preventDefault(); // Prevent default escape behavior to handle cleanup
                    close();
                } else if (event.key === "ArrowRight" || event.key === "ArrowDown") {
                    showNext();
                } else if (event.key === "ArrowLeft" || event.key === "ArrowUp") {
                    showPrev();
                }
            };

            document.addEventListener("click", (event) => {
                const trigger = event.target.closest("[data-lightbox-group]");
                if (!trigger) {
                    return;
                }
                event.preventDefault();
                const group = trigger.getAttribute("data-lightbox-group");
                show(group, trigger);
            });

            lightbox.addEventListener("click", (event) => {
                if (event.target === lightbox) {
                    close();
                }
            });

            // Handle native close event (e.g. via Escape if not prevented)
            lightbox.addEventListener("close", () => {
                document.body.classList.remove("overflow-hidden");
                document.removeEventListener("keydown", handleKeydown);
                lightbox.style.display = ""; // Reset display style
            });

            closeButton.addEventListener("click", () => close());
            if (zoomButton) zoomButton.addEventListener("click", () => toggleZoom());
            // Mobile-friendly tap handler
            let lastTap = 0;
            let tapTimeout;

            const toggleControls = () => {
                const controls = [closeButton, zoomButton, caption];
                const navControls = [prevButton, nextButton];

                if (!closeButton) return;

                // Check if currently hidden (check closeButton as proxy)
                const isHidden = closeButton.classList.contains("opacity-0");

                if (isHidden) {
                    // Show
                    controls.forEach(el => {
                        if (el) el.classList.remove("opacity-0", "pointer-events-none");
                    });
                    navControls.forEach(el => {
                         if (el) el.classList.remove("opacity-0");
                    });
                    // Re-apply correct state for nav buttons
                    updateNavigationState();
                } else {
                    // Hide
                    [...controls, ...navControls].forEach(el => {
                        if (el) el.classList.add("opacity-0", "pointer-events-none");
                    });
                }
            };

            image.addEventListener("click", (e) => {
                e.stopPropagation();
                const now = Date.now();
                const timeDiff = now - lastTap;

                if (timeDiff < 300 && timeDiff > 0) {
                    // Double tap
                    if (tapTimeout) clearTimeout(tapTimeout);
                    toggleZoom();
                } else {
                    // Single tap
                    tapTimeout = setTimeout(() => {
                        toggleControls();
                    }, 300);
                }
                lastTap = now;
            });

            nextButton.addEventListener("click", () => showNext());
            prevButton.addEventListener("click", () => showPrev());

            lightbox.addEventListener("pointerdown", (event) => {
                if (event.pointerType === "touch" || event.pointerType === "pen") {
                    touchStartX = event.clientX;
                }
            });

            lightbox.addEventListener("pointerup", (event) => {
                if (touchStartX === null || isZoomed) {
                    return;
                }
                const deltaX = event.clientX - touchStartX;
                if (Math.abs(deltaX) > 50) {
                    if (deltaX < 0) {
                        showNext();
                    } else {
                        showPrev();
                    }
                }
                touchStartX = null;
            });

            lightbox.addEventListener("pointercancel", () => {
                touchStartX = null;
            });

            window.addEventListener("resize", () => {
                if (!lightbox.classList.contains("hidden")) {
                    render();
                }
            });
        };

        document.addEventListener("DOMContentLoaded", () => {
            const urlParams = new URLSearchParams(window.location.search);
            const toastKey = urlParams.get('toast');
            if (toastKey) {
                const toastMessages = {
                    'project_created': '{{ _("Project created successfully") }}',
                    'project_updated': '{{ _("Project updated successfully") }}',
                    'project_deleted': '{{ _("Project deleted") }}',
                    'yarn_created': '{{ _("Yarn created successfully") }}',
                    'yarn_updated': '{{ _("Yarn updated successfully") }}',
                    'yarn_deleted': '{{ _("Yarn deleted") }}',
                    'profile_updated': '{{ _("Profile updated successfully") }}',
                };

                const message = toastMessages[toastKey];
                if (message) {
                    window.showToast?.(message, 'success');
                    const url = new URL(window.location.href);
                    url.searchParams.delete('toast');
                    window.history.replaceState({}, '', url.toString());
                }
            }

            // DaisyUI handles dropdown automatically via focus/blur, no custom JS needed
            // Just handle escape key for accessibility
            const menuRoot = document.querySelector("[data-user-menu]");
            if (menuRoot) {
                const trigger = menuRoot.querySelector("[data-user-menu-trigger]");
                const panel = menuRoot.querySelector("[data-user-menu-panel]");

                if (trigger && panel) {
                    // Make dropdown work properly
                    trigger.addEventListener("click", (e) => {
                        e.stopPropagation();
                        // Toggle visibility by managing focus
                        if (panel.classList.contains('hidden')) {
                            panel.classList.remove('hidden');
                            panel.focus();
                        } else {
                            panel.classList.add('hidden');
                        }
                    });

                    // Close on outside click
                    document.addEventListener("click", (event) => {
                        if (!menuRoot.contains(event.target)) {
                            panel.classList.add('hidden');
                        }
                    });

                    // Close on escape
                    document.addEventListener("keydown", (event) => {
                        if (event.key === "Escape") {
                            panel.classList.add('hidden');
                        }
                    });

                    // Start hidden
                    panel.classList.add('hidden');
                }
            }

            initLightbox();

            // Mobile menu logic handled by DaisyUI drawer (CSS only)
        });

        // Theme toggle functionality
        function toggleTheme() {
            const html = document.documentElement;
            const currentTheme = html.getAttribute('data-theme') || 'light';
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';

            html.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);

            // Toggle dark class for Tailwind
            if (newTheme === 'dark') {
                html.classList.add('dark');
            } else {
                html.classList.remove('dark');
            }

            console.log('Theme toggled to:', newTheme, 'HTML classes:', html.className);

            updateThemeUI(newTheme);
        }

        function updateThemeUI(theme) {
            const isDark = theme === 'dark';
            const label = document.getElementById('theme-label');
            const icon = document.getElementById('theme-icon');
            const iconPublic = document.getElementById('theme-icon-public');

            if (label) {
                label.textContent = isDark ? '{{ _('Dark') }}' : '{{ _('Light') }}';
            }

            const iconClass = isDark ? 'mdi-weather-night' : 'mdi-weather-sunny';

            if (icon) {
                icon.className = `mdi ${iconClass} text-lg`;
            }

            if (iconPublic) {
                iconPublic.className = `mdi ${iconClass} text-xl`;
            }
        }

        // Initialize theme UI on page load
        document.addEventListener('DOMContentLoaded', () => {
            const currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
            updateThemeUI(currentTheme);
        });

        document.body.addEventListener("htmx:responseError", async (event) => {
            const fallback = "{{ _('Something went wrong. Please try again.') }}";
            const message = await extractErrorMessage(event.detail.xhr, fallback);
            showToast(message, "error");
        });

        document.body.addEventListener("htmx:afterRequest", (event) => {
            const element = event.detail?.requestConfig?.elt || event.detail?.elt;
            if (!element) {
                return;
            }
            const status = event.detail?.xhr?.status ?? 200;
            if (status >= 400) {
                return;
            }
            const toastElement =
                element.getAttribute("data-toast-message") !== null
                    ? element
                    : element.querySelector?.("[data-toast-message]");
            if (!toastElement) {
                return;
            }
            const message = toastElement.getAttribute("data-toast-message");
            if (!message) {
                return;
            }
            const variant = toastElement.getAttribute("data-toast-variant") || "info";
            if (window.showToast) {
                window.showToast(message, variant);
            }
            const dialogId = element.getAttribute("data-dialog-close");
            if (dialogId) {
                closeDialog(dialogId);
            }
        });

        function resolveDialog(dialogOrId) {
            if (typeof dialogOrId === "string") {
                return document.getElementById(dialogOrId);
            }
            return dialogOrId;
        }

        function openDialog(dialogOrId) {
            console.log('openDialog called with:', dialogOrId);
            const dialog = resolveDialog(dialogOrId);
            if (!dialog) {
                console.error('Dialog not found:', dialogOrId);
                return false;
            }
            if (typeof dialog.showModal === "function") {
                if (!dialog.open) {
                    console.log('Calling showModal on dialog');
                    dialog.showModal();
                } else {
                    console.log('Dialog is already open');
                }
                return true;
            }
            console.log('Fallback to legacy open attribute');
            dialog.setAttribute("open", "");
            dialog.style.display = "block";
            dialog.setAttribute("aria-modal", "true");
            return true;
        }

        function closeDialog(dialogOrId) {
            const dialog = resolveDialog(dialogOrId);
            if (!dialog) {
                return false;
            }
            if (typeof dialog.close === "function") {
                dialog.close();
                return true;
            }
            dialog.removeAttribute("open");
            dialog.style.display = "none";
            return true;
        }

        window.openDialog = openDialog;
        window.closeDialog = closeDialog;
    </script>
</body>
</html>