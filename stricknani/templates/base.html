<!DOCTYPE html>
<html lang="{{ current_language }}" class="h-full antialiased transition-colors duration-200">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}{{ _('Stricknani') }}{% endblock %}</title>
    {% block head %}{% endblock %}
    <link rel="icon" type="image/svg+xml" href="{% if is_dev_instance %}/static/favicon-dev.svg{% else %}/static/favicon.svg{% endif %}">
    <link
        rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/@mdi/font@7.4.47/css/materialdesignicons.min.css"
    >
    <script>
        // Theme initialization - MUST run before page renders
        (function() {
            const theme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', theme);
            // Also set dark class for Tailwind dark mode
            if (theme === 'dark') {
                document.documentElement.classList.add('dark');
            }
        })();
    </script>
    
    <script>
        // Configure Tailwind and DaisyUI BEFORE loading them
        window.tailwind = window.tailwind || {};
        window.tailwind.config = {
            darkMode: 'class',
            daisyui: {
                themes: ["light", "dark"],
                darkTheme: "dark",
                base: true,
                styled: true,
                utils: true,
            }
        }
    </script>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.12.14/dist/full.min.css" rel="stylesheet" type="text/css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <style>
        .markdown-inline-image {
            max-width: 250px;
            width: 100%;
            cursor: zoom-in;
            border-radius: 0.5rem;
            margin-top: 0.5rem;
            margin-bottom: 0.5rem;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col bg-base-100">
    <nav class="navbar bg-base-200 shadow-sm border-b border-base-300">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 w-full">
            <div class="flex justify-between h-16 w-full">
                <div class="flex items-center space-x-2 md:space-x-8">
                    <button type="button" class="btn btn-ghost md:hidden" aria-controls="mobile-menu" aria-expanded="false" id="mobile-menu-button">
                        <span class="sr-only">{{ _('Open main menu') }}</span>
                        <span class="mdi mdi-menu text-2xl"></span>
                    </button>
                    <a href="/" class="text-xl font-bold hover:text-primary inline-flex items-center gap-2">
                        <img src="{% if is_dev_instance %}/static/favicon-dev.svg{% else %}/static/favicon.svg{% endif %}" alt="" class="h-6 w-6" />
                        <span class="mdi mdi-yarn text-primary"></span>
                        {{ _('Stricknani') }}
                    </a>
                    <div class="hidden md:flex space-x-4">
                        {% set current_path = request.url.path %}
                        {% if current_user %}
                        <a href="/projects" class="btn btn-ghost {% if current_path.startswith('/projects') %}btn-active{% endif %}">
                            <span class="mdi mdi-folder-outline"></span>
                            {{ _('Projects') }}
                        </a>
                        <a href="/yarn" class="btn btn-ghost {% if current_path.startswith('/yarn') %}btn-active{% endif %}">
                            <span class="mdi mdi-sheep"></span>
                            {{ _('Yarn') }}
                        </a>
                        {% endif %}
                        <a href="/gauge" class="btn btn-ghost {% if current_path.startswith('/gauge') %}btn-active{% endif %}">
                            <span class="mdi mdi-ruler"></span>
                            {{ _('Gauge Calculator') }}
                        </a>
                        {% if current_user and current_user.is_admin %}
                        <a href="/admin/users" class="btn btn-ghost {% if current_path.startswith('/admin') %}btn-active{% endif %}">
                            <span class="mdi mdi-shield-account"></span>
                            {{ _('Admin') }}
                        </a>
                        {% endif %}
                    </div>
                </div>
                <div class="flex items-center">
                    {% if current_user %}
                    <div class="dropdown dropdown-end" data-user-menu>
                        <button
                            type="button"
                            class="btn btn-ghost btn-circle avatar"
                            data-user-menu-trigger
                            tabindex="0"
                        >
                            {% if current_user_avatar_thumbnail %}
                            <div class="w-10 rounded-full">
                                <img src="{{ current_user_avatar_thumbnail }}" alt="{{ _('Profile picture for %(email)s') % {'email': current_user.email} }}" />
                            </div>
                            {% else %}
                            <span class="mdi mdi-account-circle text-3xl"></span>
                            {% endif %}
                        </button>
                        <div
                            class="dropdown-content menu bg-base-100 rounded-box z-50 w-72 p-0 shadow-xl border border-base-300"
                            data-user-menu-panel
                            tabindex="0"
                        >
                            <div class="flex items-center gap-3 border-b border-base-300 px-4 py-3">
                                <div class="avatar">
                                    <div class="w-12 rounded-full">
                                        {% if current_user_avatar_thumbnail %}
                                        <img src="{{ current_user_avatar_thumbnail }}" alt="{{ _('Profile picture for %(email)s') % {'email': current_user.email} }}" />
                                        {% else %}
                                        <div class="flex h-full w-full items-center justify-center bg-base-300">
                                            <span class="mdi mdi-account text-2xl"></span>
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                                <div>
                                    <p class="text-sm font-semibold">{{ current_user.email }}</p>
                                    <p class="text-xs opacity-60">{{ _('Signed in') }}</p>
                                </div>
                            </div>
                            <div class="space-y-4 border-b border-base-300 px-4 py-4">
                                <form action="/auth/set-language" method="post" class="space-y-2">
                                    <input type="hidden" name="next" value="{{ request.url.path }}{% if request.url.query %}?{{ request.url.query }}{% endif %}">
                                    <label class="label">
                                        <span class="label-text text-xs font-semibold uppercase tracking-wide opacity-60 flex items-center gap-2">
                                            <span class="mdi mdi-translate"></span>
                                            {{ _('Language') }}
                                        </span>
                                    </label>
                                    <select name="language" onchange="this.form.submit()" class="select select-bordered w-full">
                                        <option value="en" {% if current_language == 'en' %}selected{% endif %}>ðŸ‡¬ðŸ‡§ {{ _('English') }}</option>
                                        <option value="de" {% if current_language == 'de' %}selected{% endif %}>ðŸ‡©ðŸ‡ª {{ _('German') }}</option>
                                    </select>
                                </form>
                                <div class="space-y-2">
                                    <label class="label">
                                        <span class="label-text text-xs font-semibold uppercase tracking-wide opacity-60 flex items-center gap-2">
                                            <span class="mdi mdi-theme-light-dark"></span>
                                            {{ _('Theme') }}
                                        </span>
                                    </label>
                                    <button type="button" onclick="toggleTheme()" class="btn btn-outline w-full justify-between">
                                        <span id="theme-label">{{ _('Dark') }}</span>
                                        <span id="theme-icon" class="mdi mdi-weather-night text-lg"></span>
                                    </button>
                                </div>
                            </div>
                            <div class="space-y-2 px-4 py-4">
                                <a href="/user/profile" class="btn btn-ghost w-full justify-start">
                                    <span class="mdi mdi-account-details-outline text-lg"></span>
                                    {{ _('Profile') }}
                                </a>
                                <form action="/auth/logout" method="post">
                                    <button type="submit" class="btn btn-ghost w-full justify-start text-error">
                                        <span class="mdi mdi-logout text-lg"></span>
                                        {{ _('Logout') }}
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                    {% else %}
                    <div class="flex items-center space-x-4">
                        <button type="button" onclick="toggleTheme()" class="text-slate-900 dark:text-slate-200 hover:text-blue-600 dark:hover:text-blue-400 px-2 py-2 rounded-md transition-colors inline-flex items-center gap-2" title="{{ _('Toggle theme') }}">
                            <span id="theme-icon-public" class="mdi mdi-weather-night text-xl"></span>
                        </button>
                        <form action="/auth/set-language" method="post" class="inline">
                            <input type="hidden" name="next" value="{{ request.url.path }}{% if request.url.query %}?{{ request.url.query }}{% endif %}">
                            <select name="language" onchange="this.form.submit()" class="text-sm border-slate-300 dark:border-slate-700 rounded-md focus:ring-blue-500 focus:border-blue-500 bg-white dark:bg-slate-900 text-slate-900 dark:text-slate-100">
                                <option value="en" {% if current_language == 'en' %}selected{% endif %}>ðŸ‡¬ðŸ‡§ {{ _('English') }}</option>
                                <option value="de" {% if current_language == 'de' %}selected{% endif %}>ðŸ‡©ðŸ‡ª {{ _('German') }}</option>
                            </select>
                        </form>
                        <a href="/login" class="text-slate-900 dark:text-slate-200 hover:text-blue-600 dark:hover:text-blue-400 px-3 py-2 rounded-md text-sm font-medium transition-colors inline-flex items-center gap-2">
                            <span class="mdi mdi-login"></span>
                            {{ _('Login') }}
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="md:hidden hidden" id="mobile-menu">
            <div class="px-2 pt-2 pb-3 space-y-1 sm:px-3 border-t border-slate-200 dark:border-slate-700 bg-slate-100/95 dark:bg-slate-900/95 backdrop-blur">
                {% set current_path = request.url.path %}
                {% if current_user %}
                <a href="/projects" class="block px-3 py-2 rounded-md text-base font-medium {% if current_path.startswith('/projects') %}bg-blue-600 text-white{% else %}text-slate-900 dark:text-slate-200 hover:text-blue-600 dark:hover:text-blue-400 hover:bg-slate-200 dark:hover:bg-slate-800{% endif %}">
                    <span class="mdi mdi-folder-outline mr-2"></span>{{ _('Projects') }}
                </a>
                <a href="/yarn" class="block px-3 py-2 rounded-md text-base font-medium {% if current_path.startswith('/yarn') %}bg-blue-600 text-white{% else %}text-slate-900 dark:text-slate-200 hover:text-blue-600 dark:hover:text-blue-400 hover:bg-slate-200 dark:hover:bg-slate-800{% endif %}">
                    <span class="mdi mdi-sheep mr-2"></span>{{ _('Yarn') }}
                </a>
                {% endif %}
                <a href="/gauge" class="block px-3 py-2 rounded-md text-base font-medium {% if current_path.startswith('/gauge') %}bg-blue-600 text-white{% else %}text-slate-900 dark:text-slate-200 hover:text-blue-600 dark:hover:text-blue-400 hover:bg-slate-200 dark:hover:bg-slate-800{% endif %}">
                    <span class="mdi mdi-ruler mr-2"></span>{{ _('Gauge Calculator') }}
                </a>
                {% if current_user and current_user.is_admin %}
                <a href="/admin/users" class="block px-3 py-2 rounded-md text-base font-medium {% if current_path.startswith('/admin') %}bg-blue-600 text-white{% else %}text-slate-900 dark:text-slate-200 hover:text-blue-600 dark:hover:text-blue-400 hover:bg-slate-200 dark:hover:bg-slate-800{% endif %}">
                    <span class="mdi mdi-shield-account mr-2"></span>{{ _('Admin') }}
                </a>
                {% endif %}
                {% if not current_user %}
                <a href="/login" class="block px-3 py-2 rounded-md text-base font-medium text-slate-900 dark:text-slate-200 hover:text-blue-600 dark:hover:text-blue-400 hover:bg-slate-200 dark:hover:bg-slate-800">
                    <span class="mdi mdi-login mr-2"></span>{{ _('Login') }}
                </a>
                {% endif %}
            </div>
        </div>
    </nav>

    <main class="flex-grow max-w-7xl mx-auto w-full px-4 sm:px-6 lg:px-8 py-8">
        {% block content %}{% endblock %}
    </main>

    <footer class="mt-8 py-4 text-center text-sm text-slate-500 dark:text-slate-400 bg-slate-100/80 dark:bg-slate-900/80 border-t border-slate-200 dark:border-slate-700">
        <span class="mdi mdi-yarn mr-1 align-middle"></span>{{ _('Stricknani') }} v0.1.0 | {{ _('GPL-3.0-only') }}
        <a href="https://github.com/pschmitt/stricknani" target="_blank" rel="noopener noreferrer" class="ml-2 text-slate-500 dark:text-slate-400 hover:text-slate-700 dark:hover:text-slate-200" aria-label="GitHub">
            <span class="mdi mdi-github text-lg align-middle"></span>
        </a>
    </footer>

    <div
        id="toastContainer"
        class="fixed inset-x-4 top-4 z-[10000] mx-auto flex max-w-sm flex-col gap-3 sm:inset-auto sm:right-4 sm:top-4 sm:w-80"
        aria-live="polite"
        aria-atomic="true"
    ></div>

    <dialog
        id="imageLightbox"
        class="fixed inset-0 z-[9999] h-screen w-screen max-w-none max-h-none m-0 p-0 border-0 bg-slate-950 text-white backdrop:bg-transparent"
        aria-label="{{ _('Image viewer') }}"
    >
        <div class="flex h-full w-full">
            <div class="relative flex flex-1 flex-col items-center justify-center p-4">
                <button
                    type="button"
                    class="absolute right-4 top-4 rounded-full bg-white/10 p-2 text-white transition hover:bg-white/20 z-10"
                    data-lightbox-close
                    aria-label="{{ _('Close image viewer') }}"
                >
                    <span class="mdi mdi-close"></span>
                </button>
                <button
                    type="button"
                    class="absolute left-4 top-1/2 -translate-y-1/2 rounded-full bg-white/10 p-3 text-white transition hover:bg-white/20 z-10"
                    data-lightbox-prev
                    aria-label="{{ _('Previous image') }}"
                >
                    <span class="mdi mdi-chevron-left text-3xl"></span>
                </button>
                <div class="flex max-h-full w-full max-w-4xl flex-col items-center justify-center">
                    <img src="" alt="" class="max-h-[75vh] max-w-full rounded-lg object-contain shadow-lg" data-lightbox-image>
                    <p class="mt-4 text-center text-sm text-white/80" data-lightbox-caption></p>
                </div>
                <button
                    type="button"
                    class="absolute right-4 top-1/2 -translate-y-1/2 rounded-full bg-white/10 p-3 text-white transition hover:bg-white/20 z-10"
                    data-lightbox-next
                    aria-label="{{ _('Next image') }}"
                >
                    <span class="mdi mdi-chevron-right text-3xl"></span>
                </button>
            </div>
            <div class="hidden w-80 flex-col border-l border-slate-800 bg-slate-900/50 p-4 lg:flex overflow-y-auto">
                <h3 class="mb-4 text-sm font-medium text-slate-400">{{ _('Gallery') }}</h3>
                <div class="grid grid-cols-2 gap-2" data-lightbox-thumbnails></div>
            </div>
        </div>
    </dialog>

    <script>
        const toastVariants = {
            success: "bg-emerald-500/90 text-white",
            error: "bg-red-600/90 text-white",
            info: "bg-slate-900/90 text-white",
        };

        const toastContainer = document.getElementById("toastContainer");

        window.showToast = (message, variant = "info") => {
            if (!toastContainer || !message) {
                return;
            }

            const toast = document.createElement("div");
            toast.className = `rounded-lg px-4 py-3 shadow-lg ring-1 ring-black/10 backdrop-blur transition hover:translate-y-1 ${
                toastVariants[variant] || toastVariants.info
            }`;
            toast.setAttribute("role", "status");
            toast.innerHTML = `
                <div class="flex items-start gap-3">
                    <span class="mdi ${
                        variant === "success"
                            ? "mdi-check-circle"
                            : variant === "error"
                              ? "mdi-alert-circle"
                              : "mdi-information"
                    } text-lg"></span>
                    <p class="text-sm leading-snug">${message}</p>
                    <button type="button" class="ml-auto text-white/80 transition hover:text-white" aria-label="{{ _('Dismiss message') }}">
                        <span class="mdi mdi-close"></span>
                    </button>
                </div>
            `;

            const closeButton = toast.querySelector("button");
            closeButton?.addEventListener("click", () => {
                toast.classList.add("opacity-0", "translate-y-2");
                setTimeout(() => toast.remove(), 200);
            });

            toastContainer.appendChild(toast);

            setTimeout(() => {
                if (!toast.isConnected) {
                    return;
                }
                toast.classList.add("opacity-0", "translate-y-2");
                setTimeout(() => toast.remove(), 200);
            }, 5000);
        };

        const extractErrorMessage = async (response, fallback) => {
            const defaultMessage = fallback || "{{ _('Something went wrong. Please try again.') }}";
            if (!response) {
                return defaultMessage;
            }

            const isFetchResponse = typeof response.clone === "function";
            const contentType = isFetchResponse
                ? response.headers?.get("content-type") || ""
                : typeof response.getResponseHeader === "function"
                  ? response.getResponseHeader("content-type") || ""
                  : "";

            try {
                if (contentType.includes("application/json")) {
                    if (isFetchResponse) {
                        const data = await response.clone().json();
                        if (typeof data?.detail === "string" && data.detail.trim()) {
                            return data.detail;
                        }
                        if (typeof data?.message === "string" && data.message.trim()) {
                            return data.message;
                        }
                    } else if (response.responseText) {
                        const data = JSON.parse(response.responseText);
                        if (typeof data?.detail === "string" && data.detail.trim()) {
                            return data.detail;
                        }
                        if (typeof data?.message === "string" && data.message.trim()) {
                            return data.message;
                        }
                    }
                } else if (isFetchResponse) {
                    const text = await response.clone().text();
                    if (text.trim()) {
                        return text.trim();
                    }
                } else if (response.responseText) {
                    const text = response.responseText;
                    if (text && text.trim()) {
                        return text.trim();
                    }
                }
            } catch (error) {
                console.error("Failed to parse error response", error);
            }

            return defaultMessage;
        };

        const initLightbox = () => {
            const lightbox = document.getElementById("imageLightbox");
            if (!lightbox) {
                return;
            }

            const image = lightbox.querySelector("[data-lightbox-image]");
            const caption = lightbox.querySelector("[data-lightbox-caption]");
            const closeButton = lightbox.querySelector("[data-lightbox-close]");
            const prevButton = lightbox.querySelector("[data-lightbox-prev]");
            const nextButton = lightbox.querySelector("[data-lightbox-next]");
            const thumbnailsContainer = lightbox.querySelector("[data-lightbox-thumbnails]");

            let currentIndex = 0;
            let currentItems = [];
            let touchStartX = null;

            const updateNavigationState = () => {
                const hasMultiple = currentItems.length > 1;
                if (hasMultiple) {
                    prevButton.classList.remove("opacity-50", "pointer-events-none");
                    nextButton.classList.remove("opacity-50", "pointer-events-none");
                } else {
                    prevButton.classList.add("opacity-50", "pointer-events-none");
                    nextButton.classList.add("opacity-50", "pointer-events-none");
                }
            };

            const renderThumbnails = () => {
                if (!thumbnailsContainer) {
                    return;
                }
                thumbnailsContainer.innerHTML = "";
                currentItems.forEach((item, index) => {
                    const button = document.createElement("button");
                    button.type = "button";
                    button.className = `relative aspect-square w-full overflow-hidden rounded-lg border-2 transition ${
                        index === currentIndex
                            ? "border-blue-500 ring-2 ring-blue-500/20"
                            : "border-transparent hover:border-slate-600"
                    }`;
                    button.onclick = () => {
                        currentIndex = index;
                        render();
                    };

                    const img = document.createElement("img");
                    img.src = item.src;
                    img.alt = item.alt;
                    img.className = "h-full w-full object-cover";

                    button.appendChild(img);
                    thumbnailsContainer.appendChild(button);
                });
            };

            const render = () => {
                const active = currentItems[currentIndex];
                if (!active) {
                    return;
                }
                image.src = active.src;
                image.alt = active.alt;
                caption.textContent = active.alt || "";
                updateNavigationState();
                renderThumbnails();
            };

            const close = () => {
                lightbox.close();
                document.body.classList.remove("overflow-hidden");
                document.removeEventListener("keydown", handleKeydown);
            };

            const show = (group, trigger) => {
                const allElements = Array.from(
                    document.querySelectorAll(`[data-lightbox-group="${group}"]`),
                );

                const uniqueItems = [];
                const seenSrcs = new Set();

                allElements.forEach((el) => {
                    const src = el.getAttribute("data-lightbox-src") || el.currentSrc || el.src;
                    if (!seenSrcs.has(src)) {
                        seenSrcs.add(src);
                        uniqueItems.push({
                            src: src,
                            alt: el.getAttribute("data-lightbox-alt") || el.alt || "",
                            element: el,
                            group,
                        });
                    }
                });

                currentItems = uniqueItems;

                if (!currentItems.length) {
                    return;
                }

                const triggerSrc = trigger.getAttribute("data-lightbox-src") || trigger.currentSrc || trigger.src;
                let index = currentItems.findIndex((item) => item.src === triggerSrc);
                if (index === -1) {
                    index = 0;
                }
                currentIndex = index;

                lightbox.showModal();
                // Ensure flex display for content layout
                lightbox.style.display = "flex";
                document.body.classList.add("overflow-hidden");
                render();
                document.addEventListener("keydown", handleKeydown);
            };

            const showNext = () => {
                if (!currentItems.length) {
                    return;
                }
                currentIndex = (currentIndex + 1) % currentItems.length;
                render();
            };

            const showPrev = () => {
                if (!currentItems.length) {
                    return;
                }
                currentIndex = (currentIndex - 1 + currentItems.length) % currentItems.length;
                render();
            };

            const handleKeydown = (event) => {
                if (!lightbox.open) {
                    return;
                }
                if (event.key === "Escape") {
                    event.preventDefault(); // Prevent default escape behavior to handle cleanup
                    close();
                } else if (event.key === "ArrowRight" || event.key === "ArrowDown") {
                    showNext();
                } else if (event.key === "ArrowLeft" || event.key === "ArrowUp") {
                    showPrev();
                }
            };

            document.addEventListener("click", (event) => {
                const trigger = event.target.closest("[data-lightbox-group]");
                if (!trigger) {
                    return;
                }
                event.preventDefault();
                const group = trigger.getAttribute("data-lightbox-group");
                show(group, trigger);
            });

            lightbox.addEventListener("click", (event) => {
                if (event.target === lightbox) {
                    close();
                }
            });

            // Handle native close event (e.g. via Escape if not prevented)
            lightbox.addEventListener("close", () => {
                document.body.classList.remove("overflow-hidden");
                document.removeEventListener("keydown", handleKeydown);
                lightbox.style.display = ""; // Reset display style
            });

            closeButton.addEventListener("click", () => close());
            nextButton.addEventListener("click", () => showNext());
            prevButton.addEventListener("click", () => showPrev());

            lightbox.addEventListener("pointerdown", (event) => {
                if (event.pointerType === "touch" || event.pointerType === "pen") {
                    touchStartX = event.clientX;
                }
            });

            lightbox.addEventListener("pointerup", (event) => {
                if (touchStartX === null) {
                    return;
                }
                const deltaX = event.clientX - touchStartX;
                if (Math.abs(deltaX) > 50) {
                    if (deltaX < 0) {
                        showNext();
                    } else {
                        showPrev();
                    }
                }
                touchStartX = null;
            });

            lightbox.addEventListener("pointercancel", () => {
                touchStartX = null;
            });

            window.addEventListener("resize", () => {
                if (!lightbox.classList.contains("hidden")) {
                    render();
                }
            });
        };

        document.addEventListener("DOMContentLoaded", () => {
            // DaisyUI handles dropdown automatically via focus/blur, no custom JS needed
            // Just handle escape key for accessibility
            const menuRoot = document.querySelector("[data-user-menu]");
            if (menuRoot) {
                const trigger = menuRoot.querySelector("[data-user-menu-trigger]");
                const panel = menuRoot.querySelector("[data-user-menu-panel]");
                
                if (trigger && panel) {
                    // Make dropdown work properly
                    trigger.addEventListener("click", (e) => {
                        e.stopPropagation();
                        // Toggle visibility by managing focus
                        if (panel.classList.contains('hidden')) {
                            panel.classList.remove('hidden');
                            panel.focus();
                        } else {
                            panel.classList.add('hidden');
                        }
                    });
                    
                    // Close on outside click
                    document.addEventListener("click", (event) => {
                        if (!menuRoot.contains(event.target)) {
                            panel.classList.add('hidden');
                        }
                    });
                    
                    // Close on escape
                    document.addEventListener("keydown", (event) => {
                        if (event.key === "Escape") {
                            panel.classList.add('hidden');
                        }
                    });
                    
                    // Start hidden
                    panel.classList.add('hidden');
                }
            }

            initLightbox();

            const mobileMenuButton = document.getElementById('mobile-menu-button');
            const mobileMenu = document.getElementById('mobile-menu');

            if (mobileMenuButton && mobileMenu) {
                mobileMenuButton.addEventListener('click', () => {
                    const expanded = mobileMenuButton.getAttribute('aria-expanded') === 'true';
                    mobileMenuButton.setAttribute('aria-expanded', !expanded);
                    mobileMenu.classList.toggle('hidden');
                });
            }
        });

        // Theme toggle functionality
        function toggleTheme() {
            const html = document.documentElement;
            const currentTheme = html.getAttribute('data-theme') || 'light';
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';

            html.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            
            // Toggle dark class for Tailwind
            if (newTheme === 'dark') {
                html.classList.add('dark');
            } else {
                html.classList.remove('dark');
            }
            
            console.log('Theme toggled to:', newTheme, 'HTML classes:', html.className);
            
            updateThemeUI(newTheme);
        }

        function updateThemeUI(theme) {
            const isDark = theme === 'dark';
            const label = document.getElementById('theme-label');
            const icon = document.getElementById('theme-icon');
            const iconPublic = document.getElementById('theme-icon-public');

            if (label) {
                label.textContent = isDark ? '{{ _('Dark') }}' : '{{ _('Light') }}';
            }

            const iconClass = isDark ? 'mdi-weather-night' : 'mdi-weather-sunny';

            if (icon) {
                icon.className = `mdi ${iconClass} text-lg`;
            }

            if (iconPublic) {
                iconPublic.className = `mdi ${iconClass} text-xl`;
            }
        }

        // Initialize theme UI on page load
        document.addEventListener('DOMContentLoaded', () => {
            const currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
            updateThemeUI(currentTheme);
        });

        document.body.addEventListener("htmx:responseError", async (event) => {
            const fallback = "{{ _('Something went wrong. Please try again.') }}";
            const message = await extractErrorMessage(event.detail.xhr, fallback);
            showToast(message, "error");
        });
    </script>
</body>
</html>
