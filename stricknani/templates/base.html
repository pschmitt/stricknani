<!DOCTYPE html>
<html lang="{{ current_language }}" class="h-full antialiased transition-colors duration-200">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}{{ _('Stricknani') }}{% endblock %}</title>
    <meta name="csrf-token" content="{{ csrf_token }}">
    {% block head %}{% endblock %}
    <link rel="icon" type="image/svg+xml"
        href="{% if is_dev_instance %}/static/favicon-dev.svg{% else %}/static/favicon.svg{% endif %}">
    <link rel="stylesheet" href="{{ url_for('static', path='vendor/mdi/css/materialdesignicons.min.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', path='vendor/photoswipe/photoswipe.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', path='css/app.css') }}">
    <script>
        window.STRICKNANI = window.STRICKNANI || {};
        window.STRICKNANI.i18n = {{
            {
                'cancel': _('Cancel'),
                    'confirm': _('Confirm'),
                        'copiedToClipboard': _('Copied to clipboard'),
                            'darkMode': _('Dark Mode'),
                                'dismissMessage': _('Dismiss message'),
                                    'failedToCopy': _('Failed to copy'),
                                        'failedToUploadImage': _('Failed to upload image'),
                                            'imageCropperFailedToLoad': _('Image cropper failed to load'),
                                                'lightMode': _('Light Mode'),
                                                    'nothingToPreview': _('Nothing to preview'),
                                                        'onlyImages': _('Only image files are supported'),
                                                            'pswpDeleteImage': _('Delete image'),
                                                                'pswpDownloadImage': _('Download image'),
                                                                    'pswpExtractText': _('Extract text'),
                                                                        'pswpExtractingText': _('Extracting text...'),
                                                                            'pswpGalleryThumbnails': _('Gallery thumbnails'),
                                                                                'pswpImageCannotBeProcessed': _('This image cannot be processed.'),
                                                                                    'pswpNoTextDetected': _('No text detected.'),
                                                                                        'pswpOcrFailed': _('OCR failed.'),
                                                                                            'pswpOcrNotAvailable': _('OCR is not available on this server.'),
                                                                                                'pswpOpenImage': _('Open image'),
                                                                                                    'pswpSetAsPrimary': _('Set as primary'),
                                                                                                        'pswpTextExtracted': _('Text extracted.'),
                                                                                                            'profilePictureUpdatedSuccessfully': _('Profile picture updated successfully'),
                                                                                                                'reloadPage': _('Reload page'),
                                                                                                                    'sessionExpiredMessage': _('Your session has expired. Reload the page to continue.'),
                                                                                                                        'sessionExpiredTitle': _('Session expired'),
                                                                                                                            'somethingWentWrong': _('Something went wrong. Please try again'),
                                                                                                                                'uploading': _('Uploading...'),
        } | tojson
        }};
        window.STRICKNANI.toastMessages = {{
            {
                'project_created': _('Project created successfully'),
                    'project_updated': _('Project updated successfully'),
                        'project_deleted': _('Project deleted'),
                            'yarn_created': _('Yarn created successfully'),
                                'yarn_updated': _('Yarn updated successfully'),
                                    'yarn_deleted': _('Yarn deleted'),
                                        'profile_updated': _('Profile updated successfully'),
                                            'category_created': _('Category created'),
                                                'category_updated': _('Category updated'),
                                                    'category_deleted': _('Category deleted'),
                                                        'archive_requested': {
                    'message': _('Archive snapshot request queued'),
                        'variant': 'success',
            },
                'archive_request_unavailable': {
                    'message': _('Archive snapshot request unavailable'),
                        'variant': 'info',
            },
            } | tojson
        }};
    </script>
    <script src="{{ url_for('static', path='js/app.js') }}"></script>
    <script src="{{ url_for('static', path='vendor/cropperjs/cropper.min.js') }}"></script>
    <script>
        // Theme initialization - MUST run before page renders
        (function () {
            let theme = localStorage.getItem('theme');
            if (!theme) {
                if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                    theme = 'dark';
                } else {
                    theme = 'light';
                }
            }
            document.documentElement.setAttribute('data-theme', theme);
            // Also set dark class for Tailwind dark mode
            if (theme === 'dark') {
                document.documentElement.classList.add('dark');
            }
        })();
    </script>


    <link href="{{ url_for('static', path='vendor/daisyui/daisyui.css') }}" rel="stylesheet" type="text/css" />
    <link href="{{ url_for('static', path='vendor/daisyui/themes.css') }}" rel="stylesheet" type="text/css" />
    <script src="{{ url_for('static', path='vendor/tailwindcss-browser/index.global.js') }}"></script>
    <script src="{{ url_for('static', path='vendor/htmx/htmx.min.js') }}"></script>
    <script src="{{ url_for('static', path='js/htmx/csrf.js') }}"></script>
</head>

<body class="min-h-screen bg-base-300 flex flex-col">
    {% import "macros/dialogs.html" as dialogs %}

    {% block navbar %}
    {# Default navbar - pages can override this block #}
    {% endblock %}

    <main class="flex-grow w-full" {% block main_attrs %}{% endblock %}>
        {% block content %}{% endblock %}
    </main>

    <footer class="mt-8 py-4 text-center text-sm text-base-content/70 bg-base-100 border-t border-base-300">
        <span class="mdi mdi-yarn mr-1 align-middle"></span>{{ _('Stricknani') }} v0.1.0 | {{ _('GPL-3.0-only')
        }}
        <a href="https://github.com/pschmitt/stricknani" target="_blank" rel="noopener noreferrer"
            class="ml-2 text-base-content/70 hover:text-base-content" aria-label="GitHub">
            <span class="mdi mdi-github text-lg align-middle"></span>
        </a>
    </footer>

    {% if current_user %}
    <!-- Profile Image Upload Tools -->
    <input type="file" id="profile-image-input" class="hidden" accept="image/*">
    <dialog id="crop-modal" class="modal modal-bottom sm:modal-middle">
        <div class="modal-box max-w-lg">
            <h3 class="font-bold text-lg mb-4">{{ _('Crop Profile Picture') }}</h3>
            <div id="avatar-crop-container" class="relative h-96 w-full rounded-lg bg-base-300 overflow-hidden">
                <img id="crop-image" src="" alt="Image to crop" class="max-h-full max-w-full">
                <div id="avatar-crop-overlay" class="avatar-crop-overlay" aria-hidden="true"></div>
            </div>
            <div class="modal-action">
                {{ dialogs.dialog_cancel(_('Cancel'), id='crop-cancel') }}
                {{ dialogs.dialog_primary(_('Save & Upload'), icon='mdi-cloud-upload', id='crop-save') }}
            </div>
        </div>
        {{ dialogs.modal_backdrop() }}
    </dialog>

    <script>
        window.STRICKNANI = window.STRICKNANI || {};
        window.STRICKNANI.profileCropper = {
            currentUserId: {{ current_user.id }},
        };
    </script>
    <script src="{{ url_for('static', path='js/features/profile_cropper.js') }}"></script>
    {% endif %}

    {% if current_user %}
    <dialog id="globalSearchModal"
        class="modal modal-top sm:modal-middle backdrop:bg-base-300/80 backdrop:backdrop-blur-sm">
        <div
            class="modal-box max-w-2xl p-0 overflow-hidden shadow-2xl border border-base-300 bg-base-100 rounded-2xl sm:mt-0 mt-4 mx-2 sm:mx-auto">
            <div class="relative flex items-center border-b border-base-300 px-4 py-2 bg-base-200/50">
                <span class="mdi mdi-magnify text-2xl opacity-40 mr-3"></span>
                <input type="text" id="globalSearchInput" name="q" placeholder="{{ _('Search projects, yarns...') }}"
                    class="input border-none bg-transparent w-full focus:outline-none focus:ring-0 px-0 h-12 text-lg font-medium"
                    hx-get="/search/global" hx-trigger="keyup changed delay:300ms" hx-target="#globalSearchResults"
                    hx-indicator="#globalSearchIndicator" autocomplete="off">
                <div id="globalSearchIndicator" class="htmx-indicator ml-2">
                    <span class="loading loading-spinner loading-sm opacity-40"></span>
                </div>
                <div class="flex items-center gap-1 ml-auto shrink-0 pl-4">
                    <kbd class="kbd kbd-sm bg-base-300 border-base-content/10 font-bold opacity-60">ESC</kbd>
                </div>
            </div>
            <div id="globalSearchResults" class="max-h-[60vh] overflow-y-auto">
                <div class="py-12 text-center text-base-content/30 italic">
                    <span class="mdi mdi-keyboard-outline text-4xl block mb-2"></span>
                    <p>{{ _('Start typing to search...') }}</p>
                </div>
            </div>
            <div
                class="bg-base-200/50 px-4 py-2 text-[10px] font-bold uppercase tracking-widest opacity-40 flex justify-between border-t border-base-300">
                <span>{{ _('↑↓ to navigate') }}</span>
                <span>{{ _('Enter to select') }}</span>
            </div>
        </div>
        <form method="dialog" class="modal-backdrop">
            <button>close</button>
        </form>
    </dialog>

    <script src="{{ url_for('static', path='js/features/global_search_modal.js') }}"></script>
    {% endif %}

    <div id="toastContainer"
        class="fixed inset-x-4 top-[4.5rem] z-[2147483647] mx-auto flex max-w-sm flex-col gap-3 sm:inset-auto sm:right-4 sm:top-[4.5rem] sm:w-80"
        aria-live="polite" aria-atomic="true"></div>

    <dialog id="confirmationDialog" class="modal modal-bottom sm:modal-middle backdrop:bg-slate-900/50">
        <div class="modal-box p-0 overflow-hidden bg-base-100 shadow-2xl rounded-2xl w-full max-w-sm sm:max-w-md">
            <div class="bg-warning/10 p-6 flex items-center gap-4 text-warning" id="confirmationHeader">
                <span class="mdi mdi-alert-circle-outline text-3xl"></span>
                <div>
                    <h3 class="font-bold text-lg" id="confirmationTitle">{{ _('Confirm Action') }}</h3>
                </div>
            </div>

            <div class="p-6">
                <p class="text-base-content/80 text-sm leading-relaxed" id="confirmationMessage">
                    {{ _('Are you sure you want to proceed?') }}
                </p>
                <div id="confirmationContent" class="hidden mt-4 text-left bg-base-200 p-3 rounded text-xs opacity-70">
                </div>
            </div>

            <div class="p-4 bg-base-200/30 border-t border-base-200 flex justify-end gap-3">
                <form method="dialog" class="contents">
                    <button type="submit" id="confirmationCancel" class="btn btn-ghost">
                        {{ _('Cancel') }}
                    </button>
                    <button type="button" id="confirmationConfirm" class="btn btn-warning gap-2">
                        <span class="mdi mdi-check"></span>
                        {{ _('Confirm') }}
                    </button>
                </form>
            </div>
        </div>
        {{ dialogs.modal_backdrop() }}
    </dialog>

    <dialog id="pdfViewerDialog" class="modal">
        <div class="modal-box w-screen h-screen max-w-none p-0 overflow-hidden rounded-none flex flex-col">
            <div class="flex items-center justify-between gap-4 p-4 border-b border-base-200 bg-base-100">
                <div class="min-w-0">
                    <h3 class="font-bold text-lg" id="pdfViewerTitle">{{ _('Preview') }}</h3>
                    <p class="text-xs text-base-content/60 truncate" id="pdfViewerFilename"></p>
                </div>
                <div class="flex items-center gap-2 shrink-0">
                    <a id="pdfViewerDownload" class="btn btn-ghost btn-sm btn-circle" target="_blank" rel="noreferrer"
                        title="{{ _('Download') }}">
                        <span class="mdi mdi-download text-xl"></span>
                    </a>
                    <form method="dialog">
                        <button class="btn btn-ghost btn-sm btn-circle" aria-label="{{ _('close') }}">
                            <span class="mdi mdi-close text-xl"></span>
                        </button>
                    </form>
                </div>
            </div>
            <div class="flex-1 bg-base-200/30">
                <iframe id="pdfViewerFrame" class="w-full h-full" src="about:blank" title="{{ _('Preview') }}"></iframe>
            </div>
        </div>
        {{ dialogs.modal_backdrop() }}
    </dialog>

    <dialog id="imageViewerDialog" class="modal">
        <div class="modal-box w-screen h-screen max-w-none p-0 overflow-hidden rounded-none flex flex-col">
            <div class="flex items-center justify-between gap-4 p-4 border-b border-base-200 bg-base-100">
                <div class="min-w-0">
                    <h3 class="font-bold text-lg" id="imageViewerTitle">{{ _('Preview') }}</h3>
                    <p class="text-xs text-base-content/60 truncate" id="imageViewerFilename"></p>
                </div>
                <div class="flex items-center gap-2 shrink-0">
                    <a id="imageViewerDownload" class="btn btn-ghost btn-sm btn-circle" target="_blank" rel="noreferrer"
                        title="{{ _('Download') }}">
                        <span class="mdi mdi-download text-xl"></span>
                    </a>
                    <form method="dialog">
                        <button class="btn btn-ghost btn-sm btn-circle" aria-label="{{ _('close') }}">
                            <span class="mdi mdi-close text-xl"></span>
                        </button>
                    </form>
                </div>
            </div>
            <div class="flex-1 bg-black/90 p-3 sm:p-4 overflow-auto">
                <div class="min-h-full flex items-center justify-center">
                    <img id="imageViewerImage" class="block max-w-full max-h-full object-contain" src="about:blank"
                        alt="">
                </div>
            </div>
        </div>
        {{ dialogs.modal_backdrop() }}
    </dialog>

    <dialog id="pswpOcrDialog" class="modal modal-bottom sm:modal-middle">
        <div
            class="modal-box w-screen h-screen max-w-none p-0 overflow-hidden rounded-none flex flex-col sm:w-[min(1100px,calc(100vw-4rem))] sm:h-[min(85vh,900px)] sm:rounded-box">
            <div class="flex items-center justify-between gap-4 p-4 border-b border-base-200 bg-base-100">
                <div class="min-w-0">
                    <h3 class="font-bold text-lg">{{ _('OCR') }}</h3>
                    <p class="text-xs text-base-content/60 truncate" id="pswpOcrFilename"></p>
                </div>
                <div class="flex items-center gap-2 shrink-0">
                    <button id="pswpOcrCopy" type="button" class="btn btn-ghost btn-sm btn-circle"
                        title="{{ _('Copy text') }}" aria-label="{{ _('Copy text') }}" disabled>
                        <span class="mdi mdi-content-copy text-xl"></span>
                    </button>
                    <button id="pswpOcrRetry" type="button" class="btn btn-ghost btn-sm btn-circle"
                        title="{{ _('Retry') }}" aria-label="{{ _('Retry') }}">
                        <span class="mdi mdi-refresh text-xl"></span>
                    </button>
                    <form method="dialog">
                        <button class="btn btn-ghost btn-sm btn-circle" aria-label="{{ _('close') }}">
                            <span class="mdi mdi-close text-xl"></span>
                        </button>
                    </form>
                </div>
            </div>
            <div class="flex-1 min-h-0 bg-base-100 p-4 overflow-auto">
                <div class="flex min-h-0 flex-col">
                    <div id="pswpOcrStatus" class="text-sm text-base-content/70"></div>
                    <div class="relative mt-3 flex-1 min-h-0">
                        <div id="pswpOcrLoadingOverlay"
                            class="absolute inset-0 hidden rounded-lg border border-base-300 bg-base-100/95 backdrop-blur-sm">
                            <div class="flex h-full w-full items-center justify-center p-4">
                                <div class="flex items-center gap-3 text-base-content/80">
                                    <span id="pswpOcrSpinner" class="loading loading-spinner loading-sm text-primary"
                                        aria-hidden="true"></span>
                                    <div id="pswpOcrLoadingStatus" class="text-sm"></div>
                                </div>
                            </div>
                        </div>
                        <pre id="pswpOcrText"
                            class="h-full min-h-40 overflow-auto whitespace-pre-wrap break-words rounded-lg border border-base-300 bg-base-100 p-3 text-sm text-base-content/90"></pre>
                    </div>
                </div>
            </div>
        </div>
        {{ dialogs.modal_backdrop() }}
    </dialog>

    <dialog id="pswpCropDialog" class="modal modal-bottom sm:modal-middle">
        <div
            class="modal-box w-full max-w-5xl h-[90vh] p-0 overflow-hidden flex flex-col bg-base-100 rounded-box shadow-xl">
            <!-- Header -->
            <div class="flex items-center justify-between px-6 py-4 border-b border-base-200 bg-base-100 z-10">
                <div class="min-w-0 flex items-center gap-3">
                    <div class="p-2 rounded-lg bg-primary/10 text-primary">
                        <span class="mdi mdi-crop text-xl"></span>
                    </div>
                    <div>
                        <h3 class="font-bold text-lg leading-tight">{{ _('Crop Image') }}</h3>
                        <p class="text-xs text-base-content/60 truncate max-w-[200px] sm:max-w-md"
                            id="pswpCropFilename"></p>
                    </div>
                </div>
                <div class="flex items-center gap-2">
                    <button id="pswpCropReset" type="button" class="btn btn-ghost btn-sm gap-2 normal-case"
                        title="{{ _('Reset crop') }}">
                        <span class="mdi mdi-refresh text-lg"></span>
                        <span class="hidden sm:inline">{{ _('Reset') }}</span>
                    </button>
                    <form method="dialog">
                        <button class="btn btn-ghost btn-sm btn-circle" aria-label="{{ _('Close') }}">
                            <span class="mdi mdi-close text-xl"></span>
                        </button>
                    </form>
                </div>
            </div>

            <!-- Crop Area -->
            <div class="flex-1 min-h-0 bg-base-300 relative group overflow-hidden">
                <!-- Checkerboard pattern for transparency -->
                <div class="absolute inset-0 opacity-20 pointer-events-none"
                    style="background-image: radial-gradient(#000 1px, transparent 1px); background-size: 20px 20px;">
                </div>

                <div class="w-full h-full p-4 sm:p-8" id="pswpCropContainer">
                    <img id="pswpCropImage" class="max-w-full block opacity-0 transition-opacity duration-300" src=""
                        alt="">
                </div>

                <!-- Loading Overlay -->
                <div id="pswpCropLoading"
                    class="absolute inset-0 z-20 flex items-center justify-center bg-base-100/50 backdrop-blur-sm transition-opacity duration-200 opacity-0 pointer-events-none">
                    <span class="loading loading-spinner loading-lg text-primary"></span>
                </div>
            </div>

            <!-- Footer -->
            <div class="p-4 sm:px-6 border-t border-base-200 bg-base-100 z-10">
                <div class="flex items-center justify-between gap-4">
                    <div class="text-xs text-base-content/50 hidden sm:block">
                        <span class="mdi mdi-information-outline mr-1"></span>
                        {{ _('Drag to crop, scroll to zoom') }}
                    </div>
                    <div class="flex justify-end gap-3 flex-1">
                        <form method="dialog">
                            {{ dialogs.dialog_cancel(_('Cancel'), type='submit') }}
                        </form>
                        {{ dialogs.dialog_primary(_('Save Crop'), icon='mdi-content-save', type='button',
                        id='pswpCropSave') }}
                    </div>
                </div>
            </div>
        </div>
        {{ dialogs.modal_backdrop() }}
    </dialog>

    <div id="swipe-indicator-left"
        class="fixed left-4 top-1/2 -translate-y-1/2 z-[100] transition-all duration-200 opacity-0 pointer-events-none scale-75">
        <div
            class="bg-base-100/90 backdrop-blur-sm rounded-full p-4 shadow-xl border border-base-content/10 text-primary">
            <span class="mdi mdi-arrow-left text-4xl"></span>
        </div>
    </div>
    <div id="swipe-indicator-right"
        class="fixed right-4 top-1/2 -translate-y-1/2 z-[100] transition-all duration-200 opacity-0 pointer-events-none scale-75">
        <div
            class="bg-base-100/90 backdrop-blur-sm rounded-full p-4 shadow-xl border border-base-content/10 text-primary">
            <span class="mdi mdi-arrow-right text-4xl"></span>
        </div>
    </div>

    <script>
        window.STRICKNANI = window.STRICKNANI || {};
        window.STRICKNANI.photoswipe = {
            ocrEndpoint: "/utils/ocr",
            pswpModuleUrl: "{{ url_for('static', path='vendor/photoswipe/photoswipe.esm.min.js') }}",
        };
    </script>
    <script type="module">
        import PhotoSwipeLightbox from "{{ url_for('static', path='vendor/photoswipe/photoswipe-lightbox.esm.min.js') }}";
        window.STRICKNANI.photoswipe.PhotoSwipeLightbox = PhotoSwipeLightbox;
        import("{{ url_for('static', path='js/features/photoswipe.js') }}");
    </script>
    <script src="{{ url_for('static', path='js/features/navbar_dropdowns.js') }}"></script>
    <script src="{{ url_for('static', path='js/features/swipe_nav.js') }}"></script>
    {% if sentry_frontend_enabled %}
    <script src="{{ url_for('static', path='vendor/sentry/bundle.tracing.min.js') }}"></script>
    <script>
        Sentry.init({
            dsn: {{ sentry_frontend_dsn | tojson }},
            environment: {{ sentry_frontend_env | tojson }},
            tracesSampleRate: {{ sentry_frontend_traces_sample_rate }}
        });
    </script>
    {% endif %}
</body>

</html>