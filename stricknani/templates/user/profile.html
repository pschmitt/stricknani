{% extends "base.html" %}

{% block title %}{{ _('User Profile') }} - Stricknani{% endblock %}

{% block head %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cropperjs@1.6.1/dist/cropper.min.css">
<script src="https://cdn.jsdelivr.net/npm/cropperjs@1.6.1/dist/cropper.min.js"></script>
<style>
    .cropper-view-box,
    .cropper-face {
        border-radius: 50%;
    }
    /* The following styles are to make the image round in the preview */
    .cropper-view-box {
        outline: 0;
        box-shadow: 0 0 0 1px #39f;
    }
</style>
{% endblock %}

{% block content %}
<section class="space-y-6">
    <header class="border-b border-slate-200 pb-4 dark:border-slate-700">
        <h1 class="text-3xl font-semibold text-slate-900 dark:text-slate-100 flex items-center gap-2">
            <span class="mdi mdi-account-details-outline text-blue-600 dark:text-blue-400"></span>
            {{ _('User Profile') }}
        </h1>
        <p class="mt-2 text-slate-600 dark:text-slate-300 max-w-2xl">
            {{ _('Manage your account settings and preferences.') }}
        </p>
    </header>

    <div class="grid gap-6 lg:grid-cols-3">
        <article class="rounded-xl border border-slate-200 bg-white/80 p-6 shadow-sm transition-colors dark:border-slate-700 dark:bg-slate-900/70 lg:row-span-2">
            <h2 class="text-xl font-semibold text-slate-900 dark:text-slate-100 flex items-center gap-2">
                <span class="mdi mdi-account-circle-outline text-blue-600 dark:text-blue-400"></span>
                {{ _('Profile picture') }}
            </h2>
            <p class="mt-2 text-sm text-slate-600 dark:text-slate-300">
                {{ _('Upload a friendly face so it is easier to recognize your projects at a glance.') }}
            </p>
            <div class="mt-6" id="profile-avatar-container">
                {% include "user/_profile_avatar.html" %}
            </div>
            <form class="hidden">
                <input
                    id="profile-image"
                    name="file"
                    type="file"
                    accept="image/*"
                >
            </form>
        </article>
        <article class="rounded-xl border border-slate-200 bg-white/80 p-6 shadow-sm transition-colors dark:border-slate-700 dark:bg-slate-900/70 lg:col-span-2 lg:row-span-2">
            <h2 class="text-xl font-semibold text-slate-900 dark:text-slate-100 flex items-center gap-2">
                <span class="mdi mdi-translate text-blue-600 dark:text-blue-400"></span>
                {{ _('Language') }}
            </h2>
            <p class="mt-2 text-sm text-slate-600 dark:text-slate-300">
                {{ _('Pick the language Stricknani should use across the interface.') }}
            </p>
            {% set language_options = {
                'en': {'label': _('English'), 'icon': 'üá¨üáß'},
                'de': {'label': _('German'), 'icon': 'üá©üá™'}
            } %}
            <form action="/auth/set-language" method="post" class="mt-6 space-y-4">
                <input type="hidden" name="next" value="{{ request.url.path }}{% if request.url.query %}?{{ request.url.query }}{% endif %}">
                <div class="grid gap-3 sm:grid-cols-2">
                    {% for code in supported_languages %}
                    {% set option = language_options.get(code, {'label': code|upper, 'icon': 'üåê'}) %}
                    {% set is_active = code == current_language %}
                    <label class="flex cursor-pointer items-center gap-3 rounded-lg border px-4 py-3 text-sm font-medium transition focus-within:ring-2 focus-within:ring-blue-500 focus-within:ring-offset-2 dark:focus-within:ring-offset-slate-900 {{ 'border-blue-500 bg-blue-50 text-blue-700 dark:border-blue-400 dark:bg-slate-800/70 dark:text-blue-100' if is_active else 'border-slate-200 bg-white text-slate-900 hover:border-blue-300 hover:bg-blue-50 dark:border-slate-700 dark:bg-slate-900/60 dark:text-slate-200 dark:hover:border-blue-500 dark:hover:bg-blue-500/10' }}">
                        <input
                            type="radio"
                            name="language"
                            value="{{ code }}"
                            class="sr-only"
                            {% if is_active %}checked{% endif %}
                            onchange="this.form.submit()"
                        >
                        <span class="text-2xl" aria-hidden="true">{{ option.icon }}</span>
                        <span>{{ option.label }}</span>
                    </label>
                    {% endfor %}
                </div>
                <p class="text-xs text-slate-500 dark:text-slate-400">
                    {{ _('We reload the page right away so translations take effect.') }}
                </p>
            </form>
        </article>
    </div>

    <article class="rounded-xl border border-slate-200 bg-white/80 p-6 shadow-sm transition-colors dark:border-slate-700 dark:bg-slate-900/70">
        <div class="flex items-center justify-between gap-4">
            <div class="flex items-center gap-2">
                <span class="mdi mdi-star-circle-outline text-blue-600 text-2xl dark:text-blue-400"></span>
                <h2 class="text-xl font-semibold text-slate-900 dark:text-slate-100">
                    {{ _('Favorite projects') }}
                </h2>
            </div>
        </div>
        <p class="mt-2 text-sm text-slate-600 dark:text-slate-300">
            {{ _('Quick access to the projects you reach for most often.') }}
        </p>
        {% if favorites %}
        <ul class="mt-6 space-y-4">
            {% for project in favorites %}
            <li class="rounded-lg border border-slate-200 bg-white/70 p-4 shadow-sm transition hover:border-blue-300 hover:shadow-md dark:border-slate-700 dark:bg-slate-900/60 dark:hover:border-blue-500" data-favorite-item>
                <div class="flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
                    <div>
                        <p class="text-lg font-semibold text-slate-900 dark:text-slate-100 flex items-center gap-2">
                            <span class="mdi mdi-text-box-outline text-blue-500 dark:text-blue-300"></span>
                            {{ project.name }}
                        </p>
                        <p class="text-sm text-slate-500 dark:text-slate-300">
                            {{ _('Last updated on %(date)s', date=project.updated_at.strftime('%Y-%m-%d')) }}
                        </p>
                    </div>
                    <div class="flex gap-2">
                        <a
                            href="/projects/{{ project.id }}"
                            class="inline-flex items-center gap-2 rounded-md bg-blue-50 px-3 py-2 text-sm font-medium text-blue-700 transition hover:bg-blue-100 focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-blue-400/10 dark:text-blue-300 dark:hover:bg-blue-400/20"
                        >
                            <span class="mdi mdi-eye-outline"></span>
                            {{ _('View project') }}
                        </a>
                        <button
                            type="button"
                            hx-delete="/projects/{{ project.id }}/favorite?variant=profile"
                            hx-target="closest [data-favorite-item]"
                            hx-swap="outerHTML"
                            hx-on::after-request="if (event.detail.successful) { showToast('{{ _('Removed from favorites') }}', 'info'); }"
                            class="inline-flex items-center gap-2 rounded-md bg-red-50 px-3 py-2 text-sm font-medium text-red-600 transition hover:bg-red-100 focus:outline-none focus:ring-2 focus:ring-red-500 dark:bg-red-400/10 dark:text-red-300 dark:hover:bg-red-400/20"
                        >
                            <span class="mdi mdi-star-off-outline"></span>
                            {{ _('Remove') }}
                        </button>
                    </div>
                </div>
            </li>
            {% endfor %}
        </ul>
        {% else %}
        <div class="mt-6 rounded-lg border border-dashed border-slate-300 p-6 text-center text-slate-500 dark:border-slate-600 dark:text-slate-300">
            <span class="mdi mdi-star-outline text-4xl"></span>
            <p class="mt-3 font-medium">{{ _('You have not favorited any projects yet.') }}</p>
            <p class="mt-1 text-sm">
                <a href="/projects" class="text-blue-600 hover:underline dark:text-blue-400">{{ _('Browse projects') }}</a>
                {{ _('to add them to your favorites.') }}
            </p>
        </div>
        {% endif %}
    </article>

    <article class="rounded-xl border border-slate-200 bg-white/80 p-6 shadow-sm transition-colors dark:border-slate-700 dark:bg-slate-900/70">
        <div class="flex items-center justify-between gap-4">
            <div class="flex items-center gap-2">
                <span class="mdi mdi-heart-circle-outline text-pink-600 text-2xl dark:text-pink-400"></span>
                <h2 class="text-xl font-semibold text-slate-900 dark:text-slate-100">
                    {{ _('Favorite yarns') }}
                </h2>
            </div>
        </div>
        <p class="mt-2 text-sm text-slate-600 dark:text-slate-300">
            {{ _('Your go-to stash entries.') }}
        </p>
        {% if favorite_yarns %}
        <ul class="mt-6 space-y-4">
            {% for yarn in favorite_yarns %}
            <li class="rounded-lg border border-slate-200 bg-white/70 p-4 shadow-sm transition hover:border-pink-300 hover:shadow-md dark:border-slate-700 dark:bg-slate-900/60 dark:hover:border-pink-500" data-favorite-yarn-item>
                <div class="flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
                    <div>
                        <p class="text-lg font-semibold text-slate-900 dark:text-slate-100 flex items-center gap-2">
                            <span class="mdi mdi-yarn text-pink-500 dark:text-pink-300"></span>
                            {{ yarn.name }}
                        </p>
                        <p class="text-sm text-slate-500 dark:text-slate-300">
                            {% if yarn.brand %}{{ yarn.brand }} ‚Ä¢ {% endif %}{{ _('Added on %(date)s', date=yarn.created_at.strftime('%Y-%m-%d')) }}
                        </p>
                    </div>
                    <div class="flex gap-2">
                        <a
                            href="/yarn/{{ yarn.id }}"
                            class="inline-flex items-center gap-2 rounded-md bg-pink-50 px-3 py-2 text-sm font-medium text-pink-700 transition hover:bg-pink-100 focus:outline-none focus:ring-2 focus:ring-pink-500 dark:bg-pink-400/10 dark:text-pink-300 dark:hover:bg-pink-400/20"
                        >
                            <span class="mdi mdi-eye-outline"></span>
                            {{ _('View yarn') }}
                        </a>
                        <button
                            type="button"
                            hx-post="/yarn/{{ yarn.id }}/favorite?variant=profile"
                            hx-target="closest [data-favorite-yarn-item]"
                            hx-swap="outerHTML"
                            hx-on::after-request="if (event.detail.successful) { showToast('{{ _('Removed from favorites') }}', 'info'); }"
                            class="inline-flex items-center gap-2 rounded-md bg-red-50 px-3 py-2 text-sm font-medium text-red-600 transition hover:bg-red-100 focus:outline-none focus:ring-2 focus:ring-red-500 dark:bg-red-400/10 dark:text-red-300 dark:hover:bg-red-400/20"
                        >
                            <span class="mdi mdi-heart-off-outline"></span>
                            {{ _('Remove') }}
                        </button>
                    </div>
                </div>
            </li>
            {% endfor %}
        </ul>
        {% else %}
        <div class="mt-6 rounded-lg border border-dashed border-slate-300 p-6 text-center text-slate-500 dark:border-slate-600 dark:text-slate-300">
            <span class="mdi mdi-heart-outline text-4xl"></span>
            <p class="mt-3 font-medium">{{ _('You have not favorited any yarns yet.') }}</p>
            <p class="mt-1 text-sm">
                <a href="/yarn" class="text-blue-600 hover:underline dark:text-blue-400">{{ _('Browse yarn stash') }}</a>
                {{ _('to add them to your favorites.') }}
            </p>
        </div>
        {% endif %}
    </article>
</section>

<!-- Crop Modal -->
<div id="crop-modal" class="fixed inset-0 z-50 hidden overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <div class="flex min-h-screen items-end justify-center px-4 pb-20 pt-4 text-center sm:block sm:p-0">
        <div class="fixed inset-0 bg-slate-500 bg-opacity-75 transition-opacity" aria-hidden="true"></div>
        <span class="hidden sm:inline-block sm:h-screen sm:align-middle" aria-hidden="true">&#8203;</span>
        <div class="inline-block transform overflow-hidden rounded-lg bg-white text-left align-bottom shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-lg sm:align-middle dark:bg-slate-800">
            <div class="bg-white px-4 pb-4 pt-5 sm:p-6 sm:pb-4 dark:bg-slate-800">
                <div class="sm:flex sm:items-start">
                    <div class="mt-3 w-full text-center sm:ml-4 sm:mt-0 sm:text-left">
                        <h3 class="text-lg font-medium leading-6 text-slate-900 dark:text-slate-100" id="modal-title">
                            {{ _('Crop Profile Picture') }}
                        </h3>
                        <div class="mt-4">
                            <div class="relative h-96 w-full rounded-lg bg-slate-100 dark:bg-slate-900">
                                <img id="crop-image" src="" alt="Image to crop" class="max-h-full max-w-full">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="bg-slate-50 px-4 py-3 sm:flex sm:flex-row-reverse sm:px-6 dark:bg-slate-800/50">
                <button
                    type="button"
                    id="crop-save"
                    class="inline-flex w-full justify-center rounded-md border border-transparent bg-blue-600 px-4 py-2 text-base font-medium text-white shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 sm:ml-3 sm:w-auto sm:text-sm dark:focus:ring-offset-slate-800"
                >
                    {{ _('Save & Upload') }}
                </button>
                <button
                    type="button"
                    id="crop-cancel"
                    class="mt-3 inline-flex w-full justify-center rounded-md border border-slate-300 bg-white px-4 py-2 text-base font-medium text-slate-900 shadow-sm hover:bg-slate-50 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm dark:border-slate-600 dark:bg-slate-700 dark:text-slate-200 dark:hover:bg-slate-600 dark:focus:ring-offset-slate-800"
                >
                    {{ _('Cancel') }}
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        let cropper;
        const input = document.getElementById('profile-image');
        const modal = document.getElementById('crop-modal');
        const image = document.getElementById('crop-image');
        const saveBtn = document.getElementById('crop-save');
        const cancelBtn = document.getElementById('crop-cancel');

        input.addEventListener('change', function(e) {
            const files = e.target.files;
            if (files && files.length > 0) {
                const file = files[0];
                const reader = new FileReader();
                reader.onload = function(e) {
                    image.src = e.target.result;
                    modal.classList.remove('hidden');

                    if (cropper) {
                        cropper.destroy();
                    }
                    cropper = new Cropper(image, {
                        aspectRatio: 1,
                        viewMode: 1,
                        dragMode: 'move',
                        autoCropArea: 1,
                        restore: false,
                        guides: false,
                        center: false,
                        highlight: false,
                        cropBoxMovable: false,
                        cropBoxResizable: false,
                        toggleDragModeOnDblclick: false,
                        zoomable: true,
                        zoomOnTouch: true,
                        zoomOnWheel: true,
                    });
                };
                reader.readAsDataURL(file);
            }
        });

        cancelBtn.addEventListener('click', function() {
            modal.classList.add('hidden');
            input.value = '';
            if (cropper) {
                cropper.destroy();
                cropper = null;
            }
        });

        saveBtn.addEventListener('click', function() {
            if (!cropper) return;

            const canvas = cropper.getCroppedCanvas({
                width: 400,
                height: 400,
            });

            canvas.toBlob(function(blob) {
                const formData = new FormData();
                formData.append('file', blob, 'avatar.png');

                // Show loading state
                const originalText = saveBtn.textContent;
                saveBtn.textContent = '{{ _("Uploading...") }}';
                saveBtn.disabled = true;

                fetch('/user/profile-image', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'HX-Request': 'true'
                    }
                })
                .then(response => {
                    if (!response.ok) throw new Error('Upload failed');
                    return response.text();
                })
                .then(html => {
                    const container = document.querySelector('#profile-avatar-container [data-profile-avatar]');
                    if (container) {
                        container.outerHTML = html;
                    }
                    modal.classList.add('hidden');
                    input.value = '';
                    if (cropper) {
                        cropper.destroy();
                        cropper = null;
                    }
                    showToast('{{ _("Profile picture updated successfully!") }}', 'success');
                })
                .catch(err => {
                    console.error(err);
                    showToast('{{ _("Failed to upload image.") }}', 'error');
                })
                .finally(() => {
                    saveBtn.textContent = originalText;
                    saveBtn.disabled = false;
                });
            }, 'image/png');
        });
    });
</script>
{% endblock %}
