{% extends "base.html" %}
{% import "macros/buttons.html" as buttons %}
{% import "macros/dialogs.html" as dialogs %}
{% import "macros/image_upload.html" as uploads %}

{# Set variables for the unified navbar #}
{% set page_title %}{{ _('Admin') }}{% endset %}
{% set page_actions %}
{{ buttons.primary(_('New User'), type='button', icon='mdi-account-plus', class='hidden md:inline-flex',
attrs='data-call="openCreateUserDialog"') }}
<!-- Mobile FAB -->
{{ buttons.fab('mdi-plus', type='button', label=_('New User'), class='md:hidden',
attrs='data-call="openCreateUserDialog"') }}
{% endset %}

{% block navbar %}
{% include "shared/unified_navbar.html" %}
{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <div class="flex flex-col gap-8">
        <div class="flex items-center justify-between">
            <h1 class="text-2xl font-bold flex items-center gap-2">
                {{ _('Users') }}
                <span class="badge badge-lg badge-neutral" id="user-count">{{ users|length }}</span>
            </h1>
        </div>

        <!-- User List -->
        <div class="space-y-4" id="admin-user-list">
            {% for user in users %}
            {% include "admin/_user_card.html" %}
            {% endfor %}
        </div>
    </div>
</div>

{% call dialogs.modal('editUserDialog', title=_('Edit profile')) %}
<p class="text-sm opacity-70 mb-6">
    {{ _('Update profile details for') }} <strong id="editUserEmailTitle" class="text-base-content"></strong>.
</p>
<form id="editUserForm" method="post" action="/admin/users/0/edit" class="space-y-4"
    data-toast-message="{{ _('Profile updated') }}" data-toast-variant="success" data-dialog-close="editUserDialog"
    hx-post="/admin/users/0/edit" hx-target="#admin-user-list" hx-swap="outerHTML">
    <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
    <div class="mb-4 w-full">
        <label class="block mb-1">
            <span class=" font-medium">{{ _('Email') }}</span>
        </label>
        <input id="edit-user-email" name="email" type="email" required autocomplete="email"
            class="input  w-full" />
    </div>

    <div class="mb-4 w-full">
        <label class="block mb-1">
            <span class=" font-medium">{{ _('Profile Image') }}</span>
        </label>
        <button type="button" class="btn btn-outline gap-2" data-call="triggerEditUserImageUpload">
            <span class="mdi mdi-camera"></span>
            {{ _('Change Photo') }}
        </button>
    </div>

    <div class="modal-action">
        {{ dialogs.dialog_cancel(_('Cancel'), attrs='data-action="close-dialog" data-dialog-id="editUserDialog"') }}
        {{ dialogs.dialog_primary(_('Save Changes'), icon='mdi-content-save', type='submit') }}
    </div>
</form>
{% endcall %}

{% call dialogs.modal('resetPasswordDialog', title=_('Reset password')) %}
<p class="text-sm opacity-70 mb-6">
    {{ _('Set a new password for') }} <strong id="resetPasswordEmail" class="text-base-content"></strong>.
</p>
<form id="resetPasswordForm" method="post" action="/admin/users/0/reset-password" class="space-y-4"
    data-toast-message="{{ _('Password reset') }}" data-toast-variant="success" data-dialog-close="resetPasswordDialog"
    hx-swap="none">
    <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
    <div class="mb-4 w-full">
        <label class="block mb-1">
            <span class=" font-medium">{{ _('New password') }}</span>
        </label>
        <input id="reset-password-input" name="password" type="password" autocomplete="new-password"
            class="input  w-full" required />
    </div>
    <div class="modal-action">
        {{ dialogs.dialog_cancel(_('Cancel'), attrs='data-action="close-dialog" data-dialog-id="resetPasswordDialog"') }}
        {{ dialogs.dialog_primary(_('Reset password'), icon='mdi-key-variant', type='submit') }}
    </div>
</form>
{% endcall %}

{% call dialogs.modal('createUserDialog', title=_('Create user')) %}
<p class="text-sm opacity-70 mb-6">{{ _('Add a new account with a temporary password.') }}</p>
<form id="createUserForm" method="post" action="/admin/users/create" class="space-y-4"
    data-toast-message="{{ _('User created') }}" data-toast-variant="success" data-dialog-close="createUserDialog"
    hx-post="/admin/users/create" hx-target="#admin-user-list" hx-swap="afterbegin">
    <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
    <div class="mb-4 w-full">
        <label class="block mb-1">
            <span class=" font-medium">{{ _('Email') }}</span>
        </label>
        <input id="create-user-email" name="email" type="email" required autocomplete="email"
            class="input  w-full" placeholder="user@example.com" />
    </div>
    <div class="mb-4 w-full">
        <label class="block mb-1">
            <span class=" font-medium">{{ _('Password') }}</span>
        </label>
        <input id="create-user-password" name="password" type="password" required autocomplete="new-password"
            class="input  w-full" />
    </div>
    <div class="mb-4">
        <label
            class="label cursor-pointer justify-start gap-4 p-4 border border-base-200 rounded-lg bg-base-100 hover:bg-base-200 transition-colors">
            <input type="checkbox" name="is_admin" class="checkbox checkbox-primary" />
            <div class="flex-1">
                <span class=" font-bold block">{{ _('Grant admin access') }}</span>
                <span class="text-xs opacity-70 block">{{ _('Allow this user to manage accounts and settings.')
                    }}</span>
            </div>
        </label>
    </div>
    <div class="modal-action">
        {{ dialogs.dialog_cancel(_('Cancel'), attrs='data-action="close-dialog" data-dialog-id="createUserDialog"') }}
        {{ dialogs.dialog_primary(_('Create User'), icon='mdi-account-plus', type='submit') }}
    </div>
</form>
{% endcall %}

{% call dialogs.modal('deleteUserDialog') %}
<h3 class="font-bold text-lg text-error flex items-center gap-2 mb-2">
    <span class="mdi mdi-alert-circle"></span>
    {{ _('Delete user') }}
</h3>
<p class="text-base-content/80 mb-6">
    {{ _('Are you sure you want to delete') }} <strong id="deleteUserEmail" class="text-base-content"></strong>?
    <br>
    <span class="text-sm opacity-70">{{ _('This will permanently remove their projects and yarn.') }}</span>
</p>
<div class="modal-action">
    {{ dialogs.dialog_cancel(_('Cancel'), attrs='data-action="close-dialog" data-dialog-id="deleteUserDialog"') }}
    <form id="deleteUserForm" method="post" action="/admin/users/0/delete" data-toast-message="{{ _('User deleted') }}"
        data-toast-variant="success" data-dialog-close="deleteUserDialog" hx-swap="outerHTML">
        <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
        {{ dialogs.dialog_danger(_('Delete Forever'), type='submit') }}
    </form>
</div>
{% endcall %}

<script>
{% include "admin/users.js" %}
</script>
{% endblock %}
