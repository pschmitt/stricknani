{% extends "shared/form_base.html" %}
{% import "macros/buttons.html" as buttons %}
{% import "macros/dialogs.html" as dialogs %}
{% import "macros/image_upload.html" as image_upload %}

{% block title %}{{ yarn.name if yarn else _('Add Yarn') }} - {{ _('Yarn') }}{% endblock %}

{% block form_container_class %}max-w-5xl{% endblock %}

{# Set variables for the unified navbar #}
{% set page_title %}{{ yarn.name if yarn else _('New Yarn') }}{% endset %}
{% set page_title_mobile_hidden = true %}
{% set back_url = '/yarn/' + yarn.id|string if yarn else '/yarn' %}
{% set back_label = _('Back to yarns') %}
{% set page_actions %}
<div class="flex items-center gap-1">
    <button type="submit" form="yarnForm" class="btn btn-primary gap-2 h-10 min-h-0 px-3 md:px-4">
        <span class="mdi mdi-content-save text-xl"></span>
        <span>{{ _('Save') }}</span>
    </button>
    {% if not yarn %}
    <div class="dropdown dropdown-end dropdown-bottom">
        <button type="button" class="btn btn-square btn-ghost btn-sm md:btn-md" aria-label="{{ _('More options') }}">
            <span class="mdi mdi-dots-vertical text-xl"></span>
        </button>
        <ul tabindex="0"
            class="dropdown-content ellipsis-dropdown-content z-[100] menu p-2 shadow-lg bg-base-100 rounded-box border border-base-200">
            <li>
                <button type="button" onclick="document.getElementById('importDialog').showModal()">
                    <span class="mdi mdi-download"></span>
                    {{ _('Import') }}
                </button>
            </li>
        </ul>
    </div>
    {% endif %}
</div>
{% endset %}

{% block form_before %}
<dialog id="previewDialog"
    class="p-0 rounded-lg shadow-xl backdrop:bg-black/50 dark:bg-slate-900 dark:text-slate-100 w-full max-w-2xl">
    <div class="flex items-center justify-between p-4 border-b border-slate-200 dark:border-slate-700">
        <h3 class="text-lg font-semibold">{{ _('Preview') }}</h3>
        <button onclick="document.getElementById('previewDialog').close()"
            class="text-slate-500 hover:text-slate-700 dark:text-slate-400 dark:hover:text-slate-200">
            <span class="mdi mdi-close text-xl"></span>
        </button>
    </div>
    <div id="previewContent" class="p-6 prose max-w-none dark:prose-invert overflow-y-auto max-h-[70vh]"></div>
</dialog>
{% endblock %}

{% block form_nav %}
{% if yarn %}
{{ buttons.back_circle('/yarn/' + yarn.id|string, label=_('Back to yarn'), attrs='data-unsaved-confirm="true"') }}
{% else %}
{{ buttons.back_circle('/yarn', label=_('Back to yarns'), attrs='data-unsaved-confirm="true"') }}
{% endif %}
{% endblock %}

{% block form_header_class %}
md:sticky md:top-0 md:z-30 md:bg-base-100/90 md:backdrop-blur md:py-3 md:shadow-lg
{% endblock %}

{% block form_actions %}
{# Save button logic:
- Always hidden on mobile (moved to FAB)
- Visible on desktop #}
{% set save_classes = 'hidden md:inline-flex flex-1 sm:flex-none md:btn-wide' %}

{{ buttons.primary(_('Save'), icon='mdi-content-save', type='submit', attrs='form="yarnForm"', class=save_classes) }}

<!-- Mobile FAB for Yarn Save -->
{{ buttons.fab('mdi-content-save', type='submit', attrs='form="yarnForm"', class='md:hidden', label=_('Save')) }}
{% endblock %}

{% block form_title %}
{{ yarn.name if yarn else _('New yarn entry') }}
{% endblock %}

{% block form_body %}
<form id="yarnForm" action="{{ '/yarn/' ~ yarn.id ~ '/edit' if yarn else '/yarn/' }}" method="post"
    enctype="multipart/form-data" data-primary-form="true" class="space-y-6">
    <input type="hidden" id="archive_on_save" name="archive_on_save" value="">
    <input type="hidden" id="is_ai_enhanced" name="is_ai_enhanced" value="{{ '1' if yarn and yarn.is_ai_enhanced else '' }}">
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 lg:gap-8">
        <!-- Main Content Column -->
        <div class="lg:col-span-2 space-y-6">
            <!-- Basic Info Card -->
            <div class="bg-base-100 rounded-2xl shadow-sm border border-base-200 p-5 sm:p-6">
                <div class="space-y-6">
                    <div>
                        <label for="name" class=" text-sm font-medium mb-1 inline-flex items-center gap-2">
                            <span class="mdi mdi-sheep text-base-content/70"></span>
                            {{ _('Name') }}
                        </label>
                        <input type="text" id="name" name="name" required
                            value="{{ yarn.name if yarn and yarn.name else '' }}" class="input  w-full">
                    </div>

                    <!-- Mobile Details Card -->
                    <div class="lg:hidden p-4 bg-base-200/30 rounded-xl border border-base-200 space-y-4">
                        <h3
                            class="font-bold text-xs uppercase tracking-widest text-base-content/40 flex items-center gap-2">
                            <span class="mdi mdi-information-outline"></span>
                            {{ _('Yarn Details') }}
                        </h3>

                        <div class="grid grid-cols-2 gap-x-4 gap-y-3">
                            <div class="col-span-2">
                                <label class=" text-xs font-bold uppercase text-base-content/50">{{ _('Brand')
                                    }}</label>
                                <input type="text" name="brand" value="{{ yarn.brand if yarn and yarn.brand else '' }}"
                                    class="input  input-sm w-full mt-1">
                            </div>

                            <div>
                                <label class=" text-xs font-bold uppercase text-base-content/50">{{
                                    _('Colorway') }}</label>
                                <input type="text" name="colorway"
                                    value="{{ yarn.colorway if yarn and yarn.colorway else '' }}"
                                    class="input  input-sm w-full mt-1">
                            </div>
                            <div>
                                <label class=" text-xs font-bold uppercase text-base-content/50">{{ _('Dye Lot') }}</label>
                                <input type="text" name="dye_lot"
                                    value="{{ yarn.dye_lot if yarn and yarn.dye_lot else '' }}"
                                    class="input  input-sm w-full mt-1">
                            </div>

                            <div class="col-span-2">
                                <label class=" text-xs font-bold uppercase text-base-content/50">{{ _('Fiber content') }}</label>
                                <input type="text" name="fiber_content"
                                    value="{{ yarn.fiber_content if yarn and yarn.fiber_content else '' }}"
                                    class="input  input-sm w-full mt-1">
                            </div>

                            <div>
                                <label class=" text-xs font-bold uppercase text-base-content/50">{{ _('Weight (g)') }}</label>
                                <input type="number" name="weight_grams" min="0"
                                    value="{{ yarn.weight_grams if yarn and yarn.weight_grams is not none else '' }}"
                                    class="input  input-sm w-full mt-1">
                            </div>
                            <div>
                                <label class=" text-xs font-bold uppercase text-base-content/50">{{ _('Length (m)') }}</label>
                                <input type="number" name="length_meters" min="0"
                                    value="{{ yarn.length_meters if yarn and yarn.length_meters is not none else '' }}"
                                    class="input  input-sm w-full mt-1">
                            </div>

                            <div class="col-span-2">
                                <label class=" text-xs font-bold uppercase text-base-content/50">{{ _('Weight category') }}</label>
                                <input type="text" name="weight_category" placeholder="{{ _('e.g. Fingering, DK...') }}"
                                    value="{{ yarn.weight_category if yarn and yarn.weight_category else '' }}"
                                    class="input  input-sm w-full mt-1">
                            </div>

                            <div class="col-span-2">
                                <label class=" text-xs font-bold uppercase text-base-content/50">{{
                                    _('Recommended Needles') }}</label>
                                <input type="text" name="recommended_needles"
                                    value="{{ yarn.recommended_needles if yarn and yarn.recommended_needles else '' }}"
                                    class="input  input-sm w-full mt-1" placeholder="4.0mm">
                            </div>

                            <div class="col-span-2">
                                <div class="flex items-center justify-between mb-1">
                                    <label class=" text-xs font-bold uppercase text-base-content/50">{{ _('Source Link') }}</label>
                                    <button type="button" id="reimport-btn-mobile"
                                        class="btn btn-ghost btn-xs gap-1 normal-case {{ 'hidden' if not yarn.link else '' }}"
                                        onclick="importFromUrl(document.getElementById('link').value)">
                                        <span class="mdi mdi-download"></span>
                                        {{ _('Re-import') }}
                                    </button>
                                </div>
                                <input type="url" name="link" value="{{ yarn.link if yarn and yarn.link else '' }}"
                                    class="input  input-sm w-full" placeholder="https://..."
                                    oninput="syncLinkInputs(this)">
                                <label id="wayback_mobile_container" class="label cursor-pointer justify-start gap-3 px-3 py-2 bg-base-200/50 rounded-xl border border-base-300 mt-2 {% if not feature_wayback_enabled %}hidden{% endif %}">
                                    <input type="checkbox" id="archive_on_save_mobile" name="archive_on_save" value="1" class="checkbox checkbox-primary checkbox-sm"
                                        checked>
                                    <span class="label-text text-xs font-bold uppercase text-base-content/50">{{ _('Archive on Wayback Machine') }}</span>
                                </label>
                            </div>

                            <div class="col-span-2 pt-2 border-t border-base-200">
                                <label id="ai_enhanced_mobile_container" class="label cursor-pointer justify-start gap-3 px-3 py-2 bg-base-200/50 rounded-xl border border-base-300">
                                    <input type="checkbox" id="is_ai_enhanced_mobile_checkbox"
                                        class="checkbox checkbox-primary checkbox-sm"
                                        {% if yarn and yarn.is_ai_enhanced %}checked{% endif %}
                                        onchange="syncAiEnhanced(this)">
                                    <span class="label-text text-xs font-bold uppercase text-base-content/50 flex items-center gap-2">
                                        <span class="badge badge-primary font-black text-[10px] h-4 min-h-0">AI</span>
                                        {{ _('AI Enhanced') }}
                                    </span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <div>
                        <div class="flex items-center justify-between mb-1">
                            <label for="description"
                                class=" text-sm font-medium inline-flex items-center gap-2">
                                <span class="mdi mdi-text-box-outline text-base-content/70"></span>
                                {{ _('Description') }} <span class="text-base-content/60 text-xs">{{ _('Optional')
                                    }}</span>
                            </label>
                        </div>
                        <textarea id="description" name="description" rows="4"
                            class="textarea  w-full">{{ yarn.description if yarn and yarn.description else '' }}</textarea>
                    </div>

                    <div class="divider my-2"></div>

                    <div>
                        <div class="flex items-center justify-between mb-1">
                            <label for="link" class=" text-xs font-bold uppercase text-base-content/50">
                                {{ _('Source Link') }}
                            </label>
                            <button type="button" id="reimport-btn-mobile"
                                class="btn btn-ghost btn-xs gap-1 normal-case {{ 'hidden' if not yarn.link else '' }}"
                                onclick="importFromUrl(document.getElementById('link').value)">
                                <span class="mdi mdi-download"></span>
                                {{ _('Re-import') }}
                            </button>
                        </div>
                        <input type="url" name="link" value="{{ yarn.link if yarn and yarn.link else '' }}"
                            class="input  input-sm w-full" placeholder="https://..."
                            oninput="syncLinkInputs(this)">
                        <label class="label cursor-pointer justify-start gap-2 mt-2">
                            <input type="checkbox" name="archive_on_save" value="1" class="checkbox checkbox-xs"
                                checked>
                            <span class=" text-xs">{{ _('Archive on Wayback Machine') }}</span>
                        </label>
                    </div>
                </div>
            </div>

            <!-- Photos Card -->
            <div class="bg-base-100 rounded-2xl shadow-sm border border-base-200 p-5 sm:p-6">
                <h3 class="text-xl font-semibold text-base-content mb-4 flex items-center gap-2">
                    <span class="mdi mdi-image-multiple text-primary"></span>
                    {{ _('Photos') }}
                </h3>

                {% if photos %}
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4 pswp-gallery" data-pswp-gallery>
                    {% for photo in photos %}
                    <div id="photo-card-{{ photo.id }}"
                        class="relative group aspect-[4/3] overflow-hidden rounded-lg border border-slate-200 bg-slate-50 dark:border-slate-700 dark:bg-slate-800">
                        <a href="{{ photo.full_url }}" data-pswp-width="{{ photo.width or 1200 }}"
                            data-pswp-height="{{ photo.height or 1200 }}" data-pswp-caption="{{ photo.alt_text }}"
                            data-pswp-promote="true" data-pswp-delete="true"
                            data-pswp-is-primary="{{ 'true' if photo.is_primary else 'false' }}"
                            class="block h-full w-full">
                            <img src="{{ photo.thumbnail_url }}" alt="{{ photo.alt_text }}"
                                class="h-full w-full object-cover cursor-zoom-in">
                        </a>
                        <button type="button" onclick="promoteYarnPhoto({{ photo.id }})"
                            class="yarn-promote-btn absolute top-2 left-2 z-10 rounded-full p-1.5 shadow-sm transition-all {{ 'bg-amber-400 text-white opacity-100' if photo.is_primary else 'bg-white/90 text-slate-400 opacity-0 group-hover:opacity-100 dark:bg-slate-900/90 dark:text-slate-500' }} hover:bg-amber-50 hover:text-amber-600 dark:hover:bg-amber-900/50 dark:hover:text-amber-400"
                            title="{{ _('Make primary photo') }}">
                            <span class="mdi {{ 'mdi-star' if photo.is_primary else 'mdi-star-outline' }}"></span>
                        </button>
                        <button type="button" onclick="deleteYarnPhoto({{ photo.id }})"
                            class="absolute top-2 right-2 z-10 bg-white/90 text-red-600 rounded-full p-1.5 hover:bg-red-50 shadow-sm transition-colors dark:bg-slate-900/90 dark:text-red-400 dark:hover:bg-red-900/50"
                            title="{{ _('Delete photo') }}">
                            <span class="mdi mdi-trash-can-outline"></span>
                        </button>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}


                {{ image_upload.upload_dropzone(
                input_id='photos',
                input_name='new_photos' if yarn else 'photos',
                onchange='previewImages(this)'
                ) }}
                <input type="hidden" id="import_primary_image_url" name="import_primary_image_url" value="">
                <div id="importWarning"></div>
                <div id="image-preview-container" class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-4 hidden pswp-gallery"
                    data-pswp-gallery></div>
                <p class="text-xs text-base-content/70 mt-1">{{ _('Supported: JPG, PNG, GIF. Thumbnails are generated automatically.') }}</p>
            </div>
        </div>

        <!-- Sidebar Column -->
        <div class="space-y-6">
            <!-- Yarn Details Card -->
            <div class="bg-base-100 rounded-2xl shadow-sm border border-base-200 p-5 hidden lg:block">
                <h3
                    class="font-bold text-base text-base-content/40 uppercase tracking-widest mb-4 flex items-center gap-2 text-xs">
                    <span class="mdi mdi-information-outline"></span>
                    {{ _('Yarn Details') }}
                </h3>

                <div class="space-y-4">
                    <div>
                        <label for="brand"
                            class=" text-xs font-bold uppercase text-base-content/50 block mb-1">
                            {{ _('Brand') }}
                        </label>
                        <input type="text" id="brand" name="brand"
                            value="{{ yarn.brand if yarn and yarn.brand else '' }}"
                            class="input  input-sm w-full">
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="colorway"
                                class=" text-xs font-bold uppercase text-base-content/50 block mb-1">
                                {{ _('Colorway') }}
                            </label>
                            <input type="text" id="colorway" name="colorway"
                                value="{{ yarn.colorway if yarn and yarn.colorway else '' }}"
                                class="input  input-sm w-full">
                        </div>
                        <div>
                            <label for="dye_lot"
                                class=" text-xs font-bold uppercase text-base-content/50 block mb-1">
                                {{ _('Dye Lot') }}
                            </label>
                            <input type="text" id="dye_lot" name="dye_lot"
                                value="{{ yarn.dye_lot if yarn and yarn.dye_lot else '' }}"
                                class="input  input-sm w-full">
                        </div>
                    </div>

                    <div class="divider my-2"></div>

                    <div>
                        <label for="fiber_content"
                            class=" text-xs font-bold uppercase text-base-content/50 block mb-1">
                            {{ _('Fiber content') }}
                        </label>
                        <input type="text" id="fiber_content" name="fiber_content"
                            placeholder="{{ _('e.g. 80% Merino...') }}"
                            value="{{ yarn.fiber_content if yarn and yarn.fiber_content else '' }}"
                            class="input  input-sm w-full">
                    </div>

                    <div>
                        <label for="weight_category"
                            class=" text-xs font-bold uppercase text-base-content/50 block mb-1">
                            {{ _('Weight category') }}
                        </label>
                        <input type="text" id="weight_category" name="weight_category"
                            placeholder="{{ _('e.g. Fingering, DK...') }}"
                            value="{{ yarn.weight_category if yarn and yarn.weight_category else '' }}"
                            class="input  input-sm w-full">
                    </div>

                    <div>
                        <label for="recommended_needles"
                            class=" text-xs font-bold uppercase text-base-content/50 block mb-1">
                            {{ _('Recommended Needles') }}
                        </label>
                        <input type="text" id="recommended_needles" name="recommended_needles"
                            value="{{ yarn.recommended_needles if yarn and yarn.recommended_needles else '' }}"
                            class="input  input-sm w-full" placeholder="4.0mm">
                    </div>

                    <div class="divider my-2"></div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="weight_grams"
                                class=" text-xs font-bold uppercase text-base-content/50 block mb-1">
                                {{ _('Weight (g)') }}
                            </label>
                            <input type="number" id="weight_grams" name="weight_grams" min="0"
                                value="{{ yarn.weight_grams if yarn and yarn.weight_grams is not none else '' }}"
                                class="input  input-sm w-full">
                        </div>
                        <div>
                            <label for="length_meters"
                                class=" text-xs font-bold uppercase text-base-content/50 block mb-1">
                                {{ _('Length (m)') }}
                            </label>
                            <input type="number" id="length_meters" name="length_meters" min="0"
                                value="{{ yarn.length_meters if yarn and yarn.length_meters is not none else '' }}"
                                class="input  input-sm w-full">
                        </div>
                    </div>

                    <div class="divider my-2"></div>

                    <div>
                        <div class="flex items-center justify-between mb-1">
                            <label for="link" class=" text-xs font-bold uppercase text-base-content/50">
                                {{ _('Source Link') }}
                            </label>
                            <button type="button" id="reimport-btn"
                                class="btn btn-ghost btn-xs gap-1 normal-case {{ 'hidden' if not yarn.link else '' }}"
                                onclick="importFromUrl(document.getElementById('link').value)">
                                <span class="mdi mdi-download"></span>
                                {{ _('Re-import') }}
                            </button>
                        </div>
                        <input type="url" id="link" name="link" value="{{ yarn.link if yarn and yarn.link else '' }}"
                            class="input  input-sm w-full" placeholder="https://..."
                            oninput="syncLinkInputs(this)">
                        <label id="wayback_sidebar_container" class="label cursor-pointer justify-start gap-3 px-3 py-2 bg-base-200/50 rounded-xl border border-base-300 mt-2 {% if not feature_wayback_enabled %}hidden{% endif %}">
                            <input type="checkbox" id="archive_on_save_sidebar" name="archive_on_save" value="1" class="checkbox checkbox-primary checkbox-sm"
                                checked>
                            <span class="label-text text-xs font-bold uppercase text-base-content/50">{{ _('Archive on Wayback Machine') }}</span>
                        </label>
                    </div>

                    <div class="pt-2 border-t border-base-200">
                        <label id="ai_enhanced_sidebar_container" class="label cursor-pointer justify-start gap-3 px-3 py-2 bg-base-200/50 rounded-xl border border-base-300">
                            <input type="checkbox" id="is_ai_enhanced_checkbox"
                                class="checkbox checkbox-primary checkbox-sm"
                                {% if yarn and yarn.is_ai_enhanced %}checked{% endif %}
                                onchange="syncAiEnhanced(this)">
                            <span class="label-text text-xs font-bold uppercase text-base-content/50 flex items-center gap-2">
                                <span class="badge badge-primary font-black text-[10px] h-4 min-h-0">AI</span>
                                {{ _('AI Enhanced') }}
                            </span>
                        </label>
                    </div>
                </div>
            </div>

            <!-- Danger Zone -->
            {% if yarn %}
            <div
                class="bg-red-50 dark:bg-red-900/10 rounded-2xl shadow-sm border border-red-100 dark:border-red-900/30 p-5">
                <h3
                    class="font-bold text-base text-red-800 dark:text-red-400 uppercase tracking-widest mb-4 flex items-center gap-2 text-xs">
                    <span class="mdi mdi-alert-outline"></span>
                    {{ _('Danger Zone') }}
                </h3>
                {{ buttons.danger(_('Delete Yarn'), icon='mdi-delete-outline',
                attrs='onclick="document.getElementById(\'deleteYarnDialog\').showModal()"', class="w-full") }}
            </div>
            {% endif %}
        </div>
    </div>
</form>

{% if yarn %}
<dialog id="deleteYarnDialog" class="modal modal-bottom sm:modal-middle">
    <div class="modal-box">
        <h3 class="font-bold text-lg text-error flex items-center gap-2">
            <span class="mdi mdi-alert-circle"></span>
            {{ _('Delete Yarn') }}
        </h3>
        <p class="py-4 text-base-content/80">{{ _('Are you sure you want to delete this yarn?') }}</p>
        <p class="text-sm text-base-content/70">{{ _('This will also delete all photos associated with this yarn. This action cannot be undone.') }}</p>
        <div class="modal-action">
            <form method="dialog">
                {{ dialogs.dialog_cancel(_('Cancel'), type='submit') }}
            </form>
            <form action="/yarn/{{ yarn.id }}/delete" method="post">
                {{ dialogs.dialog_danger(_('Delete Forever'), type='submit') }}
            </form>
        </div>
    </div>
    {{ dialogs.modal_backdrop() }}
</dialog>
{% endif %}

{% include "yarn/_import_dialog.html" %}
{% endblock %}

{% block page_scripts %}
<script>
    let initialLink = document.getElementById('link')?.value.trim() || '';
    let isImportPrompted = false;

    const yarnId = parseInt("{{ yarn.id if yarn else 0 }}");
    const isEditing = "{{ 'true' if yarn else 'false' }}" === "true";
    const deleteErrorMessage = '{{ _("Failed to delete the photo. Please try again") }}';
    const deleteNetworkErrorMessage = '{{ _("Network error while deleting photo") }}';

    function syncAiEnhanced(el) {
        const isChecked = el.checked;
        const hiddenInput = document.getElementById('is_ai_enhanced');
        const desktopCheckbox = document.getElementById('is_ai_enhanced_checkbox');
        const mobileCheckbox = document.getElementById('is_ai_enhanced_mobile_checkbox');
        
        if (hiddenInput) hiddenInput.value = isChecked ? '1' : '';
        if (desktopCheckbox && desktopCheckbox !== el) desktopCheckbox.checked = isChecked;
        if (mobileCheckbox && mobileCheckbox !== el) mobileCheckbox.checked = isChecked;
        
        window.unsavedChanges?.setDirty(true);
    }

    window.populateYarnForm = function (data) {
        if (!data) return;

        // Prevent re-prompting on save since we just imported
        isImportPrompted = true;

        const fields = {
            'name': data.name,
            'brand': data.brand,
            'colorway': data.colorway,
            'dye_lot': data.dye_lot,
            'fiber_content': data.fiber_content,
            'weight_category': data.weight_category,
            'recommended_needles': data.recommended_needles,
            'weight_grams': data.weight_grams,
            'length_meters': data.length_meters,
            'link': data.link,
            'description': data.description,
            'notes': data.notes
        };

        for (const [id, value] of Object.entries(fields)) {
            const input = document.getElementById(id) || document.getElementsByName(id)[0];
            if (input && value !== undefined && value !== null) {
                input.value = value;
                // Trigger change event for unsaved changes detection
                input.dispatchEvent(new Event('input', { bubbles: true }));
            }
        }

        // Handle images if any
        if (data.image_urls && data.image_urls.length > 0) {
            data.image_urls.forEach(url => {
                addPendingImageToGallery(url);
            });
        }

        const archiveField = document.getElementById('archive_on_save');
        if (archiveField) {
            archiveField.value = '1';
        }

        const hiddenAiInput = document.getElementById('is_ai_enhanced');
        if (hiddenAiInput) hiddenAiInput.value = '1';
        const aiCheckbox = document.getElementById('is_ai_enhanced_checkbox');
        const aiCheckboxMobile = document.getElementById('is_ai_enhanced_mobile_checkbox');
        if (aiCheckbox) aiCheckbox.checked = true;
        if (aiCheckboxMobile) aiCheckboxMobile.checked = true;

        window.unsavedChanges?.setDirty(true);
        window.showToast?.('{{ _("Data imported successfully!") }}', 'success');
    };

    function addPendingImageToGallery(url) {
        const container = document.getElementById('image-preview-container');
        container.classList.remove('hidden');

        const div = document.createElement('div');
        div.className = 'relative aspect-[4/3] overflow-hidden rounded-lg border border-slate-200 bg-slate-50 dark:border-slate-700 dark:bg-slate-800 group';
        div.setAttribute('data-pending-url', url);

        div.innerHTML = `
            <a href="${url}" data-pswp-width="1200" data-pswp-height="1200" data-pswp-promote="true" data-pswp-delete="true" data-pswp-is-primary="false" class="block h-full w-full">
                <img src="${url}" class="h-full w-full object-cover cursor-zoom-in">
            </a>
            <input type="hidden" name="import_image_urls" value="${url}">
            <button type="button" onclick="promotePendingYarnImage(this, '${url}')"
                class="promote-pending-yarn-btn absolute top-1 left-1 z-10 rounded-full p-1 shadow-sm transition-all bg-white/90 text-slate-400 opacity-0 group-hover:opacity-100 dark:bg-slate-900/90 dark:text-slate-500 hover:bg-amber-50 hover:text-amber-600 dark:hover:bg-amber-900/50 dark:hover:text-amber-400"
                title="{{ _('Make primary photo') }}">
                <span class="mdi mdi-star-outline text-sm"></span>
            </button>
            <button type="button" onclick="removePendingYarnImage(this)" class="absolute top-1 right-1 bg-red-600/90 text-white rounded-full p-1 opacity-0 group-hover:opacity-100 transition-opacity hover:bg-red-700">
                <span class="mdi mdi-close"></span>
            </button>
        `;
        container.appendChild(div);

        // If this is the first image, automatically promote it
        const currentPrimaryUrl = document.getElementById('import_primary_image_url').value;
        if (!currentPrimaryUrl) {
            promotePendingYarnImage(div.querySelector('.promote-pending-yarn-btn'), url);
        }

        window.refreshPhotoSwipeGallery?.(container);
    }

    function promotePendingYarnImage(btn, url) {
        // Update hidden field
        const input = document.getElementById('import_primary_image_url');
        if (input) input.value = url;

        // Visual update
        document.querySelectorAll('.promote-pending-yarn-btn').forEach(b => {
            b.classList.remove('bg-amber-400', 'text-white', 'opacity-100');
            b.classList.add('bg-white/90', 'text-slate-400', 'opacity-0');
            const star = b.querySelector('span');
            if (star) {
                star.classList.remove('mdi-star');
                star.classList.add('mdi-star-outline');
            }
            const anchor = b.closest('[data-pending-url]')?.querySelector('a[data-pswp-promote]');
            if (anchor) {
                anchor.setAttribute('data-pswp-is-primary', 'false');
            }
        });

        if (btn) {
            btn.classList.add('bg-amber-400', 'text-white', 'opacity-100');
            btn.classList.remove('bg-white/90', 'text-slate-400', 'opacity-0');
            const star = btn.querySelector('span');
            if (star) {
                star.classList.remove('mdi-star-outline');
                star.classList.add('mdi-star');
            }
            const anchor = btn.closest('[data-pending-url]')?.querySelector('a[data-pswp-promote]');
            if (anchor) {
                anchor.setAttribute('data-pswp-is-primary', 'true');
            }
        }
        window.unsavedChanges?.setDirty(true);
    }

    function removePendingYarnImage(button) {
        const container = button?.closest('[data-pending-url]');
        if (!container) {
            return;
        }
        const url = container.getAttribute('data-pending-url');
        const wasPrimary = document.getElementById('import_primary_image_url')?.value === url;
        container.remove();
        if (wasPrimary) {
            const remaining = Array.from(document.querySelectorAll('[data-pending-url]'))
                .map(el => el.getAttribute('data-pending-url'))
                .filter(Boolean);
            if (remaining.length > 0) {
                const nextUrl = remaining[0];
                const nextBtn = document.querySelector(`[data-pending-url="${CSS.escape(nextUrl)}"] .promote-pending-yarn-btn`);
                promotePendingYarnImage(nextBtn, nextUrl);
            } else {
                const input = document.getElementById('import_primary_image_url');
                if (input) {
                    input.value = '';
                }
            }
        }
        window.unsavedChanges?.setDirty(true);
    }

    function syncLinkInputs(el) {
        const value = el.value.trim();
        document.querySelectorAll('input[name="link"]').forEach(input => {
            if (input !== el) input.value = value;
        });
        document.getElementById('reimport-btn')?.classList.toggle('hidden', !value);
        document.getElementById('reimport-btn-mobile')?.classList.toggle('hidden', !value);

        // Enable/disable AI and Wayback checkboxes
        const waybackCheckboxes = [
            document.getElementById('archive_on_save_mobile'),
            document.getElementById('archive_on_save_sidebar')
        ];
        const aiCheckboxes = [
            document.getElementById('is_ai_enhanced_checkbox'),
            document.getElementById('is_ai_enhanced_mobile_checkbox')
        ];
        const containers = [
            document.getElementById('wayback_mobile_container'),
            document.getElementById('wayback_sidebar_container'),
            document.getElementById('ai_enhanced_mobile_container'),
            document.getElementById('ai_enhanced_sidebar_container')
        ];

        const isEnabled = value.length > 0;
        
        [...waybackCheckboxes, ...aiCheckboxes].forEach(cb => {
            if (cb) {
                const wasDisabled = cb.disabled;
                cb.disabled = !isEnabled;
                if (!isEnabled) {
                    cb.checked = false;
                    // Trigger sync for AI hidden field if it's an AI checkbox
                    if (aiCheckboxes.includes(cb)) {
                        const hiddenInput = document.getElementById('is_ai_enhanced');
                        if (hiddenInput) hiddenInput.value = '';
                    }
                } else if (wasDisabled && waybackCheckboxes.includes(cb)) {
                    // Auto-set wayback to true when it becomes enabled
                    cb.checked = true;
                }
            }
        });

        containers.forEach(container => {
            if (container) {
                if (isEnabled) {
                    container.classList.remove('opacity-50', 'grayscale', 'pointer-events-none');
                } else {
                    container.classList.add('opacity-50', 'grayscale', 'pointer-events-none');
                }
            }
        });

        // If the user manually changes the link, we might want to prompt for import again
        if (value !== initialLink) {
            isImportPrompted = false;
        }
    }

    async function importFromUrl(url) {
        if (!url) return;

        const importDialog = document.getElementById('importDialog');
        const importForm = document.getElementById('importYarnForm');
        const importLoading = document.getElementById('importLoading');

        if (!importDialog || !importForm || !importLoading) return;

        // Reset and show loading state
        importDialog.showModal();
        importForm.classList.add('hidden');
        importLoading.classList.remove('hidden');

        const formData = new FormData();
        formData.append('url', url);

        try {
            const response = await fetch('/yarn/import', {
                method: 'POST',
                body: formData
            });

            if (!response.ok) {
                throw new Error('Import failed');
            }

            const data = await response.json();
            window.populateYarnForm(data);

            importDialog.close();
        } catch (error) {
            console.error('Import failed:', error);
            window.showToast?.('{{ _("Failed to import yarn data") }}', 'error');
            importDialog.close();
        } finally {
            importForm.classList.remove('hidden');
            importLoading.classList.add('hidden');
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        const importedData = sessionStorage.getItem('importedYarnData');
        if (importedData) {
            try {
                const data = JSON.parse(importedData);
                window.populateYarnForm(data);
                sessionStorage.removeItem('importedYarnData');
            } catch (err) {
                console.error('Failed to parse imported yarn data', err);
            }
        }

        const urlParams = new URLSearchParams(window.location.search);
        // Initialize checkbox states based on link presence
        const linkEl = document.getElementById('link');
        if (linkEl) syncLinkInputs(linkEl);

        if (urlParams.get('import') === '1') {
            const currentUrl = document.getElementById('link')?.value;
            if (currentUrl) {
                importFromUrl(currentUrl);
            } else {
                document.getElementById('importDialog')?.showModal();
            }
        }
    });

    document.getElementById('yarnForm').addEventListener('submit', function (e) {
        const currentLink = document.getElementById('link')?.value.trim() || '';

        // If a link was added to a yarn that didn't have one, prompt for import
        if (!initialLink && currentLink && !isImportPrompted) {
            e.preventDefault();
            window.confirmAction(
                '{{ _("Import Data?") }}',
                '{{ _("You added a source link. Would you like to import details from this URL before saving?") }}',
                () => {
                    isImportPrompted = true;
                    importFromUrl(currentLink);
                },
                () => {
                    isImportPrompted = true;
                    this.submit();
                },
                {
                    confirmText: '{{ _("Import") }}',
                    cancelText: '{{ _("Just Save") }}'
                }
            );
            return;
        }
    });

    async function deleteYarnPhoto(photoId) {
        window.confirmAction(
            '{{ _("Delete Photo") }}',
            '{{ _("Are you sure you want to delete this photo? This action cannot be undone.") }}',
            async () => {
                let response;
                try {
                    response = await fetch(`/yarn/${yarnId}/photos/${photoId}/delete`, {
                        method: 'POST',
                        headers: {
                            'Accept': 'application/json'
                        }
                    });
                } catch (error) {
                    console.error('Photo deletion failed', error);
                    window.showToast?.(deleteNetworkErrorMessage, 'error');
                    return;
                }

                if (!response.ok) {
                    const message = await parseErrorMessage(response, deleteErrorMessage);
                    window.showToast?.(message, 'error');
                    return;
                }

                const element = document.getElementById(`photo-card-${photoId}`);
                if (element) {
                    element.remove();
                }
                window.unsavedChanges?.setDirty(true);
                window.showToast?.('{{ _("Photo deleted") }}', 'success');
            }
        );
    }

    async function promoteYarnPhoto(photoId) {
        if (!yarnId) return;

        try {
            const response = await fetch(`/yarn/${yarnId}/photos/${photoId}/promote`, {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            });

            if (response.ok) {
                // Close PhotoSwipe if open
                if (window.pswpLightboxes) {
                    for (const lb of window.pswpLightboxes.values()) {
                        if (lb.pswp) lb.pswp.close();
                    }
                }
                setPrimaryYarnPhoto(photoId);
            } else {
                console.error('Failed to promote photo');
            }
        } catch (error) {
            console.error('Error promoting photo:', error);
        }
    }

    function setPrimaryYarnPhoto(photoId) {
        document.querySelectorAll('[id^="photo-card-"]').forEach((card) => {
            const anchor = card.querySelector('a[data-pswp-promote]');
            if (anchor) {
                anchor.setAttribute('data-pswp-is-primary', 'false');
            }
            const button = card.querySelector('.yarn-promote-btn');
            if (button) {
                button.classList.remove('bg-amber-400', 'text-white', 'opacity-100');
                button.classList.add('bg-white/90', 'text-slate-400', 'opacity-0');
                const icon = button.querySelector('span');
                if (icon) {
                    icon.classList.remove('mdi-star');
                    icon.classList.add('mdi-star-outline');
                }
            }
        });

        const target = document.getElementById(`photo-card-${photoId}`);
        if (!target) {
            return;
        }
        const targetAnchor = target.querySelector('a[data-pswp-promote]');
        if (targetAnchor) {
            targetAnchor.setAttribute('data-pswp-is-primary', 'true');
        }
        const targetButton = target.querySelector('.yarn-promote-btn');
        if (targetButton) {
            targetButton.classList.add('bg-amber-400', 'text-white', 'opacity-100');
            targetButton.classList.remove('bg-white/90', 'text-slate-400', 'opacity-0');
            const icon = targetButton.querySelector('span');
            if (icon) {
                icon.classList.add('mdi-star');
                icon.classList.remove('mdi-star-outline');
            }
        }
        window.unsavedChanges?.setDirty(true);
    }

    // Add event listeners for PhotoSwipe managed actions
    document.addEventListener('pswp:promote', (e) => {
        const anchor = e.detail.element;
        const container = anchor.closest('[id^="photo-card-"]');
        if (container) {
            const photoId = container.id.replace('photo-card-', '');
            if (photoId && yarnId) {
                promoteYarnPhoto(photoId);
            }
        }
    });

    document.addEventListener('pswp:delete', (e) => {
        const anchor = e.detail.element;
        const container = anchor.closest('[id^="photo-card-"]');
        if (container) {
            const photoId = container.id.replace('photo-card-', '');
            if (photoId) {
                // Close PhotoSwipe before showing confirmation
                if (window.pswpLightboxes) {
                    for (const lb of window.pswpLightboxes.values()) {
                        if (lb.pswp) lb.pswp.close();
                    }
                }
                deleteYarnPhoto(photoId);
            }
        } else {
            // Handle pending previews
            const previewContainer = anchor.closest('[data-preview-index]');
            if (previewContainer) {
                const index = parseInt(previewContainer.dataset.previewIndex);
                if (!isNaN(index)) {
                    if (window.pswpLightboxes) {
                        for (const lb of window.pswpLightboxes.values()) {
                            if (lb.pswp) lb.pswp.close();
                        }
                    }
                    removeYarnFile(index);
                    return;
                }
            }

            // Handle pending imported images
            const pendingContainer = anchor.closest('[data-pending-url]');
            if (pendingContainer) {
                if (window.pswpLightboxes) {
                    for (const lb of window.pswpLightboxes.values()) {
                        if (lb.pswp) lb.pswp.close();
                    }
                }
                const removeButton = pendingContainer.querySelector('button[onclick^="removePendingYarnImage"]');
                if (removeButton) {
                    removePendingYarnImage(removeButton);
                } else {
                    pendingContainer.remove();
                    window.unsavedChanges?.setDirty(true);
                }
            }
        }
    });

    const parseErrorMessage =
        typeof extractErrorMessage === 'function'
            ? extractErrorMessage
            : async (_response, fallback) => fallback;

    async function previewMarkdown(source) {
        const textarea = typeof source === 'string' ? document.getElementById(source) : source;
        if (!textarea) return;

        const content = textarea.value;
        if (!content.trim()) {
            window.showToast?.('{{ _("Nothing to preview") }}', 'info');
            return;
        }

        const formData = new FormData();
        formData.append('content', content);

        try {
            const response = await fetch('/utils/preview/markdown', {
                method: 'POST',
                body: formData
            });

            if (response.ok) {
                const html = await response.text();
                const dialog = document.getElementById('previewDialog');
                const contentDiv = document.getElementById('previewContent');
                contentDiv.innerHTML = html;
                dialog.showModal();
            }
        } catch (error) {
            console.error('Preview failed', error);
        }
    }

    const yarnFiles = new DataTransfer();

    function previewImages(input) {
        const container = document.getElementById('image-preview-container');

        if (input.files && input.files.length > 0) {
            Array.from(input.files).forEach(file => {
                const exists = Array.from(yarnFiles.files).some(f =>
                    f.name === file.name && f.size === file.size && f.lastModified === file.lastModified
                );
                if (!exists) {
                    yarnFiles.items.add(file);
                }
            });
            input.files = yarnFiles.files;
        }

        container.innerHTML = '';

        if (yarnFiles.files.length > 0) {
            container.classList.remove('hidden');
            Array.from(yarnFiles.files).forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = function (e) {
                    const div = document.createElement('div');
                    div.className = 'relative aspect-[4/3] overflow-hidden rounded-lg border border-slate-200 bg-slate-50 dark:border-slate-700 dark:bg-slate-800 group';
                    div.setAttribute('data-preview-index', index);
                    div.innerHTML = `
                    <a href="${e.target.result}" data-pswp-width="1200" data-pswp-height="1200" data-pswp-delete="true" class="block h-full w-full">
                        <img src="${e.target.result}" class="h-full w-full object-cover opacity-90 transition group-hover:opacity-100 cursor-zoom-in">
                    </a>
                    <button type="button" onclick="removeYarnFile(${index})" class="absolute top-1 right-1 bg-red-600/90 text-white rounded-full p-1 opacity-100 transition-opacity hover:bg-red-700 z-20" aria-label="{{ _('Remove image') }}">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                    `;
                    container.appendChild(div);
                }
                reader.readAsDataURL(file);
            });
            window.refreshPhotoSwipeGallery?.(container);
        } else {
            container.classList.add('hidden');
        }
    }

    function removeYarnFile(index) {
        const input = document.getElementById('photos');
        const newDt = new DataTransfer();

        Array.from(yarnFiles.files).forEach((file, i) => {
            if (i !== index) {
                newDt.items.add(file);
            }
        });

        yarnFiles.items.clear();
        Array.from(newDt.files).forEach(file => yarnFiles.items.add(file));

        if (input) {
            input.files = yarnFiles.files;
            previewImages(input);
        }
        window.unsavedChanges?.setDirty(true);
    }
</script>
{% endblock %}
