{% extends "base.html" %}
{% import "macros/buttons.html" as buttons %}
{% import "macros/image_upload.html" as image_upload %}

{% block title %}{{ yarn.name if yarn else _('Add Yarn') }} - {{ _('Yarn') }}{% endblock %}

{% block content %}
<dialog id="previewDialog" class="p-0 rounded-lg shadow-xl backdrop:bg-black/50 dark:bg-slate-900 dark:text-slate-100 w-full max-w-2xl">
    <div class="flex items-center justify-between p-4 border-b border-slate-200 dark:border-slate-700">
        <h3 class="text-lg font-semibold">{{ _('Preview') }}</h3>
        <button onclick="document.getElementById('previewDialog').close()" class="text-slate-500 hover:text-slate-700 dark:text-slate-400 dark:hover:text-slate-200">
            <span class="mdi mdi-close text-xl"></span>
        </button>
    </div>
    <div id="previewContent" class="p-6 prose max-w-none dark:prose-invert overflow-y-auto max-h-[70vh]"></div>
</dialog>

<div class="max-w-3xl mx-auto space-y-6">
    <div class="flex flex-col gap-4">
        <div class="flex flex-wrap items-center justify-between gap-2">
            <div class="flex flex-wrap gap-2">
                {% if yarn %}
                {{ buttons.back(_('Back'), href='/yarn/' + yarn.id|string) }}
                {% else %}
                {{ buttons.back(_('Back'), href='/yarn') }}
                {% endif %}
            </div>

            {{ buttons.primary(_('Save'), icon='mdi-content-save', type='submit', attrs='form="yarnForm"') }}
        </div>

        <div>
            <h1 class="text-2xl font-bold text-base-content flex items-center gap-2">
                <span class="mdi mdi-sheep text-blue-700 dark:text-blue-300"></span>
                {{ yarn.name if yarn else _('New yarn entry') }}
            </h1>
        </div>
    </div>

    <form id="yarnForm" action="{{ '/yarn/' ~ yarn.id ~ '/edit' if yarn else '/yarn/' }}" method="post" enctype="multipart/form-data" class="bg-base-100 rounded-lg shadow-md border border-base-300 p-4 sm:p-6 md:p-8 backdrop-blur space-y-6">
        <div class="grid gap-4 md:grid-cols-2">
            <div class="md:col-span-2">
                <label for="name" class="label-text text-sm font-medium mb-1 inline-flex items-center gap-2">
                    <span class="mdi mdi-sheep text-base-content/70"></span>
                    {{ _('Name') }}
                </label>
                <input type="text" id="name" name="name" required value="{{ yarn.name if yarn else '' }}" class="input input-bordered w-full">
            </div>
            <div>
                <label for="brand" class="label-text text-sm font-medium mb-1 inline-flex items-center gap-2">
                    <span class="mdi mdi-factory text-base-content/70"></span>
                    {{ _('Brand') }} <span class="text-base-content/60 text-xs">{{ _('Optional') }}</span>
                </label>
                <input type="text" id="brand" name="brand" value="{{ yarn.brand if yarn and yarn.brand else '' }}" class="input input-bordered w-full">
            </div>
            <div>
                <label for="colorway" class="label-text text-sm font-medium mb-1 inline-flex items-center gap-2">
                    <span class="mdi mdi-palette-outline text-base-content/70"></span>
                    {{ _('Colorway') }} <span class="text-base-content/60 text-xs">{{ _('Optional') }}</span>
                </label>
                <input type="text" id="colorway" name="colorway" value="{{ yarn.colorway if yarn and yarn.colorway else '' }}" class="input input-bordered w-full">
            </div>
            <div>
                <label for="dye_lot" class="label-text text-sm font-medium mb-1 inline-flex items-center gap-2">
                    <span class="mdi mdi-palette-outline text-base-content/70"></span>
                    {{ _('Dye Lot') }} <span class="text-base-content/60 text-xs">{{ _('Optional') }}</span>
                </label>
                <input type="text" id="dye_lot" name="dye_lot" value="{{ yarn.dye_lot if yarn and yarn.dye_lot else '' }}" class="input input-bordered w-full">
            </div>
            <div>
                <label for="fiber_content" class="label-text text-sm font-medium mb-1 inline-flex items-center gap-2">
                    <span class="mdi mdi-leaf text-base-content/70"></span>
                    {{ _('Fiber content') }} <span class="text-base-content/60 text-xs">{{ _('Optional') }}</span>
                </label>
                <input type="text" id="fiber_content" name="fiber_content" placeholder="{{ _('e.g. 80% Merino, 20% Nylon') }}" value="{{ yarn.fiber_content if yarn and yarn.fiber_content else '' }}" class="input input-bordered w-full">
            </div>
            <div>
                <label for="weight_category" class="label-text text-sm font-medium mb-1 inline-flex items-center gap-2">
                    <span class="mdi mdi-weight text-base-content/70"></span>
                    {{ _('Weight category') }} <span class="text-base-content/60 text-xs">{{ _('Optional') }}</span>
                </label>
                <input type="text" id="weight_category" name="weight_category" placeholder="{{ _('e.g. Fingering, DK, Worsted') }}" value="{{ yarn.weight_category if yarn and yarn.weight_category else '' }}" class="input input-bordered w-full">
            </div>
            <div>
                <label for="weight_grams" class="label-text text-sm font-medium mb-1 inline-flex items-center gap-2">
                    <span class="mdi mdi-scale text-base-content/70"></span>
                    {{ _('Weight (grams)') }} <span class="text-base-content/60 text-xs">{{ _('Optional') }}</span>
                </label>
                <input type="number" id="weight_grams" name="weight_grams" min="0" value="{{ yarn.weight_grams if yarn and yarn.weight_grams is not none else '' }}" class="input input-bordered w-full">
            </div>
            <div>
                <label for="length_meters" class="label-text text-sm font-medium mb-1 inline-flex items-center gap-2">
                    <span class="mdi mdi-ruler text-base-content/70"></span>
                    {{ _('Length (meters)') }} <span class="text-base-content/60 text-xs">{{ _('Optional') }}</span>
                </label>
                <input type="number" id="length_meters" name="length_meters" min="0" value="{{ yarn.length_meters if yarn and yarn.length_meters is not none else '' }}" class="input input-bordered w-full">
            </div>
            <div class="md:col-span-2">
                <div class="flex items-center justify-between mb-1">
                    <label for="description" class="label-text text-sm font-medium inline-flex items-center gap-2">
                        <span class="mdi mdi-text-box-outline text-base-content/70"></span>
                        {{ _('Description') }} <span class="text-base-content/60 text-xs">{{ _('Optional') }}</span>
                    </label>
                    <button type="button" onclick="previewMarkdown('description')" class="btn btn-xs btn-outline btn-primary gap-1">
                        <span class="mdi mdi-eye"></span>
                        {{ _('Preview') }}
                    </button>
                </div>
                <textarea id="description" name="description" rows="3" class="input input-bordered w-full">{{ yarn.description if yarn else '' }}</textarea>
            </div>
            <div class="md:col-span-2">
                <div class="flex items-center justify-between mb-1">
                    <label for="notes" class="label-text text-sm font-medium inline-flex items-center gap-2">
                        <span class="mdi mdi-note-text-outline text-base-content/70"></span>
                        {{ _('Notes') }} <span class="text-base-content/60 text-xs">{{ _('Optional') }}</span>
                    </label>
                    <button type="button" onclick="previewMarkdown('notes')" class="btn btn-xs btn-outline btn-primary gap-1">
                        <span class="mdi mdi-eye"></span>
                        {{ _('Preview') }}
                    </button>
                </div>
                <textarea id="notes" name="notes" rows="3" class="input input-bordered w-full">{{ yarn.notes if yarn else '' }}</textarea>
            </div>
            <div class="md:col-span-2">
                <label for="link" class="label-text text-sm font-medium mb-1 inline-flex items-center gap-2">
                    <span class="mdi mdi-link-variant text-base-content/70"></span>
                    {{ _('Source Link') }} <span class="text-base-content/60 text-xs">{{ _('Optional') }}</span>
                </label>
                <input
                    type="url"
                    id="link"
                    name="link"
                    value="{{ yarn.link if yarn else '' }}"
                    class="input input-bordered w-full"
                    placeholder="https://example.com/yarn-details"
                >
                <p class="text-xs text-base-content/70 mt-1">{{ _('Optional link to the yarn product page or details') }}</p>
            </div>
            <div class="md:col-span-2">
                <label for="photos" class="label-text text-sm font-medium mb-1 inline-flex items-center gap-2">
                    <span class="mdi mdi-image-multiple-outline text-base-content/70"></span>
                    {{ _('Photos') }} <span class="text-base-content/60 text-xs">{{ _('Optional, you can add multiple') }}</span>
                </label>

                {% if photos %}
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                    {% for photo in photos %}
                    <div class="relative group aspect-[4/3] overflow-hidden rounded-lg border border-slate-200 bg-slate-50 dark:border-slate-700 dark:bg-slate-800">
                        <img
                            src="{{ photo.thumbnail_url }}"
                            alt="{{ photo.alt_text }}"
                            class="h-full w-full object-cover cursor-zoom-in"
                            data-lightbox-group="yarn-{{ yarn.id }}"
                            data-lightbox-src="{{ photo.full_url }}"
                            data-lightbox-alt="{{ photo.alt_text }}"
                        >
                        <button type="submit" form="delete-photo-{{ photo.id }}" class="absolute top-2 right-2 bg-white/90 text-red-600 rounded-full p-1.5 hover:bg-red-50 shadow-sm transition-colors dark:bg-slate-900/90 dark:text-red-400 dark:hover:bg-red-900/50" title="{{ _('Delete photo') }}">
                            <span class="mdi mdi-trash-can-outline"></span>
                        </button>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}

                {{ image_upload.upload_dropzone(
                    input_id='photos',
                    input_name='new_photos' if yarn else 'photos',
                    onchange='previewImages(this)'
                ) }}
                <div id="image-preview-container" class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-4 hidden"></div>
                <p class="text-xs text-base-content/70 mt-1">{{ _('Supported: JPG, PNG, GIF. Thumbnails are generated automatically.') }}</p>
            </div>
        </div>
        <div class="flex flex-col gap-4">
            <div class="flex gap-4">
                {{ buttons.primary(_('Save'), type='submit', icon='mdi-content-save', class='flex-1 py-3 px-6') }}
                {{ buttons.secondary(_('Cancel'), href='/yarn/' + yarn.id|string if yarn else '/yarn', icon='mdi-close-circle-outline', class='py-3 px-6') }}
            </div>

            {% if yarn %}
            <div class="flex justify-end pt-4 border-t border-base-200">
                {{ buttons.danger(_('Delete Yarn'), icon='mdi-delete-outline', attrs='onclick="document.getElementById(\'deleteYarnDialog\').showModal()"', class="w-full sm:w-auto") }}
            </div>
            {% endif %}
        </div>
    </form>
</div>

<!-- Delete Dialog -->
{% if yarn %}
<dialog id="deleteYarnDialog" class="rounded-lg shadow-xl border border-base-300 bg-base-100 p-6 backdrop:bg-black/50">
    <div class="max-w-md space-y-4">
        <h3 class="text-lg font-bold text-red-600 flex items-center gap-2">
            <span class="mdi mdi-alert-circle"></span>
            {{ _('Delete Yarn') }}
        </h3>
        <p>{{ _('Are you sure you want to delete this yarn?') }}</p>
        <p class="text-sm text-base-content/70">{{ _('This will also delete all photos associated with this yarn. This action cannot be undone.') }}</p>
        <div class="modal-action flex gap-2 mt-6">
            <form method="dialog">
                {{ buttons.secondary(_('Cancel')) }}
            </form>
            <form action="/yarn/{{ yarn.id }}/delete" method="post">
                {{ buttons.danger(_('Delete Forever'), type='submit', icon='mdi-delete-forever') }}
            </form>
        </div>
    </div>
</dialog>
{% endif %}

{% if photos %}
    {% for photo in photos %}
    <form id="delete-photo-{{ photo.id }}" action="/yarn/{{ yarn.id }}/photos/{{ photo.id }}/delete" method="post" onsubmit="return confirm('{{ _('Delete photo?') }}');"></form>
    {% endfor %}
{% endif %}

<script>
async function previewMarkdown(source) {
    const textarea = typeof source === 'string' ? document.getElementById(source) : source;
    if (!textarea) return;

    const content = textarea.value;
    if (!content.trim()) {
        window.showToast?.('{{ _("Nothing to preview") }}', 'info');
        return;
    }

    const formData = new FormData();
    formData.append('content', content);

    try {
        const response = await fetch('/utils/preview/markdown', {
            method: 'POST',
            body: formData
        });

        if (response.ok) {
            const html = await response.text();
            const dialog = document.getElementById('previewDialog');
            const contentDiv = document.getElementById('previewContent');
            contentDiv.innerHTML = html;
            dialog.showModal();
        }
    } catch (error) {
        console.error('Preview failed', error);
    }
}

function previewImages(input) {
    const container = document.getElementById('image-preview-container');
    container.innerHTML = '';

    if (input.files && input.files.length > 0) {
        container.classList.remove('hidden');
        Array.from(input.files).forEach(file => {
            const reader = new FileReader();
            reader.onload = function(e) {
                const div = document.createElement('div');
                div.className = 'relative aspect-[4/3] overflow-hidden rounded-lg border border-slate-200 bg-slate-50 dark:border-slate-700 dark:bg-slate-800';
                div.innerHTML = `<img src="${e.target.result}" class="h-full w-full object-cover opacity-75">`;
                container.appendChild(div);
            }
            reader.readAsDataURL(file);
        });
    } else {
        container.classList.add('hidden');
    }
}
</script>

{% endblock %}
