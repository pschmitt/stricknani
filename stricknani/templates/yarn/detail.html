{% extends "shared/detail_base.html" %}
{% import "macros/buttons.html" as buttons %}
{% import "macros/detail_layout.html" as detail %}
{% import "macros/cards.html" as cards %}

{% block title %}{{ yarn.name }} - {{ _('Yarn') }}{% endblock %}

{% block detail_header %}
    {% call detail.header(_('Back to Yarn Stash'), '/yarn') %}
        <div data-favorite-toggle>
            {% with yarn_id=yarn.id, is_favorite=is_favorite, variant='detail' %}
                {% include "yarn/_favorite_toggle.html" %}
            {% endwith %}
        </div>
        {{ buttons.primary(_('Edit'), icon='mdi-pencil', href='/yarn/' + yarn.id|string + '/edit') }}
        {{ buttons.danger(_('Delete'), icon='mdi-delete', attrs='onclick="openDialog(\'deleteYarnDialog\')"') }}
    {% endcall %}
{% endblock %}

{% block detail_body %}
    <div class="mb-4">
        <h2 class="text-3xl font-bold text-base-content mb-2">{{ yarn.name }}</h2>
        {% if yarn.brand %}
        <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-blue-100 text-blue-800 dark:bg-blue-400/20 dark:text-blue-300">
            {{ yarn.brand }}
        </span>
        {% endif %}
    </div>

    <div class="flex flex-col sm:flex-row sm:flex-wrap gap-2 text-xs mb-6">
        <span class="inline-flex items-center gap-1 badge badge-neutral whitespace-nowrap text-xs">
            <span class="mdi mdi-calendar-plus"></span>
            {{ _('Added') }} {{ metadata.created }}
        </span>
        <span class="inline-flex items-center gap-1 badge badge-neutral whitespace-nowrap text-xs">
            <span class="mdi mdi-update"></span>
            {{ _('Updated') }} {{ metadata.updated }}
        </span>
        <span class="inline-flex items-center gap-1 rounded-full bg-emerald-50 px-3 py-1 font-semibold text-emerald-700 dark:bg-emerald-900/40 dark:text-emerald-200">
            <span class="mdi mdi-folder-multiple-outline"></span>
            {{ metadata.project_count }} {{ _('projects linked') }}
        </span>
    </div>

    {% if photos %}
    {% call detail.media_section(_('Photos'), icon='mdi-image-multiple') %}
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            {% for photo in photos %}
            <div class="relative group flex aspect-[4/3] items-center justify-center overflow-hidden rounded-lg bg-slate-100 dark:bg-slate-800">
                <img
                    src="{{ photo.thumbnail_url }}"
                    alt="{{ photo.alt_text or yarn.name }}"
                    class="h-full w-full cursor-zoom-in object-contain object-center p-2 shadow-md dark:shadow-slate-900/30 block"
                    data-lightbox-group="yarn-{{ yarn.id }}"
                    data-lightbox-src="{{ photo.full_url }}"
                    data-lightbox-alt="{{ photo.alt_text or yarn.name }}"
                >
                <form action="/yarn/{{ yarn.id }}/photos/{{ photo.id }}/delete" method="post" class="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity">
                    <button type="submit" class="bg-white/90 text-red-600 rounded-full p-1.5 hover:bg-red-50 shadow-sm transition-colors dark:bg-slate-900/90 dark:text-red-400 dark:hover:bg-red-900/50" title="{{ _('Delete photo') }}">
                        <span class="mdi mdi-trash-can-outline"></span>
                    </button>
                </form>
            </div>
            {% endfor %}
        </div>
    {% endcall %}
    {% else %}
    {% call detail.media_section(_('Photos'), icon='mdi-image-multiple') %}
        <div class="rounded-lg border border-dashed border-base-300 p-6 text-center text-sm text-base-content/70">
            <p class="mb-3">{{ _('No photos yet. Add a skein or swatch photo to recognize this yarn quickly.') }}</p>
        </div>
    {% endcall %}
    {% endif %}

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div class="space-y-6">
            {% call detail.detail_box(_('Details')) %}
                <dl class="grid grid-cols-1 gap-x-4 gap-y-4 sm:grid-cols-2">
                        {% if yarn.colorway %}
                        <div class="sm:col-span-1">
                            <dt class="text-xs font-medium text-base-content/60">{{ _('Colorway') }}</dt>
                            <dd class="mt-1 text-sm text-base-content">{{ yarn.colorway }}</dd>
                        </div>
                        {% endif %}
                        {% if yarn.dye_lot %}
                        <div class="sm:col-span-1">
                            <dt class="text-xs font-medium text-base-content/60">{{ _('Dye Lot') }}</dt>
                            <dd class="mt-1 text-sm text-base-content">{{ yarn.dye_lot }}</dd>
                        </div>
                        {% endif %}
                        {% if yarn.fiber_content %}
                        <div class="sm:col-span-1">
                            <dt class="text-xs font-medium text-base-content/60">{{ _('Fiber') }}</dt>
                            <dd class="mt-1 text-sm text-base-content">{{ yarn.fiber_content }}</dd>
                        </div>
                        {% endif %}
                        {% if yarn.weight_category %}
                        <div class="sm:col-span-1">
                            <dt class="text-xs font-medium text-base-content/60">{{ _('Weight') }}</dt>
                            <dd class="mt-1 text-sm text-base-content">{{ yarn.weight_category }}</dd>
                        </div>
                        {% endif %}
                        {% if yarn.recommended_needles %}
                        <div class="sm:col-span-1">
                            <dt class="text-xs font-medium text-base-content/60">{{ _('Recommended needle size') }}</dt>
                            <dd class="mt-1 text-sm text-base-content">{{ yarn.recommended_needles }}</dd>
                        </div>
                        {% endif %}
                        {% if yarn.weight_grams %}
                        <div class="sm:col-span-1">
                            <dt class="text-xs font-medium text-base-content/60">{{ _('Grams') }}</dt>
                            <dd class="mt-1 text-sm text-base-content">{{ yarn.weight_grams }}</dd>
                        </div>
                        {% endif %}
                        {% if yarn.length_meters %}
                        <div class="sm:col-span-1">
                            <dt class="text-xs font-medium text-base-content/60">{{ _('Length') }}</dt>
                            <dd class="mt-1 text-sm text-base-content">{{ yarn.length_meters }} m</dd>
                        </div>
                        {% endif %}
                        {% if yarn.link %}
                        <div class="sm:col-span-2">
                            <dt class="text-xs font-medium text-base-content/60">{{ _('Source Link') }}</dt>
                            <dd class="mt-1 text-sm text-base-content">
                                <a href="{{ yarn.link }}" class="link link-primary break-all" target="_blank" rel="noreferrer">
                                    {{ yarn.link }}
                                </a>
                            </dd>
                        </div>
                        {% endif %}
                </dl>
            {% endcall %}

            <div>
                <h3 class="text-sm font-medium text-base-content/70 uppercase tracking-wide mb-2">{{ _('Linked projects') }}</h3>
                {% if linked_projects %}
                <div class="flex flex-wrap gap-2">
                    {% for project in linked_projects %}
                    {{ cards.project_pill(project) }}
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-base-content/70 text-sm">{{ _('No projects linked yet.') }}</p>
                {% endif %}
            </div>
        </div>

        <div class="space-y-6">
            {% if yarn.description %}
            <div>
                <h3 class="text-sm font-medium text-base-content/70 uppercase tracking-wide mb-2">{{ _('Description') }}</h3>
                <div class="prose max-w-none">
                    {% if description_html %}
                        {{ description_html | safe }}
                    {% else %}
                        {{ yarn.description }}
                    {% endif %}
                </div>
            </div>
            {% endif %}

            {% if yarn.notes %}
            <div>
                <h3 class="text-sm font-medium text-base-content/70 uppercase tracking-wide mb-2">{{ _('Notes') }}</h3>
                <div class="prose max-w-none bg-base-200 p-4 rounded-md">
                    {% if notes_html %}
                        {{ notes_html | safe }}
                    {% else %}
                        {{ yarn.notes }}
                    {% endif %}
                </div>
            </div>
            {% endif %}
        </div>
    </div>
{% endblock %}

{% block detail_extra %}
<dialog id="deleteYarnDialog" class="rounded-lg shadow-xl border border-base-300 bg-base-100 p-6 backdrop:bg-black/50">
    <h3 class="text-lg font-bold text-base-content mb-4">{{ _('Delete Yarn') }}</h3>
    <p class="text-base-content/80 mb-6">
        {{ _('Are you sure you want to delete this yarn?') }}
        <br>
        <span class="text-sm text-base-content/70">{{ _('This will remove its photos too.') }}</span>
        <br>
        <strong class="text-base-content">{{ yarn.name }}</strong>
    </p>
    <div class="flex justify-end gap-3">
        {{ buttons.secondary(_('Cancel'), attrs='onclick="closeDialog(\'deleteYarnDialog\')"') }}
        <form action="/yarn/{{ yarn.id }}/delete" method="post">
            {{ buttons.danger(_('Delete'), type='submit') }}
        </form>
    </div>
</dialog>
{% endblock %}
